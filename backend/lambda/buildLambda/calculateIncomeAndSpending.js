"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateIncomeAndSpending = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Encryption_1 = require("./queries/Encryption");
const Item_1 = require("./mappers/Item");
const Transactions_1 = require("./mappers/Transactions");
const Summaries_1 = require("./queries/Summaries");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
function aggregateSpendingByCategory(transactions) {
    const MS_IN_A_DAY = 1000 * 60 * 60 * 24;
    // Initialize accumulators
    const dailySpendingMap = {};
    const weeklySpending = {};
    const monthlySpending = {};
    // Step 1: Sum amounts per category by day
    for (const transaction of transactions) {
        if (transaction.amount && transaction.date) {
            const amount = parseFloat(transaction.amount);
            const date = new Date(transaction.date);
            const dateKey = date.toISOString().split('T')[0]; // Format date as YYYY-MM-DD
            // Only consider transactions that are spending, not income or transfers
            const category = (transaction.personal_finance_category?.primary).S ?? '';
            if (category) {
                // Initialize daily spending map for the date if not present
                if (!dailySpendingMap[dateKey]) {
                    dailySpendingMap[dateKey] = {};
                }
                // Aggregate amounts for each category in daily, weekly, and monthly maps
                dailySpendingMap[dateKey][category] = (dailySpendingMap[dateKey][category] || 0) + Math.abs(amount);
                weeklySpending[category] = (weeklySpending[category] || 0) + Math.abs(amount);
                monthlySpending[category] = (monthlySpending[category] || 0) + Math.abs(amount);
            }
        }
    }
    // Convert daily spending map to an array of DailySpendingSummary
    const dailySpendingSummaries = Object.entries(dailySpendingMap).map(([date, spending]) => ({
        date,
        spending,
    }));
    // Step 2: Calculate date range for averages
    const transactionDates = Object.keys(dailySpendingMap).map((date) => new Date(date));
    if (transactionDates.length === 0) {
        throw new Error('No valid transactions found to aggregate.');
    }
    const minDate = new Date(Math.min(...transactionDates.map((date) => date.getTime())));
    const maxDate = new Date(Math.max(...transactionDates.map((date) => date.getTime())));
    const durationInDays = (maxDate.getTime() - minDate.getTime()) / MS_IN_A_DAY;
    // Step 3: Calculate weekly and monthly averages
    for (const category of Object.keys(weeklySpending)) {
        if (weeklySpending[category])
            weeklySpending[category] /= durationInDays / 7;
        if (monthlySpending[category])
            monthlySpending[category] /= durationInDays / 30;
    }
    return {
        daily_spending: dailySpendingSummaries,
        weekly_spending: weeklySpending,
        monthly_spending: monthlySpending,
    };
}
function groupTransactionsByMonth(transactions) {
    const monthlyAggregates = {};
    const transactionsByMonth = transactions.reduce((acc, transaction) => {
        if (transaction.date) {
            const date = new Date(transaction.date);
            const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
            if (!acc[monthYear]) {
                acc[monthYear] = [];
            }
            acc[monthYear].push(transaction);
        }
        return acc;
    }, {});
    for (const [monthYear, monthTransactions] of Object.entries(transactionsByMonth)) {
        monthlyAggregates[monthYear] = aggregateSpendingByCategory(monthTransactions);
    }
    return monthlyAggregates;
}
function getEarliestFirstOfMonthWithin90Days(createdAt) {
    return new Date(new Date().getTime() - 1000 * 3600 * 24 * 365);
}
const calculateIncomeAndSpending = async () => {
    // TODO: Add logic to handle last calculated complete month and start from then
    const items = (await (0, Encryption_1.decryptItemsInBatches)((await client.send((0, Entities_1.GetItems)()))?.Items ?? [])).map(Item_1.mapDdbResponseToItem);
    /** TODO: Just add created at to the item? */
    const encryptedUserItemRecord = await Promise.all(items.map(async (el) => await client.send((0, Entities_1.GetUser)(el.sk || ''))));
    const decryptedUserItemRecord = (await (0, Encryption_1.decryptItemsInBatches)(encryptedUserItemRecord.flatMap((output) => output.Items ?? [])))
        .map(Item_1.mapDdbResponseToItem)
        .filter((item) => {
        console.info('Processing', item);
        return item.pk && item.created_at;
    });
    /** Go through users and aggregate transactions */
    await processUsersInBatches(decryptedUserItemRecord);
};
exports.calculateIncomeAndSpending = calculateIncomeAndSpending;
function chunkArray(array, chunkSize) {
    const chunks = [];
    for (let i = 0; i < array.length; i += chunkSize) {
        chunks.push(array.slice(i, i + chunkSize));
    }
    return chunks;
}
async function processUsersInBatches(decryptedUserItemRecord) {
    const userBatches = chunkArray(decryptedUserItemRecord, 100);
    const now = new Date(); // Get the current date and time
    for (const batch of userBatches) {
        await Promise.all(batch.map(async (item) => {
            const startDay = getEarliestFirstOfMonthWithin90Days(new Date(item?.created_at ?? 0));
            console.info(startDay);
            const encryptedTransactions = await client.send((0, Entities_1.GetEntities)({
                pk: item.pk ?? '',
                dateRange: {
                    startDay: {
                        day: startDay.getDate() + 1,
                        month: startDay.getMonth() + 1,
                        year: startDay.getFullYear(),
                    },
                    endDay: {
                        day: now.getDate() + 1,
                        month: now.getMonth() + 1,
                        year: now.getFullYear(),
                    },
                    hasNoTimeConstraint: false,
                },
                username: '',
                id: '',
                entityName: 'TRANSACTION',
            }));
            const decryptedTransactions = (await (0, Encryption_1.decryptItemsInBatches)(encryptedTransactions.Items ?? [])).map(Transactions_1.mapDynamoDBToTransaction);
            console.info(decryptedTransactions);
            const aggregates = groupTransactionsByMonth(decryptedTransactions);
            await (0, Summaries_1.uploadSpendingSummaries)(item.pk ?? '', Object.entries(aggregates).flatMap((el) => el[1].daily_spending), aggregates);
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsY3VsYXRlSW5jb21lQW5kU3BlbmRpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2FsY3VsYXRlSW5jb21lQW5kU3BlbmRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQXlEO0FBQ3pELGlEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQseUNBQXFEO0FBRXJELHlEQUFpRTtBQUNqRSxtREFBNkQ7QUFHN0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUE7QUFpQjdELFNBQVMsMkJBQTJCLENBQUMsWUFBMkI7SUFDNUQsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFBO0lBRXZDLDBCQUEwQjtJQUMxQixNQUFNLGdCQUFnQixHQUFnRixFQUFFLENBQUE7SUFDeEcsTUFBTSxjQUFjLEdBQUcsRUFBNkQsQ0FBQTtJQUNwRixNQUFNLGVBQWUsR0FBRyxFQUE2RCxDQUFBO0lBRXJGLDBDQUEwQztJQUMxQyxLQUFLLE1BQU0sV0FBVyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3JDLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDekMsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUM3QyxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDLDRCQUE0QjtZQUU3RSx3RUFBd0U7WUFDeEUsTUFBTSxRQUFRLEdBQ1YsQ0FBQyxXQUFXLENBQUMseUJBQXlCLEVBQUUsT0FBZSxDQUFBLENBQUMsQ0FB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Q0FBQzt3QkFDekIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxXQUFXLEVBQUU7cUJBQzFCO29CQUNELG1CQUFtQixFQUFFLEtBQUs7aUJBQzdCO2dCQUNELFFBQVEsRUFBRSxFQUFFO2dCQUNaLEVBQUUsRUFBRSxFQUFFO2dCQUNOLFVBQVUsRUFBRSxhQUFhO2FBQzVCLENBQUMsQ0FDTCxDQUFBO1lBRUQsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLE1BQU0sSUFBQSxrQ0FBcUIsRUFBQyxxQkFBcUIsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQzlGLHVDQUF3QixDQUMzQixDQUFBO1lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO1lBQ25DLE1BQU0sVUFBVSxHQUFHLHdCQUF3QixDQUFDLHFCQUFxQixDQUFDLENBQUE7WUFFbEUsTUFBTSxJQUFBLG1DQUF1QixFQUN6QixJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFDYixNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxFQUNoRSxVQUFVLENBQ2IsQ0FBQTtRQUNMLENBQUMsQ0FBQyxDQUNMLENBQUE7SUFDTCxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgR2V0RW50aXRpZXMsIEdldEl0ZW1zLCBHZXRVc2VyIH0gZnJvbSAnLi9xdWVyaWVzL0VudGl0aWVzJ1xuaW1wb3J0IHsgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzIH0gZnJvbSAnLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5pbXBvcnQgeyBtYXBEZGJSZXNwb25zZVRvSXRlbSB9IGZyb20gJy4vbWFwcGVycy9JdGVtJ1xuaW1wb3J0IHsgSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeSwgSXRlbSwgVHJhbnNhY3Rpb24gfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5pbXBvcnQgeyB1cGxvYWRTcGVuZGluZ1N1bW1hcmllcyB9IGZyb20gJy4vcXVlcmllcy9TdW1tYXJpZXMnXG5pbXBvcnQgeyBhbnkgfSBmcm9tICd6b2QnXG5cbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuZXhwb3J0IHR5cGUgRGFpbHlTcGVuZGluZ1N1bW1hcnkgPSB7XG4gICAgZGF0ZTogc3RyaW5nXG4gICAgc3BlbmRpbmc6IHsgW2NhdGVnb3J5IGluIEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnldPzogbnVtYmVyIH1cbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRlZFNwZW5kaW5nID0ge1xuICAgIGRhaWx5X3NwZW5kaW5nOiBEYWlseVNwZW5kaW5nU3VtbWFyeVtdXG4gICAgd2Vla2x5X3NwZW5kaW5nOiB7IFtjYXRlZ29yeSBpbiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XT86IG51bWJlciB9XG4gICAgbW9udGhseV9zcGVuZGluZzogeyBbY2F0ZWdvcnkgaW4gSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeV0/OiBudW1iZXIgfVxufVxuXG50eXBlIE1vbnRobHlTcGVuZGluZ0FnZ3JlZ2F0ZXMgPSB7XG4gICAgW21vbnRoWWVhcjogc3RyaW5nXTogQWdncmVnYXRlZFNwZW5kaW5nXG59XG5cbmZ1bmN0aW9uIGFnZ3JlZ2F0ZVNwZW5kaW5nQnlDYXRlZ29yeSh0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9uW10pOiBBZ2dyZWdhdGVkU3BlbmRpbmcge1xuICAgIGNvbnN0IE1TX0lOX0FfREFZID0gMTAwMCAqIDYwICogNjAgKiAyNFxuXG4gICAgLy8gSW5pdGlhbGl6ZSBhY2N1bXVsYXRvcnNcbiAgICBjb25zdCBkYWlseVNwZW5kaW5nTWFwOiB7IFtkYXRlOiBzdHJpbmddOiB7IFtjYXRlZ29yeSBpbiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XT86IG51bWJlciB9IH0gPSB7fVxuICAgIGNvbnN0IHdlZWtseVNwZW5kaW5nID0ge30gYXMgeyBbY2F0ZWdvcnkgaW4gSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeV0/OiBudW1iZXIgfVxuICAgIGNvbnN0IG1vbnRobHlTcGVuZGluZyA9IHt9IGFzIHsgW2NhdGVnb3J5IGluIEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnldPzogbnVtYmVyIH1cblxuICAgIC8vIFN0ZXAgMTogU3VtIGFtb3VudHMgcGVyIGNhdGVnb3J5IGJ5IGRheVxuICAgIGZvciAoY29uc3QgdHJhbnNhY3Rpb24gb2YgdHJhbnNhY3Rpb25zKSB7XG4gICAgICAgIGlmICh0cmFuc2FjdGlvbi5hbW91bnQgJiYgdHJhbnNhY3Rpb24uZGF0ZSkge1xuICAgICAgICAgICAgY29uc3QgYW1vdW50ID0gcGFyc2VGbG9hdCh0cmFuc2FjdGlvbi5hbW91bnQpXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodHJhbnNhY3Rpb24uZGF0ZSlcbiAgICAgICAgICAgIGNvbnN0IGRhdGVLZXkgPSBkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSAvLyBGb3JtYXQgZGF0ZSBhcyBZWVlZLU1NLUREXG5cbiAgICAgICAgICAgIC8vIE9ubHkgY29uc2lkZXIgdHJhbnNhY3Rpb25zIHRoYXQgYXJlIHNwZW5kaW5nLCBub3QgaW5jb21lIG9yIHRyYW5zZmVyc1xuICAgICAgICAgICAgY29uc3QgY2F0ZWdvcnk6IEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnkgPVxuICAgICAgICAgICAgICAgICh0cmFuc2FjdGlvbi5wZXJzb25hbF9maW5hbmNlX2NhdGVnb3J5Py5wcmltYXJ5IGFzIGFueSkuUyA/PyAnJ1xuICAgICAgICAgICAgaWYgKGNhdGVnb3J5KSB7XG4gICAgICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBkYWlseSBzcGVuZGluZyBtYXAgZm9yIHRoZSBkYXRlIGlmIG5vdCBwcmVzZW50XG4gICAgICAgICAgICAgICAgaWYgKCFkYWlseVNwZW5kaW5nTWFwW2RhdGVLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhaWx5U3BlbmRpbmdNYXBbZGF0ZUtleV0gPSB7fVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIEFnZ3JlZ2F0ZSBhbW91bnRzIGZvciBlYWNoIGNhdGVnb3J5IGluIGRhaWx5LCB3ZWVrbHksIGFuZCBtb250aGx5IG1hcHNcbiAgICAgICAgICAgICAgICBkYWlseVNwZW5kaW5nTWFwW2RhdGVLZXldW2NhdGVnb3J5XSA9IChkYWlseVNwZW5kaW5nTWFwW2RhdGVLZXldW2NhdGVnb3J5XSB8fCAwKSArIE1hdGguYWJzKGFtb3VudClcbiAgICAgICAgICAgICAgICB3ZWVrbHlTcGVuZGluZ1tjYXRlZ29yeV0gPSAod2Vla2x5U3BlbmRpbmdbY2F0ZWdvcnldIHx8IDApICsgTWF0aC5hYnMoYW1vdW50KVxuICAgICAgICAgICAgICAgIG1vbnRobHlTcGVuZGluZ1tjYXRlZ29yeV0gPSAobW9udGhseVNwZW5kaW5nW2NhdGVnb3J5XSB8fCAwKSArIE1hdGguYWJzKGFtb3VudClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbnZlcnQgZGFpbHkgc3BlbmRpbmcgbWFwIHRvIGFuIGFycmF5IG9mIERhaWx5U3BlbmRpbmdTdW1tYXJ5XG4gICAgY29uc3QgZGFpbHlTcGVuZGluZ1N1bW1hcmllczogRGFpbHlTcGVuZGluZ1N1bW1hcnlbXSA9IE9iamVjdC5lbnRyaWVzKGRhaWx5U3BlbmRpbmdNYXApLm1hcCgoW2RhdGUsIHNwZW5kaW5nXSkgPT4gKHtcbiAgICAgICAgZGF0ZSxcbiAgICAgICAgc3BlbmRpbmcsXG4gICAgfSkpXG5cbiAgICAvLyBTdGVwIDI6IENhbGN1bGF0ZSBkYXRlIHJhbmdlIGZvciBhdmVyYWdlc1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uRGF0ZXMgPSBPYmplY3Qua2V5cyhkYWlseVNwZW5kaW5nTWFwKS5tYXAoKGRhdGUpID0+IG5ldyBEYXRlKGRhdGUpKVxuICAgIGlmICh0cmFuc2FjdGlvbkRhdGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIHRyYW5zYWN0aW9ucyBmb3VuZCB0byBhZ2dyZWdhdGUuJylcbiAgICB9XG5cbiAgICBjb25zdCBtaW5EYXRlID0gbmV3IERhdGUoTWF0aC5taW4oLi4udHJhbnNhY3Rpb25EYXRlcy5tYXAoKGRhdGUpID0+IGRhdGUuZ2V0VGltZSgpKSkpXG4gICAgY29uc3QgbWF4RGF0ZSA9IG5ldyBEYXRlKE1hdGgubWF4KC4uLnRyYW5zYWN0aW9uRGF0ZXMubWFwKChkYXRlKSA9PiBkYXRlLmdldFRpbWUoKSkpKVxuICAgIGNvbnN0IGR1cmF0aW9uSW5EYXlzID0gKG1heERhdGUuZ2V0VGltZSgpIC0gbWluRGF0ZS5nZXRUaW1lKCkpIC8gTVNfSU5fQV9EQVlcblxuICAgIC8vIFN0ZXAgMzogQ2FsY3VsYXRlIHdlZWtseSBhbmQgbW9udGhseSBhdmVyYWdlc1xuICAgIGZvciAoY29uc3QgY2F0ZWdvcnkgb2YgT2JqZWN0LmtleXMod2Vla2x5U3BlbmRpbmcpIGFzIEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnlbXSkge1xuICAgICAgICBpZiAod2Vla2x5U3BlbmRpbmdbY2F0ZWdvcnldKSB3ZWVrbHlTcGVuZGluZ1tjYXRlZ29yeV0hIC89IGR1cmF0aW9uSW5EYXlzIC8gN1xuICAgICAgICBpZiAobW9udGhseVNwZW5kaW5nW2NhdGVnb3J5XSkgbW9udGhseVNwZW5kaW5nW2NhdGVnb3J5XSEgLz0gZHVyYXRpb25JbkRheXMgLyAzMFxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGRhaWx5X3NwZW5kaW5nOiBkYWlseVNwZW5kaW5nU3VtbWFyaWVzLFxuICAgICAgICB3ZWVrbHlfc3BlbmRpbmc6IHdlZWtseVNwZW5kaW5nLFxuICAgICAgICBtb250aGx5X3NwZW5kaW5nOiBtb250aGx5U3BlbmRpbmcsXG4gICAgfVxufVxuXG5mdW5jdGlvbiBncm91cFRyYW5zYWN0aW9uc0J5TW9udGgodHJhbnNhY3Rpb25zOiBUcmFuc2FjdGlvbltdKTogTW9udGhseVNwZW5kaW5nQWdncmVnYXRlcyB7XG4gICAgY29uc3QgbW9udGhseUFnZ3JlZ2F0ZXM6IE1vbnRobHlTcGVuZGluZ0FnZ3JlZ2F0ZXMgPSB7fVxuXG4gICAgY29uc3QgdHJhbnNhY3Rpb25zQnlNb250aDogeyBbbW9udGhZZWFyOiBzdHJpbmddOiBUcmFuc2FjdGlvbltdIH0gPSB0cmFuc2FjdGlvbnMucmVkdWNlKChhY2MsIHRyYW5zYWN0aW9uKSA9PiB7XG4gICAgICAgIGlmICh0cmFuc2FjdGlvbi5kYXRlKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodHJhbnNhY3Rpb24uZGF0ZSlcbiAgICAgICAgICAgIGNvbnN0IG1vbnRoWWVhciA9IGAke2RhdGUuZ2V0RnVsbFllYXIoKX0tJHtkYXRlLmdldE1vbnRoKCkgKyAxfWBcblxuICAgICAgICAgICAgaWYgKCFhY2NbbW9udGhZZWFyXSkge1xuICAgICAgICAgICAgICAgIGFjY1ttb250aFllYXJdID0gW11cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYWNjW21vbnRoWWVhcl0ucHVzaCh0cmFuc2FjdGlvbilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjXG4gICAgfSwge30gYXMgeyBbbW9udGhZZWFyOiBzdHJpbmddOiBUcmFuc2FjdGlvbltdIH0pXG5cbiAgICBmb3IgKGNvbnN0IFttb250aFllYXIsIG1vbnRoVHJhbnNhY3Rpb25zXSBvZiBPYmplY3QuZW50cmllcyh0cmFuc2FjdGlvbnNCeU1vbnRoKSkge1xuICAgICAgICBtb250aGx5QWdncmVnYXRlc1ttb250aFllYXJdID0gYWdncmVnYXRlU3BlbmRpbmdCeUNhdGVnb3J5KG1vbnRoVHJhbnNhY3Rpb25zKVxuICAgIH1cblxuICAgIHJldHVybiBtb250aGx5QWdncmVnYXRlc1xufVxuZnVuY3Rpb24gZ2V0RWFybGllc3RGaXJzdE9mTW9udGhXaXRoaW45MERheXMoY3JlYXRlZEF0OiBEYXRlKSB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gMTAwMCAqIDM2MDAgKiAyNCAqIDM2NSlcbn1cblxuZXhwb3J0IGNvbnN0IGNhbGN1bGF0ZUluY29tZUFuZFNwZW5kaW5nID0gYXN5bmMgKCkgPT4ge1xuICAgIC8vIFRPRE86IEFkZCBsb2dpYyB0byBoYW5kbGUgbGFzdCBjYWxjdWxhdGVkIGNvbXBsZXRlIG1vbnRoIGFuZCBzdGFydCBmcm9tIHRoZW5cbiAgICBjb25zdCBpdGVtcyA9IChhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoKGF3YWl0IGNsaWVudC5zZW5kKEdldEl0ZW1zKCkpKT8uSXRlbXMgPz8gW10pKS5tYXAobWFwRGRiUmVzcG9uc2VUb0l0ZW0pXG4gICAgLyoqIFRPRE86IEp1c3QgYWRkIGNyZWF0ZWQgYXQgdG8gdGhlIGl0ZW0/ICovXG4gICAgY29uc3QgZW5jcnlwdGVkVXNlckl0ZW1SZWNvcmQgPSBhd2FpdCBQcm9taXNlLmFsbChpdGVtcy5tYXAoYXN5bmMgKGVsKSA9PiBhd2FpdCBjbGllbnQuc2VuZChHZXRVc2VyKGVsLnNrIHx8ICcnKSkpKVxuICAgIGNvbnN0IGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkID0gKFxuICAgICAgICBhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoZW5jcnlwdGVkVXNlckl0ZW1SZWNvcmQuZmxhdE1hcCgob3V0cHV0KSA9PiBvdXRwdXQuSXRlbXMgPz8gW10pKVxuICAgIClcbiAgICAgICAgLm1hcChtYXBEZGJSZXNwb25zZVRvSXRlbSlcbiAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKCdQcm9jZXNzaW5nJywgaXRlbSlcbiAgICAgICAgICAgIHJldHVybiBpdGVtLnBrICYmIGl0ZW0uY3JlYXRlZF9hdFxuICAgICAgICB9KVxuICAgIC8qKiBHbyB0aHJvdWdoIHVzZXJzIGFuZCBhZ2dyZWdhdGUgdHJhbnNhY3Rpb25zICovXG4gICAgYXdhaXQgcHJvY2Vzc1VzZXJzSW5CYXRjaGVzKGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkKVxufVxuXG5mdW5jdGlvbiBjaHVua0FycmF5PFQ+KGFycmF5OiBUW10sIGNodW5rU2l6ZTogbnVtYmVyKTogVFtdW10ge1xuICAgIGNvbnN0IGNodW5rczogVFtdW10gPSBbXVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpICs9IGNodW5rU2l6ZSkge1xuICAgICAgICBjaHVua3MucHVzaChhcnJheS5zbGljZShpLCBpICsgY2h1bmtTaXplKSlcbiAgICB9XG4gICAgcmV0dXJuIGNodW5rc1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzVXNlcnNJbkJhdGNoZXMoZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQ6IEl0ZW1bXSkge1xuICAgIGNvbnN0IHVzZXJCYXRjaGVzID0gY2h1bmtBcnJheShkZWNyeXB0ZWRVc2VySXRlbVJlY29yZCwgMTAwKVxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkgLy8gR2V0IHRoZSBjdXJyZW50IGRhdGUgYW5kIHRpbWVcblxuICAgIGZvciAoY29uc3QgYmF0Y2ggb2YgdXNlckJhdGNoZXMpIHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICBiYXRjaC5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFydERheSA9IGdldEVhcmxpZXN0Rmlyc3RPZk1vbnRoV2l0aGluOTBEYXlzKG5ldyBEYXRlKGl0ZW0/LmNyZWF0ZWRfYXQgPz8gMCkpXG4gICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKHN0YXJ0RGF5KVxuICAgICAgICAgICAgICAgIGNvbnN0IGVuY3J5cHRlZFRyYW5zYWN0aW9ucyA9IGF3YWl0IGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICBHZXRFbnRpdGllcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwazogaXRlbS5wayA/PyAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVSYW5nZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0RGF5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheTogc3RhcnREYXkuZ2V0RGF0ZSgpICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9udGg6IHN0YXJ0RGF5LmdldE1vbnRoKCkgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ZWFyOiBzdGFydERheS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kRGF5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheTogbm93LmdldERhdGUoKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbnRoOiBub3cuZ2V0TW9udGgoKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHllYXI6IG5vdy5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzTm9UaW1lQ29uc3RyYWludDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5TmFtZTogJ1RSQU5TQUNUSU9OJyxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWRUcmFuc2FjdGlvbnMgPSAoYXdhaXQgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzKGVuY3J5cHRlZFRyYW5zYWN0aW9ucy5JdGVtcyA/PyBbXSkpLm1hcChcbiAgICAgICAgICAgICAgICAgICAgbWFwRHluYW1vREJUb1RyYW5zYWN0aW9uXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhkZWNyeXB0ZWRUcmFuc2FjdGlvbnMpXG4gICAgICAgICAgICAgICAgY29uc3QgYWdncmVnYXRlcyA9IGdyb3VwVHJhbnNhY3Rpb25zQnlNb250aChkZWNyeXB0ZWRUcmFuc2FjdGlvbnMpXG5cbiAgICAgICAgICAgICAgICBhd2FpdCB1cGxvYWRTcGVuZGluZ1N1bW1hcmllcyhcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5wayA/PyAnJyxcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoYWdncmVnYXRlcykuZmxhdE1hcCgoZWwpID0+IGVsWzFdLmRhaWx5X3NwZW5kaW5nKSxcbiAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRlc1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICB9XG59XG4iXX0=