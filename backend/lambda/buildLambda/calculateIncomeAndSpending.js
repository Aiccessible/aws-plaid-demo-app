"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateIncomeAndSpending = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Encryption_1 = require("./queries/Encryption");
const Item_1 = require("./mappers/Item");
const API_1 = require("./API");
const Transactions_1 = require("./mappers/Transactions");
const Summaries_1 = require("./queries/Summaries");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
function aggregateSpendingByCategory(transactions) {
    const MS_IN_A_DAY = 1000 * 60 * 60 * 24;
    // Initialize accumulators
    const dailySpendingMap = {};
    const weeklySpending = {};
    const monthlySpending = {};
    // Step 1: Sum amounts per category by day
    for (const transaction of transactions) {
        if (transaction.amount && transaction.date) {
            const amount = parseFloat(transaction.amount);
            const date = new Date(transaction.date);
            const dateKey = date.toISOString().split('T')[0]; // Format date as YYYY-MM-DD
            // Only consider transactions that are spending, not income or transfers
            let category;
            if ((transaction.personal_finance_category?.detailed).S in API_1.HighLevelTransactionCategory) {
                category = (transaction.personal_finance_category?.detailed).S ?? '';
            }
            else {
                category = (transaction.personal_finance_category?.primary).S ?? '';
            }
            if (category) {
                // Initialize daily spending map for the date if not present
                if (!dailySpendingMap[dateKey]) {
                    dailySpendingMap[dateKey] = {};
                }
                // Aggregate amounts for each category in daily, weekly, and monthly maps
                dailySpendingMap[dateKey][category] = (dailySpendingMap[dateKey][category] || 0) + Math.abs(amount);
                weeklySpending[category] = (weeklySpending[category] || 0) + Math.abs(amount);
                monthlySpending[category] = (monthlySpending[category] || 0) + Math.abs(amount);
            }
        }
    }
    // Convert daily spending map to an array of DailySpendingSummary
    const dailySpendingSummaries = Object.entries(dailySpendingMap).map(([date, spending]) => ({
        date,
        spending,
    }));
    // Step 2: Calculate date range for averages
    const transactionDates = Object.keys(dailySpendingMap).map((date) => new Date(date));
    if (transactionDates.length === 0) {
        throw new Error('No valid transactions found to aggregate.');
    }
    const minDate = new Date(Math.min(...transactionDates.map((date) => date.getTime())));
    const maxDate = new Date(Math.max(...transactionDates.map((date) => date.getTime())));
    const durationInDays = (maxDate.getTime() - minDate.getTime()) / MS_IN_A_DAY;
    // Step 3: Calculate weekly and monthly averages
    for (const category of Object.keys(weeklySpending)) {
        if (weeklySpending[category])
            weeklySpending[category] /= durationInDays / 7;
        if (monthlySpending[category])
            monthlySpending[category] /= durationInDays / 30;
    }
    return {
        daily_spending: dailySpendingSummaries,
        weekly_spending: weeklySpending,
        monthly_spending: monthlySpending,
    };
}
function groupTransactionsByMonth(transactions) {
    const monthlyAggregates = {};
    const transactionsByMonth = transactions.reduce((acc, transaction) => {
        if (transaction.date) {
            const date = new Date(transaction.date);
            const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
            if (!acc[monthYear]) {
                acc[monthYear] = [];
            }
            acc[monthYear].push(transaction);
        }
        return acc;
    }, {});
    for (const [monthYear, monthTransactions] of Object.entries(transactionsByMonth)) {
        monthlyAggregates[monthYear] = aggregateSpendingByCategory(monthTransactions);
    }
    return monthlyAggregates;
}
function getEarliestFirstOfMonthWithin90Days() {
    return new Date(new Date().getTime() - 1000 * 3600 * 24 * 365);
}
const calculateIncomeAndSpending = async () => {
    // TODO: Add logic to handle last calculated complete month and start from then
    const items = (await (0, Encryption_1.decryptItemsInBatches)((await client.send((0, Entities_1.GetItems)()))?.Items ?? [])).map(Item_1.mapDdbResponseToItem);
    /** TODO: Just add created at to the item? */
    const encryptedUserItemRecord = await Promise.all(items.map(async (el) => await client.send((0, Entities_1.GetUser)(el.sk || ''))));
    const decryptedUserItemRecord = (await (0, Encryption_1.decryptItemsInBatches)(encryptedUserItemRecord.flatMap((output) => output.Items ?? [])))
        .map(Item_1.mapDdbResponseToItem)
        .filter((item) => {
        console.info('Processing', item);
        return item.pk && item.created_at;
    });
    const ids = decryptedUserItemRecord.map((user) => user.pk?.replace(/#ITEM#\w+/, '') + '#TRANSACTIONS');
    const distinctUsers = [...new Set(ids)];
    /** Go through users and aggregate transactions */
    await processUsersInBatches(distinctUsers);
};
exports.calculateIncomeAndSpending = calculateIncomeAndSpending;
function chunkArray(array, chunkSize) {
    const chunks = [];
    for (let i = 0; i < array.length; i += chunkSize) {
        chunks.push(array.slice(i, i + chunkSize));
    }
    return chunks;
}
async function processUsersInBatches(decryptedUserItemRecord) {
    const userBatches = chunkArray(decryptedUserItemRecord, 100);
    const now = new Date(); // Get the current date and time
    for (const batch of userBatches) {
        await Promise.all(batch.map(async (item) => {
            const startDay = getEarliestFirstOfMonthWithin90Days();
            console.info(startDay);
            const encryptedTransactions = await client.send((0, Entities_1.GetEntities)({
                pk: item ?? '',
                dateRange: {
                    startDay: {
                        day: startDay.getDate() + 1,
                        month: startDay.getMonth() + 1,
                        year: startDay.getFullYear(),
                    },
                    endDay: {
                        day: now.getDate() + 1,
                        month: now.getMonth() + 1,
                        year: now.getFullYear(),
                    },
                    hasNoTimeConstraint: false,
                },
                username: '',
                id: '',
                entityName: 'TRANSACTION',
                getAllTransactionsForUser: true,
            }));
            const decryptedTransactions = (await (0, Encryption_1.decryptItemsInBatches)(encryptedTransactions.Items ?? [])).map(Transactions_1.mapDynamoDBToTransaction);
            console.info(decryptedTransactions);
            const aggregates = groupTransactionsByMonth(decryptedTransactions);
            await (0, Summaries_1.uploadSpendingSummaries)(item ?? '', Object.entries(aggregates).flatMap((el) => el[1].daily_spending), aggregates);
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsY3VsYXRlSW5jb21lQW5kU3BlbmRpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2FsY3VsYXRlSW5jb21lQW5kU3BlbmRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQXlFO0FBQ3pFLGlEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQseUNBQXFEO0FBQ3JELCtCQUF1RTtBQUN2RSx5REFBaUU7QUFDakUsbURBQTZEO0FBRzdELE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBaUI3RCxTQUFTLDJCQUEyQixDQUFDLFlBQTJCO0lBQzVELE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQTtJQUV2QywwQkFBMEI7SUFDMUIsTUFBTSxnQkFBZ0IsR0FBZ0YsRUFBRSxDQUFBO0lBQ3hHLE1BQU0sY0FBYyxHQUFHLEVBQTZELENBQUE7SUFDcEYsTUFBTSxlQUFlLEdBQUcsRUFBNkQsQ0FBQTtJQUVyRiwwQ0FBMEM7SUFDMUMsS0FBSyxNQUFNLFdBQVcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNyQyxJQUFJLFdBQVcsQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3pDLE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDN0MsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3ZDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyw0QkFBNEI7WUFFN0Usd0VBQXdFO1lBQ3hFLElBQUksUUFBc0MsQ0FBQTtZQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLHlCQUF5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Y0FBYyxDQUFDLEVBQ2hFLFVBQVUsQ0FDYixDQUFBO1FBQ0wsQ0FBQyxDQUFDLENBQ0wsQ0FBQTtJQUNMLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFB1dEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgR2V0RW50aXRpZXMsIEdldEl0ZW1zLCBHZXRVc2VyIH0gZnJvbSAnLi9xdWVyaWVzL0VudGl0aWVzJ1xuaW1wb3J0IHsgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzIH0gZnJvbSAnLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5pbXBvcnQgeyBtYXBEZGJSZXNwb25zZVRvSXRlbSB9IGZyb20gJy4vbWFwcGVycy9JdGVtJ1xuaW1wb3J0IHsgSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeSwgSXRlbSwgVHJhbnNhY3Rpb24gfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5pbXBvcnQgeyB1cGxvYWRTcGVuZGluZ1N1bW1hcmllcyB9IGZyb20gJy4vcXVlcmllcy9TdW1tYXJpZXMnXG5pbXBvcnQgeyBhbnkgfSBmcm9tICd6b2QnXG5cbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuZXhwb3J0IHR5cGUgRGFpbHlTcGVuZGluZ1N1bW1hcnkgPSB7XG4gICAgZGF0ZTogc3RyaW5nXG4gICAgc3BlbmRpbmc6IHsgW2NhdGVnb3J5IGluIEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnldPzogbnVtYmVyIH1cbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRlZFNwZW5kaW5nID0ge1xuICAgIGRhaWx5X3NwZW5kaW5nOiBEYWlseVNwZW5kaW5nU3VtbWFyeVtdXG4gICAgd2Vla2x5X3NwZW5kaW5nOiB7IFtjYXRlZ29yeSBpbiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XT86IG51bWJlciB9XG4gICAgbW9udGhseV9zcGVuZGluZzogeyBbY2F0ZWdvcnkgaW4gSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeV0/OiBudW1iZXIgfVxufVxuXG50eXBlIE1vbnRobHlTcGVuZGluZ0FnZ3JlZ2F0ZXMgPSB7XG4gICAgW21vbnRoWWVhcjogc3RyaW5nXTogQWdncmVnYXRlZFNwZW5kaW5nXG59XG5cbmZ1bmN0aW9uIGFnZ3JlZ2F0ZVNwZW5kaW5nQnlDYXRlZ29yeSh0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9uW10pOiBBZ2dyZWdhdGVkU3BlbmRpbmcge1xuICAgIGNvbnN0IE1TX0lOX0FfREFZID0gMTAwMCAqIDYwICogNjAgKiAyNFxuXG4gICAgLy8gSW5pdGlhbGl6ZSBhY2N1bXVsYXRvcnNcbiAgICBjb25zdCBkYWlseVNwZW5kaW5nTWFwOiB7IFtkYXRlOiBzdHJpbmddOiB7IFtjYXRlZ29yeSBpbiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XT86IG51bWJlciB9IH0gPSB7fVxuICAgIGNvbnN0IHdlZWtseVNwZW5kaW5nID0ge30gYXMgeyBbY2F0ZWdvcnkgaW4gSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeV0/OiBudW1iZXIgfVxuICAgIGNvbnN0IG1vbnRobHlTcGVuZGluZyA9IHt9IGFzIHsgW2NhdGVnb3J5IGluIEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnldPzogbnVtYmVyIH1cblxuICAgIC8vIFN0ZXAgMTogU3VtIGFtb3VudHMgcGVyIGNhdGVnb3J5IGJ5IGRheVxuICAgIGZvciAoY29uc3QgdHJhbnNhY3Rpb24gb2YgdHJhbnNhY3Rpb25zKSB7XG4gICAgICAgIGlmICh0cmFuc2FjdGlvbi5hbW91bnQgJiYgdHJhbnNhY3Rpb24uZGF0ZSkge1xuICAgICAgICAgICAgY29uc3QgYW1vdW50ID0gcGFyc2VGbG9hdCh0cmFuc2FjdGlvbi5hbW91bnQpXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodHJhbnNhY3Rpb24uZGF0ZSlcbiAgICAgICAgICAgIGNvbnN0IGRhdGVLZXkgPSBkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSAvLyBGb3JtYXQgZGF0ZSBhcyBZWVlZLU1NLUREXG5cbiAgICAgICAgICAgIC8vIE9ubHkgY29uc2lkZXIgdHJhbnNhY3Rpb25zIHRoYXQgYXJlIHNwZW5kaW5nLCBub3QgaW5jb21lIG9yIHRyYW5zZmVyc1xuICAgICAgICAgICAgbGV0IGNhdGVnb3J5OiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XG4gICAgICAgICAgICBpZiAoKHRyYW5zYWN0aW9uLnBlcnNvbmFsX2ZpbmFuY2VfY2F0ZWdvcnk/LmRldGFpbGVkIGFzIGFueSkuUyBpbiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5KSB7XG4gICAgICAgICAgICAgICAgY2F0ZWdvcnkgPSAodHJhbnNhY3Rpb24ucGVyc29uYWxfZmluYW5jZV9jYXRlZ29yeT8uZGV0YWlsZWQgYXMgYW55KS5TID8/ICcnXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhdGVnb3J5ID0gKHRyYW5zYWN0aW9uLnBlcnNvbmFsX2ZpbmFuY2VfY2F0ZWdvcnk/LnByaW1hcnkgYXMgYW55KS5TID8/ICcnXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIGRhaWx5IHNwZW5kaW5nIG1hcCBmb3IgdGhlIGRhdGUgaWYgbm90IHByZXNlbnRcbiAgICAgICAgICAgICAgICBpZiAoIWRhaWx5U3BlbmRpbmdNYXBbZGF0ZUtleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGFpbHlTcGVuZGluZ01hcFtkYXRlS2V5XSA9IHt9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gQWdncmVnYXRlIGFtb3VudHMgZm9yIGVhY2ggY2F0ZWdvcnkgaW4gZGFpbHksIHdlZWtseSwgYW5kIG1vbnRobHkgbWFwc1xuICAgICAgICAgICAgICAgIGRhaWx5U3BlbmRpbmdNYXBbZGF0ZUtleV1bY2F0ZWdvcnldID0gKGRhaWx5U3BlbmRpbmdNYXBbZGF0ZUtleV1bY2F0ZWdvcnldIHx8IDApICsgTWF0aC5hYnMoYW1vdW50KVxuICAgICAgICAgICAgICAgIHdlZWtseVNwZW5kaW5nW2NhdGVnb3J5XSA9ICh3ZWVrbHlTcGVuZGluZ1tjYXRlZ29yeV0gfHwgMCkgKyBNYXRoLmFicyhhbW91bnQpXG4gICAgICAgICAgICAgICAgbW9udGhseVNwZW5kaW5nW2NhdGVnb3J5XSA9IChtb250aGx5U3BlbmRpbmdbY2F0ZWdvcnldIHx8IDApICsgTWF0aC5hYnMoYW1vdW50KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCBkYWlseSBzcGVuZGluZyBtYXAgdG8gYW4gYXJyYXkgb2YgRGFpbHlTcGVuZGluZ1N1bW1hcnlcbiAgICBjb25zdCBkYWlseVNwZW5kaW5nU3VtbWFyaWVzOiBEYWlseVNwZW5kaW5nU3VtbWFyeVtdID0gT2JqZWN0LmVudHJpZXMoZGFpbHlTcGVuZGluZ01hcCkubWFwKChbZGF0ZSwgc3BlbmRpbmddKSA9PiAoe1xuICAgICAgICBkYXRlLFxuICAgICAgICBzcGVuZGluZyxcbiAgICB9KSlcblxuICAgIC8vIFN0ZXAgMjogQ2FsY3VsYXRlIGRhdGUgcmFuZ2UgZm9yIGF2ZXJhZ2VzXG4gICAgY29uc3QgdHJhbnNhY3Rpb25EYXRlcyA9IE9iamVjdC5rZXlzKGRhaWx5U3BlbmRpbmdNYXApLm1hcCgoZGF0ZSkgPT4gbmV3IERhdGUoZGF0ZSkpXG4gICAgaWYgKHRyYW5zYWN0aW9uRGF0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdmFsaWQgdHJhbnNhY3Rpb25zIGZvdW5kIHRvIGFnZ3JlZ2F0ZS4nKVxuICAgIH1cblxuICAgIGNvbnN0IG1pbkRhdGUgPSBuZXcgRGF0ZShNYXRoLm1pbiguLi50cmFuc2FjdGlvbkRhdGVzLm1hcCgoZGF0ZSkgPT4gZGF0ZS5nZXRUaW1lKCkpKSlcbiAgICBjb25zdCBtYXhEYXRlID0gbmV3IERhdGUoTWF0aC5tYXgoLi4udHJhbnNhY3Rpb25EYXRlcy5tYXAoKGRhdGUpID0+IGRhdGUuZ2V0VGltZSgpKSkpXG4gICAgY29uc3QgZHVyYXRpb25JbkRheXMgPSAobWF4RGF0ZS5nZXRUaW1lKCkgLSBtaW5EYXRlLmdldFRpbWUoKSkgLyBNU19JTl9BX0RBWVxuXG4gICAgLy8gU3RlcCAzOiBDYWxjdWxhdGUgd2Vla2x5IGFuZCBtb250aGx5IGF2ZXJhZ2VzXG4gICAgZm9yIChjb25zdCBjYXRlZ29yeSBvZiBPYmplY3Qua2V5cyh3ZWVrbHlTcGVuZGluZykgYXMgSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeVtdKSB7XG4gICAgICAgIGlmICh3ZWVrbHlTcGVuZGluZ1tjYXRlZ29yeV0pIHdlZWtseVNwZW5kaW5nW2NhdGVnb3J5XSEgLz0gZHVyYXRpb25JbkRheXMgLyA3XG4gICAgICAgIGlmIChtb250aGx5U3BlbmRpbmdbY2F0ZWdvcnldKSBtb250aGx5U3BlbmRpbmdbY2F0ZWdvcnldISAvPSBkdXJhdGlvbkluRGF5cyAvIDMwXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZGFpbHlfc3BlbmRpbmc6IGRhaWx5U3BlbmRpbmdTdW1tYXJpZXMsXG4gICAgICAgIHdlZWtseV9zcGVuZGluZzogd2Vla2x5U3BlbmRpbmcsXG4gICAgICAgIG1vbnRobHlfc3BlbmRpbmc6IG1vbnRobHlTcGVuZGluZyxcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGdyb3VwVHJhbnNhY3Rpb25zQnlNb250aCh0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9uW10pOiBNb250aGx5U3BlbmRpbmdBZ2dyZWdhdGVzIHtcbiAgICBjb25zdCBtb250aGx5QWdncmVnYXRlczogTW9udGhseVNwZW5kaW5nQWdncmVnYXRlcyA9IHt9XG5cbiAgICBjb25zdCB0cmFuc2FjdGlvbnNCeU1vbnRoOiB7IFttb250aFllYXI6IHN0cmluZ106IFRyYW5zYWN0aW9uW10gfSA9IHRyYW5zYWN0aW9ucy5yZWR1Y2UoKGFjYywgdHJhbnNhY3Rpb24pID0+IHtcbiAgICAgICAgaWYgKHRyYW5zYWN0aW9uLmRhdGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh0cmFuc2FjdGlvbi5kYXRlKVxuICAgICAgICAgICAgY29uc3QgbW9udGhZZWFyID0gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfS0ke2RhdGUuZ2V0TW9udGgoKSArIDF9YFxuXG4gICAgICAgICAgICBpZiAoIWFjY1ttb250aFllYXJdKSB7XG4gICAgICAgICAgICAgICAgYWNjW21vbnRoWWVhcl0gPSBbXVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhY2NbbW9udGhZZWFyXS5wdXNoKHRyYW5zYWN0aW9uKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2NcbiAgICB9LCB7fSBhcyB7IFttb250aFllYXI6IHN0cmluZ106IFRyYW5zYWN0aW9uW10gfSlcblxuICAgIGZvciAoY29uc3QgW21vbnRoWWVhciwgbW9udGhUcmFuc2FjdGlvbnNdIG9mIE9iamVjdC5lbnRyaWVzKHRyYW5zYWN0aW9uc0J5TW9udGgpKSB7XG4gICAgICAgIG1vbnRobHlBZ2dyZWdhdGVzW21vbnRoWWVhcl0gPSBhZ2dyZWdhdGVTcGVuZGluZ0J5Q2F0ZWdvcnkobW9udGhUcmFuc2FjdGlvbnMpXG4gICAgfVxuXG4gICAgcmV0dXJuIG1vbnRobHlBZ2dyZWdhdGVzXG59XG5mdW5jdGlvbiBnZXRFYXJsaWVzdEZpcnN0T2ZNb250aFdpdGhpbjkwRGF5cygpIHtcbiAgICByZXR1cm4gbmV3IERhdGUobmV3IERhdGUoKS5nZXRUaW1lKCkgLSAxMDAwICogMzYwMCAqIDI0ICogMzY1KVxufVxuXG5leHBvcnQgY29uc3QgY2FsY3VsYXRlSW5jb21lQW5kU3BlbmRpbmcgPSBhc3luYyAoKSA9PiB7XG4gICAgLy8gVE9ETzogQWRkIGxvZ2ljIHRvIGhhbmRsZSBsYXN0IGNhbGN1bGF0ZWQgY29tcGxldGUgbW9udGggYW5kIHN0YXJ0IGZyb20gdGhlblxuICAgIGNvbnN0IGl0ZW1zID0gKGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcygoYXdhaXQgY2xpZW50LnNlbmQoR2V0SXRlbXMoKSkpPy5JdGVtcyA/PyBbXSkpLm1hcChtYXBEZGJSZXNwb25zZVRvSXRlbSlcbiAgICAvKiogVE9ETzogSnVzdCBhZGQgY3JlYXRlZCBhdCB0byB0aGUgaXRlbT8gKi9cbiAgICBjb25zdCBlbmNyeXB0ZWRVc2VySXRlbVJlY29yZCA9IGF3YWl0IFByb21pc2UuYWxsKGl0ZW1zLm1hcChhc3luYyAoZWwpID0+IGF3YWl0IGNsaWVudC5zZW5kKEdldFVzZXIoZWwuc2sgfHwgJycpKSkpXG4gICAgY29uc3QgZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQgPSAoXG4gICAgICAgIGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyhlbmNyeXB0ZWRVc2VySXRlbVJlY29yZC5mbGF0TWFwKChvdXRwdXQpID0+IG91dHB1dC5JdGVtcyA/PyBbXSkpXG4gICAgKVxuICAgICAgICAubWFwKG1hcERkYlJlc3BvbnNlVG9JdGVtKVxuICAgICAgICAuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oJ1Byb2Nlc3NpbmcnLCBpdGVtKVxuICAgICAgICAgICAgcmV0dXJuIGl0ZW0ucGsgJiYgaXRlbS5jcmVhdGVkX2F0XG4gICAgICAgIH0pXG4gICAgY29uc3QgaWRzID0gZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQubWFwKCh1c2VyKSA9PiB1c2VyLnBrPy5yZXBsYWNlKC8jSVRFTSNcXHcrLywgJycpICsgJyNUUkFOU0FDVElPTlMnKVxuICAgIGNvbnN0IGRpc3RpbmN0VXNlcnMgPSBbLi4ubmV3IFNldChpZHMpXVxuXG4gICAgLyoqIEdvIHRocm91Z2ggdXNlcnMgYW5kIGFnZ3JlZ2F0ZSB0cmFuc2FjdGlvbnMgKi9cbiAgICBhd2FpdCBwcm9jZXNzVXNlcnNJbkJhdGNoZXMoZGlzdGluY3RVc2VycyBhcyBzdHJpbmdbXSlcbn1cblxuZnVuY3Rpb24gY2h1bmtBcnJheTxUPihhcnJheTogVFtdLCBjaHVua1NpemU6IG51bWJlcik6IFRbXVtdIHtcbiAgICBjb25zdCBjaHVua3M6IFRbXVtdID0gW11cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBjaHVua1NpemUpIHtcbiAgICAgICAgY2h1bmtzLnB1c2goYXJyYXkuc2xpY2UoaSwgaSArIGNodW5rU2l6ZSkpXG4gICAgfVxuICAgIHJldHVybiBjaHVua3Ncbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1VzZXJzSW5CYXRjaGVzKGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHVzZXJCYXRjaGVzID0gY2h1bmtBcnJheShkZWNyeXB0ZWRVc2VySXRlbVJlY29yZCwgMTAwKVxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkgLy8gR2V0IHRoZSBjdXJyZW50IGRhdGUgYW5kIHRpbWVcblxuICAgIGZvciAoY29uc3QgYmF0Y2ggb2YgdXNlckJhdGNoZXMpIHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICBiYXRjaC5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFydERheSA9IGdldEVhcmxpZXN0Rmlyc3RPZk1vbnRoV2l0aGluOTBEYXlzKClcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oc3RhcnREYXkpXG4gICAgICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkVHJhbnNhY3Rpb25zID0gYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBrOiBpdGVtID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnREYXk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF5OiBzdGFydERheS5nZXREYXRlKCkgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb250aDogc3RhcnREYXkuZ2V0TW9udGgoKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHllYXI6IHN0YXJ0RGF5LmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmREYXk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF5OiBub3cuZ2V0RGF0ZSgpICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9udGg6IG5vdy5nZXRNb250aCgpICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWVhcjogbm93LmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNOb1RpbWVDb25zdHJhaW50OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lOiAnVFJBTlNBQ1RJT04nLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QWxsVHJhbnNhY3Rpb25zRm9yVXNlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWRUcmFuc2FjdGlvbnMgPSAoYXdhaXQgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzKGVuY3J5cHRlZFRyYW5zYWN0aW9ucy5JdGVtcyA/PyBbXSkpLm1hcChcbiAgICAgICAgICAgICAgICAgICAgbWFwRHluYW1vREJUb1RyYW5zYWN0aW9uXG4gICAgICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKGRlY3J5cHRlZFRyYW5zYWN0aW9ucylcbiAgICAgICAgICAgICAgICBjb25zdCBhZ2dyZWdhdGVzID0gZ3JvdXBUcmFuc2FjdGlvbnNCeU1vbnRoKGRlY3J5cHRlZFRyYW5zYWN0aW9ucylcblxuICAgICAgICAgICAgICAgIGF3YWl0IHVwbG9hZFNwZW5kaW5nU3VtbWFyaWVzKFxuICAgICAgICAgICAgICAgICAgICBpdGVtID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhhZ2dyZWdhdGVzKS5mbGF0TWFwKChlbCkgPT4gZWxbMV0uZGFpbHlfc3BlbmRpbmcpLFxuICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdGVzXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgIH1cbn1cbiJdfQ==