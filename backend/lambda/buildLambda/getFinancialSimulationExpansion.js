"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFinancialSimulationExpansion = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_s3_1 = require("@aws-sdk/client-s3");
const stockPrompts_1 = require("./stockPrompts");
const s3 = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const getFinancialSimulationExpansion = async (event, context) => {
    const user = event.identity?.username;
    let previousCodeRun = stockPrompts_1.previousCode;
    if (event.arguments.chat.s3Key) {
        const bucketName = process.env.S3_BUCKET; // Ensure this environment variable is set
        const s3Key = event.arguments.chat.s3Key;
        try {
            const command = new client_s3_1.GetObjectCommand({
                Bucket: bucketName,
                Key: s3Key,
            });
            const s3Response = await s3.send(command);
            if (s3Response.Body) {
                const bodyContents = await s3Response.Body.transformToString(); // Automatically convert to string
                previousCodeRun = bodyContents;
            }
            else {
                throw new Error('File content is empty or invalid.');
            }
        }
        catch (error) {
            console.error('Error fetching S3 file:', error);
            throw new Error('Failed to retrieve S3 file.');
        }
    }
    const message1 = `${previousCodeRun} \nBased on the code and the following prompt, tell us what inputs we will need to add to accomadate, do not rewrite the code. ${event.arguments.chat.message}`;
    const response1 = await (0, gpt_1.completeChatFromPrompt)(message1, API_1.ChatFocus.All, user, false, API_1.ChatType.SimulationPreExpansion);
    const parsedSimulationPreExpansionResponse = JSON.parse(response1 || '');
    await (0, gpt_1.sendChatToUI)(user, 'SimulationPreExpansionMessage', JSON.stringify({
        __typename: 'FinancialSimulationPreExpansion',
        inputs: parsedSimulationPreExpansionResponse.inputKeys,
        description: parsedSimulationPreExpansionResponse.highLevelDescriptionOfIdeaWithoutMentioningCode,
        title: parsedSimulationPreExpansionResponse.title,
    }), true, user + Date.now().toString());
    const message = `${previousCodeRun} Expand the script, do not rename the function, the input set in body will now include the keys ${parsedSimulationPreExpansionResponse.inputKeys
        .map((el) => `${el.name}: ${el.defaultValue}, `)
        .join(', ')} All users are in Canada and use the registered Accounts: FHSA, RSPs, TFSAs. Output the updated script as runnable code`;
    const response = await (0, gpt_1.completeChatFromPrompt)(message, API_1.ChatFocus.All, user, false, API_1.ChatType.SimulationExpansion);
    const recommentations = JSON.parse(response || '');
    const newCode = recommentations.newCode;
    const newFileKey = user + '-' + Math.floor(Math.random() * 1000000);
    await (0, gpt_1.sendChatToUI)(user, 'SimulationExpansionMessage', JSON.stringify({
        __typename: 'FinancialSimulationExpansion',
        s3Key: newFileKey,
    }), true, user + Date.now().toString());
    try {
        // Upload new code to S3
        const putCommand = new client_s3_1.PutObjectCommand({
            Bucket: process.env.S3_BUCKET,
            Key: newFileKey,
            Body: newCode,
            ContentType: 'application/javascript', // Assuming it's JS code
        });
        await s3.send(putCommand);
        console.log(`New code uploaded to S3: ${newFileKey}`);
    }
    catch (error) {
        console.error('Error uploading new code to S3:', error);
        throw new Error('Failed to upload new code to S3.');
    }
    console.debug('Got', recommentations, ' From GPT');
    return {
        __typename: 'FinancialSimulationExpansion',
        s3Key: newFileKey,
    };
};
exports.getFinancialSimulationExpansion = getFinancialSimulationExpansion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0RmluYW5jaWFsU2ltdWxhdGlvbkV4cGFuc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9nZXRGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLCtCQUFvRztBQUNwRywrQkFLYztBQUNkLGtEQUFpRjtBQUNqRixpREFBNkM7QUFDN0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQTtBQUVwRCxNQUFNLCtCQUErQixHQUFxRSxLQUFLLEVBQ2xILEtBQWdFLEVBQ2hFLE9BQWdCLEVBQ2xCLEVBQUU7SUFDQSxNQUFNLElBQUksR0FBSSxLQUFLLENBQUMsUUFBbUMsRUFBRSxRQUFRLENBQUE7SUFFakUsSUFBSSxlQUFlLEdBQUcsMkJBQVksQ0FBQTtJQUNsQyxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzdCLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFBLENBQUMsMENBQTBDO1FBQ25GLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtRQUV4QyxJQUFJLENBQUM7WUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLDRCQUFnQixDQUFDO2dCQUNqQyxNQUFNLEVBQUUsVUFBVztnQkFDbkIsR0FBRyxFQUFFLEtBQUs7YUFDYixDQUFDLENBQUE7WUFFRixNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFFekMsSUFBSSxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xCLE1BQU0sWUFBWSxHQUFHLE1BQU0sVUFBVSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFBLENBQUMsa0NBQWtDO2dCQUNqRyxlQUFlLEdBQUcsWUFBWSxDQUFBO1lBQ2xDLENBQUM7aUJBQU0sQ0FBQztnQkFDSixNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUE7WUFDeEQsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUMvQyxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUE7UUFDbEQsQ0FBQztJQUNMLENBQUM7SUFDRCxNQUFNLFFBQVEsR0FBRyxHQUFHLGVBQWUsa0lBQWtJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ25NLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBQSw0QkFBc0IsRUFDMUMsUUFBUSxFQUNSLGVBQVMsQ0FBQyxHQUFHLEVBQ2IsSUFBSSxFQUNKLEtBQUssRUFDTCxjQUFRLENBQUMsc0JBQXNCLENBQ2xDLENBQUE7SUFDRCxNQUFNLG9DQUFvQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBNEMsQ0FBQTtJQUVuSCxNQUFNLElBQUEsa0JBQVksRUFDZCxJQUFJLEVBQ0osK0JBQStCLEVBQy9CLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDWCxVQUFVLEVBQUUsaUNBQWlDO1FBQzdDLE1BQU0sRUFBRSxvQ0FBb0MsQ0FBQyxTQUFTO1FBQ3RELFdBQVcsRUFBRSxvQ0FBb0MsQ0FBQywrQ0FBK0M7UUFDakcsS0FBSyxFQUFFLG9DQUFvQyxDQUFDLEtBQUs7S0FDcEQsQ0FBQyxFQUNGLElBQUksRUFDSixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUMvQixDQUFBO0lBQ0QsTUFBTSxPQUFPLEdBQUcsR0FBRyxlQUFlLG1HQUFtRyxvQ0FBb0MsQ0FBQyxTQUFTO1NBQzlLLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxZQUFZLElBQUksQ0FBQztTQUMvQyxJQUFJLENBQ0QsSUFBSSxDQUNQLHlIQUF5SCxDQUFBO0lBQzlILE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSw0QkFBc0IsRUFBQyxPQUFPLEVBQUUsZUFBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLGNBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0lBQ2hILE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBeUMsQ0FBQTtJQUMxRixNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFBO0lBQ3ZDLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUE7SUFFbkUsTUFBTSxJQUFBLGtCQUFZLEVBQ2QsSUFBSSxFQUNKLDRCQUE0QixFQUM1QixJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ1gsVUFBVSxFQUFFLDhCQUE4QjtRQUMxQyxLQUFLLEVBQUUsVUFBVTtLQUNwQixDQUFDLEVBQ0YsSUFBSSxFQUNKLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQy9CLENBQUE7SUFDRCxJQUFJLENBQUM7UUFDRCx3QkFBd0I7UUFDeEIsTUFBTSxVQUFVLEdBQUcsSUFBSSw0QkFBZ0IsQ0FBQztZQUNwQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTO1lBQzdCLEdBQUcsRUFBRSxVQUFVO1lBQ2YsSUFBSSxFQUFFLE9BQU87WUFDYixXQUFXLEVBQUUsd0JBQXdCLEVBQUUsd0JBQXdCO1NBQ2xFLENBQUMsQ0FBQTtRQUVGLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUV6QixPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixVQUFVLEVBQUUsQ0FBQyxDQUFBO0lBQ3pELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN2RCxNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUE7SUFDdkQsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUNsRCxPQUFPO1FBQ0gsVUFBVSxFQUFFLDhCQUE4QjtRQUMxQyxLQUFLLEVBQUUsVUFBVTtLQUNwQixDQUFBO0FBQ0wsQ0FBQyxDQUFBO0FBOUZZLFFBQUEsK0JBQStCLG1DQThGM0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvLCBBcHBTeW5jUmVzb2x2ZXJFdmVudCwgQXBwU3luY1Jlc29sdmVySGFuZGxlciwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBDaGF0Rm9jdXMsIENoYXRUeXBlLCBFeHBhbmRGaW5hbmNpYWxTaW11bGF0aW9uLCBGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uIH0gZnJvbSAnLi9BUEknXG5pbXBvcnQge1xuICAgIGNvbXBsZXRlQ2hhdEZyb21Qcm9tcHQsXG4gICAgc2VuZENoYXRUb1VJLFxuICAgIFNpbXVsYXRpb25FeHBhbnNpb25SZXNwb25zZUludGVyZmFjZSxcbiAgICBTaW11bGF0aW9uUHJlRXhwYW5zaW9uUmVzcG9uc2VJbnRlcmZhY2UsXG59IGZyb20gJy4vZ3B0J1xuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQsIFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnXG5pbXBvcnQgeyBwcmV2aW91c0NvZGUgfSBmcm9tICcuL3N0b2NrUHJvbXB0cydcbmNvbnN0IHMzID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pXG5cbmV4cG9ydCBjb25zdCBnZXRGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uOiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgRmluYW5jaWFsU2ltdWxhdGlvbkV4cGFuc2lvbiB8IHZvaWQ+ID0gYXN5bmMgKFxuICAgIGV2ZW50OiBBcHBTeW5jUmVzb2x2ZXJFdmVudDx7IGNoYXQ6IEV4cGFuZEZpbmFuY2lhbFNpbXVsYXRpb24gfT4sXG4gICAgY29udGV4dDogQ29udGV4dFxuKSA9PiB7XG4gICAgY29uc3QgdXNlciA9IChldmVudC5pZGVudGl0eSBhcyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvKT8udXNlcm5hbWVcblxuICAgIGxldCBwcmV2aW91c0NvZGVSdW4gPSBwcmV2aW91c0NvZGVcbiAgICBpZiAoZXZlbnQuYXJndW1lbnRzLmNoYXQuczNLZXkpIHtcbiAgICAgICAgY29uc3QgYnVja2V0TmFtZSA9IHByb2Nlc3MuZW52LlMzX0JVQ0tFVCAvLyBFbnN1cmUgdGhpcyBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBzZXRcbiAgICAgICAgY29uc3QgczNLZXkgPSBldmVudC5hcmd1bWVudHMuY2hhdC5zM0tleVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICAgICAgICAgIEJ1Y2tldDogYnVja2V0TmFtZSEsXG4gICAgICAgICAgICAgICAgS2V5OiBzM0tleSxcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIGNvbnN0IHMzUmVzcG9uc2UgPSBhd2FpdCBzMy5zZW5kKGNvbW1hbmQpXG5cbiAgICAgICAgICAgIGlmIChzM1Jlc3BvbnNlLkJvZHkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBib2R5Q29udGVudHMgPSBhd2FpdCBzM1Jlc3BvbnNlLkJvZHkudHJhbnNmb3JtVG9TdHJpbmcoKSAvLyBBdXRvbWF0aWNhbGx5IGNvbnZlcnQgdG8gc3RyaW5nXG4gICAgICAgICAgICAgICAgcHJldmlvdXNDb2RlUnVuID0gYm9keUNvbnRlbnRzXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmlsZSBjb250ZW50IGlzIGVtcHR5IG9yIGludmFsaWQuJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIFMzIGZpbGU6JywgZXJyb3IpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBTMyBmaWxlLicpXG4gICAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgbWVzc2FnZTEgPSBgJHtwcmV2aW91c0NvZGVSdW59IFxcbkJhc2VkIG9uIHRoZSBjb2RlIGFuZCB0aGUgZm9sbG93aW5nIHByb21wdCwgdGVsbCB1cyB3aGF0IGlucHV0cyB3ZSB3aWxsIG5lZWQgdG8gYWRkIHRvIGFjY29tYWRhdGUsIGRvIG5vdCByZXdyaXRlIHRoZSBjb2RlLiAke2V2ZW50LmFyZ3VtZW50cy5jaGF0Lm1lc3NhZ2V9YFxuICAgIGNvbnN0IHJlc3BvbnNlMSA9IGF3YWl0IGNvbXBsZXRlQ2hhdEZyb21Qcm9tcHQoXG4gICAgICAgIG1lc3NhZ2UxLFxuICAgICAgICBDaGF0Rm9jdXMuQWxsLFxuICAgICAgICB1c2VyLFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgQ2hhdFR5cGUuU2ltdWxhdGlvblByZUV4cGFuc2lvblxuICAgIClcbiAgICBjb25zdCBwYXJzZWRTaW11bGF0aW9uUHJlRXhwYW5zaW9uUmVzcG9uc2UgPSBKU09OLnBhcnNlKHJlc3BvbnNlMSB8fCAnJykgYXMgU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlSW50ZXJmYWNlXG5cbiAgICBhd2FpdCBzZW5kQ2hhdFRvVUkoXG4gICAgICAgIHVzZXIsXG4gICAgICAgICdTaW11bGF0aW9uUHJlRXhwYW5zaW9uTWVzc2FnZScsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIF9fdHlwZW5hbWU6ICdGaW5hbmNpYWxTaW11bGF0aW9uUHJlRXhwYW5zaW9uJyxcbiAgICAgICAgICAgIGlucHV0czogcGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLmlucHV0S2V5cyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBwYXJzZWRTaW11bGF0aW9uUHJlRXhwYW5zaW9uUmVzcG9uc2UuaGlnaExldmVsRGVzY3JpcHRpb25PZklkZWFXaXRob3V0TWVudGlvbmluZ0NvZGUsXG4gICAgICAgICAgICB0aXRsZTogcGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLnRpdGxlLFxuICAgICAgICB9KSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgdXNlciArIERhdGUubm93KCkudG9TdHJpbmcoKVxuICAgIClcbiAgICBjb25zdCBtZXNzYWdlID0gYCR7cHJldmlvdXNDb2RlUnVufSBFeHBhbmQgdGhlIHNjcmlwdCwgZG8gbm90IHJlbmFtZSB0aGUgZnVuY3Rpb24sIHRoZSBpbnB1dCBzZXQgaW4gYm9keSB3aWxsIG5vdyBpbmNsdWRlIHRoZSBrZXlzICR7cGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLmlucHV0S2V5c1xuICAgICAgICAubWFwKChlbCkgPT4gYCR7ZWwubmFtZX06ICR7ZWwuZGVmYXVsdFZhbHVlfSwgYClcbiAgICAgICAgLmpvaW4oXG4gICAgICAgICAgICAnLCAnXG4gICAgICAgICl9IEFsbCB1c2VycyBhcmUgaW4gQ2FuYWRhIGFuZCB1c2UgdGhlIHJlZ2lzdGVyZWQgQWNjb3VudHM6IEZIU0EsIFJTUHMsIFRGU0FzLiBPdXRwdXQgdGhlIHVwZGF0ZWQgc2NyaXB0IGFzIHJ1bm5hYmxlIGNvZGVgXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0KG1lc3NhZ2UsIENoYXRGb2N1cy5BbGwsIHVzZXIsIGZhbHNlLCBDaGF0VHlwZS5TaW11bGF0aW9uRXhwYW5zaW9uKVxuICAgIGNvbnN0IHJlY29tbWVudGF0aW9ucyA9IEpTT04ucGFyc2UocmVzcG9uc2UgfHwgJycpIGFzIFNpbXVsYXRpb25FeHBhbnNpb25SZXNwb25zZUludGVyZmFjZVxuICAgIGNvbnN0IG5ld0NvZGUgPSByZWNvbW1lbnRhdGlvbnMubmV3Q29kZVxuICAgIGNvbnN0IG5ld0ZpbGVLZXkgPSB1c2VyICsgJy0nICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTAwMDAwMClcblxuICAgIGF3YWl0IHNlbmRDaGF0VG9VSShcbiAgICAgICAgdXNlcixcbiAgICAgICAgJ1NpbXVsYXRpb25FeHBhbnNpb25NZXNzYWdlJyxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgX190eXBlbmFtZTogJ0ZpbmFuY2lhbFNpbXVsYXRpb25FeHBhbnNpb24nLFxuICAgICAgICAgICAgczNLZXk6IG5ld0ZpbGVLZXksXG4gICAgICAgIH0pLFxuICAgICAgICB0cnVlLFxuICAgICAgICB1c2VyICsgRGF0ZS5ub3coKS50b1N0cmluZygpXG4gICAgKVxuICAgIHRyeSB7XG4gICAgICAgIC8vIFVwbG9hZCBuZXcgY29kZSB0byBTM1xuICAgICAgICBjb25zdCBwdXRDb21tYW5kID0gbmV3IFB1dE9iamVjdENvbW1hbmQoe1xuICAgICAgICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5TM19CVUNLRVQsXG4gICAgICAgICAgICBLZXk6IG5ld0ZpbGVLZXksXG4gICAgICAgICAgICBCb2R5OiBuZXdDb2RlLFxuICAgICAgICAgICAgQ29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywgLy8gQXNzdW1pbmcgaXQncyBKUyBjb2RlXG4gICAgICAgIH0pXG5cbiAgICAgICAgYXdhaXQgczMuc2VuZChwdXRDb21tYW5kKVxuXG4gICAgICAgIGNvbnNvbGUubG9nKGBOZXcgY29kZSB1cGxvYWRlZCB0byBTMzogJHtuZXdGaWxlS2V5fWApXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdXBsb2FkaW5nIG5ldyBjb2RlIHRvIFMzOicsIGVycm9yKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byB1cGxvYWQgbmV3IGNvZGUgdG8gUzMuJylcbiAgICB9XG5cbiAgICBjb25zb2xlLmRlYnVnKCdHb3QnLCByZWNvbW1lbnRhdGlvbnMsICcgRnJvbSBHUFQnKVxuICAgIHJldHVybiB7XG4gICAgICAgIF9fdHlwZW5hbWU6ICdGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uJyxcbiAgICAgICAgczNLZXk6IG5ld0ZpbGVLZXksXG4gICAgfVxufVxuIl19