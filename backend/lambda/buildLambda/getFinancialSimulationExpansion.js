"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFinancialSimulationExpansion = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_s3_1 = require("@aws-sdk/client-s3");
const stockPrompts_1 = require("./stockPrompts");
const s3 = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const getFinancialSimulationExpansion = async (event, context) => {
    const user = event.identity?.username;
    let previousCodeRun = stockPrompts_1.previousCode;
    if (event.arguments.chat.s3Key) {
        const bucketName = process.env.S3_BUCKET; // Ensure this environment variable is set
        const s3Key = event.arguments.chat.s3Key;
        try {
            const command = new client_s3_1.GetObjectCommand({
                Bucket: bucketName,
                Key: s3Key,
            });
            const s3Response = await s3.send(command);
            if (s3Response.Body) {
                const bodyContents = await s3Response.Body.transformToString(); // Automatically convert to string
                previousCodeRun = bodyContents;
            }
            else {
                throw new Error('File content is empty or invalid.');
            }
        }
        catch (error) {
            console.error('Error fetching S3 file:', error);
            throw new Error('Failed to retrieve S3 file.');
        }
    }
    const message1 = `${previousCodeRun} \nBased on the code and the following prompt, tell us what inputs we will need to add to accomadate, do not rewrite the code. ${event.arguments.chat.message}`;
    const response1 = await (0, gpt_1.completeChatFromPrompt)(message1, API_1.ChatFocus.All, user, false, API_1.ChatType.SimulationPreExpansion, []);
    const parsedSimulationPreExpansionResponse = JSON.parse(response1 || '');
    await (0, gpt_1.sendChatToUI)(user, 'SimulationPreExpansionMessage', JSON.stringify({
        __typename: 'FinancialSimulationPreExpansion',
        inputs: parsedSimulationPreExpansionResponse.inputKeys,
        description: parsedSimulationPreExpansionResponse.highLevelDescriptionOfIdeaWithoutMentioningCode,
        title: parsedSimulationPreExpansionResponse.title,
    }), true, user + Date.now().toString());
    const message = `${previousCodeRun} Expand the script, do not rename the function, the input set in body will now include the keys ${parsedSimulationPreExpansionResponse.inputKeys
        .map((el) => `${el.name}: ${el.defaultValue}, `)
        .join(', ')} All users are in Canada and use the registered Accounts: FHSA, RSPs, TFSAs. Output the updated script as runnable code`;
    const response = await (0, gpt_1.completeChatFromPrompt)(message, API_1.ChatFocus.All, user, false, API_1.ChatType.SimulationExpansion, []);
    const recommentations = JSON.parse(response || '');
    const newCode = recommentations.newCode;
    const newFileKey = user + '-' + Math.floor(Math.random() * 1000000);
    await (0, gpt_1.sendChatToUI)(user, 'SimulationExpansionMessage', JSON.stringify({
        __typename: 'FinancialSimulationExpansion',
        s3Key: newFileKey,
    }), true, user + Date.now().toString());
    try {
        // Upload new code to S3
        const putCommand = new client_s3_1.PutObjectCommand({
            Bucket: process.env.S3_BUCKET,
            Key: newFileKey,
            Body: newCode,
            ContentType: 'application/javascript', // Assuming it's JS code
        });
        await s3.send(putCommand);
        console.log(`New code uploaded to S3: ${newFileKey}`);
    }
    catch (error) {
        console.error('Error uploading new code to S3:', error);
        throw new Error('Failed to upload new code to S3.');
    }
    console.debug('Got', recommentations, ' From GPT');
    return {
        __typename: 'FinancialSimulationExpansion',
        s3Key: newFileKey,
    };
};
exports.getFinancialSimulationExpansion = getFinancialSimulationExpansion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0RmluYW5jaWFsU2ltdWxhdGlvbkV4cGFuc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9nZXRGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLCtCQUFvRztBQUNwRywrQkFLYztBQUNkLGtEQUFpRjtBQUNqRixpREFBNkM7QUFDN0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQTtBQUVwRCxNQUFNLCtCQUErQixHQUFxRSxLQUFLLEVBQ2xILEtBQWdFLEVBQ2hFLE9BQWdCLEVBQ2xCLEVBQUU7SUFDQSxNQUFNLElBQUksR0FBSSxLQUFLLENBQUMsUUFBbUMsRUFBRSxRQUFRLENBQUE7SUFFakUsSUFBSSxlQUFlLEdBQUcsMkJBQVksQ0FBQTtJQUNsQyxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzdCLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFBLENBQUMsMENBQTBDO1FBQ25GLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtRQUV4QyxJQUFJLENBQUM7WUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLDRCQUFnQixDQUFDO2dCQUNqQyxNQUFNLEVBQUUsVUFBVztnQkFDbkIsR0FBRyxFQUFFLEtBQUs7YUFDYixDQUFDLENBQUE7WUFFRixNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFFekMsSUFBSSxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xCLE1BQU0sWUFBWSxHQUFHLE1BQU0sVUFBVSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFBLENBQUMs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QUMsNEJBQTRCLFVBQVUsRUFBRSxDQUFDLENBQUE7SUFDekQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ3ZELE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtJQUN2RCxDQUFDO0lBRUQsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQ2xELE9BQU87UUFDSCxVQUFVLEVBQUUsOEJBQThCO1FBQzFDLEtBQUssRUFBRSxVQUFVO0tBQ3BCLENBQUE7QUFDTCxDQUFDLENBQUE7QUEvRlksUUFBQSwrQkFBK0IsbUNBK0YzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcFN5bmNJZGVudGl0eUNvZ25pdG8sIEFwcFN5bmNSZXNvbHZlckV2ZW50LCBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyLCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7IENoYXRGb2N1cywgQ2hhdFR5cGUsIEV4cGFuZEZpbmFuY2lhbFNpbXVsYXRpb24sIEZpbmFuY2lhbFNpbXVsYXRpb25FeHBhbnNpb24gfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7XG4gICAgY29tcGxldGVDaGF0RnJvbVByb21wdCxcbiAgICBzZW5kQ2hhdFRvVUksXG4gICAgU2ltdWxhdGlvbkV4cGFuc2lvblJlc3BvbnNlSW50ZXJmYWNlLFxuICAgIFNpbXVsYXRpb25QcmVFeHBhbnNpb25SZXNwb25zZUludGVyZmFjZSxcbn0gZnJvbSAnLi9ncHQnXG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMydcbmltcG9ydCB7IHByZXZpb3VzQ29kZSB9IGZyb20gJy4vc3RvY2tQcm9tcHRzJ1xuY29uc3QgczMgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSlcblxuZXhwb3J0IGNvbnN0IGdldEZpbmFuY2lhbFNpbXVsYXRpb25FeHBhbnNpb246IEFwcFN5bmNSZXNvbHZlckhhbmRsZXI8YW55LCBGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uIHwgdm9pZD4gPSBhc3luYyAoXG4gICAgZXZlbnQ6IEFwcFN5bmNSZXNvbHZlckV2ZW50PHsgY2hhdDogRXhwYW5kRmluYW5jaWFsU2ltdWxhdGlvbiB9PixcbiAgICBjb250ZXh0OiBDb250ZXh0XG4pID0+IHtcbiAgICBjb25zdCB1c2VyID0gKGV2ZW50LmlkZW50aXR5IGFzIEFwcFN5bmNJZGVudGl0eUNvZ25pdG8pPy51c2VybmFtZVxuXG4gICAgbGV0IHByZXZpb3VzQ29kZVJ1biA9IHByZXZpb3VzQ29kZVxuICAgIGlmIChldmVudC5hcmd1bWVudHMuY2hhdC5zM0tleSkge1xuICAgICAgICBjb25zdCBidWNrZXROYW1lID0gcHJvY2Vzcy5lbnYuUzNfQlVDS0VUIC8vIEVuc3VyZSB0aGlzIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIHNldFxuICAgICAgICBjb25zdCBzM0tleSA9IGV2ZW50LmFyZ3VtZW50cy5jaGF0LnMzS2V5XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgICAgICAgICAgQnVja2V0OiBidWNrZXROYW1lISxcbiAgICAgICAgICAgICAgICBLZXk6IHMzS2V5LFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgY29uc3QgczNSZXNwb25zZSA9IGF3YWl0IHMzLnNlbmQoY29tbWFuZClcblxuICAgICAgICAgICAgaWYgKHMzUmVzcG9uc2UuQm9keSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGJvZHlDb250ZW50cyA9IGF3YWl0IHMzUmVzcG9uc2UuQm9keS50cmFuc2Zvcm1Ub1N0cmluZygpIC8vIEF1dG9tYXRpY2FsbHkgY29udmVydCB0byBzdHJpbmdcbiAgICAgICAgICAgICAgICBwcmV2aW91c0NvZGVSdW4gPSBib2R5Q29udGVudHNcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGaWxlIGNvbnRlbnQgaXMgZW1wdHkgb3IgaW52YWxpZC4nKVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgUzMgZmlsZTonLCBlcnJvcilcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIFMzIGZpbGUuJylcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBtZXNzYWdlMSA9IGAke3ByZXZpb3VzQ29kZVJ1bn0gXFxuQmFzZWQgb24gdGhlIGNvZGUgYW5kIHRoZSBmb2xsb3dpbmcgcHJvbXB0LCB0ZWxsIHVzIHdoYXQgaW5wdXRzIHdlIHdpbGwgbmVlZCB0byBhZGQgdG8gYWNjb21hZGF0ZSwgZG8gbm90IHJld3JpdGUgdGhlIGNvZGUuICR7ZXZlbnQuYXJndW1lbnRzLmNoYXQubWVzc2FnZX1gXG4gICAgY29uc3QgcmVzcG9uc2UxID0gYXdhaXQgY29tcGxldGVDaGF0RnJvbVByb21wdChcbiAgICAgICAgbWVzc2FnZTEsXG4gICAgICAgIENoYXRGb2N1cy5BbGwsXG4gICAgICAgIHVzZXIsXG4gICAgICAgIGZhbHNlLFxuICAgICAgICBDaGF0VHlwZS5TaW11bGF0aW9uUHJlRXhwYW5zaW9uLFxuICAgICAgICBbXVxuICAgIClcbiAgICBjb25zdCBwYXJzZWRTaW11bGF0aW9uUHJlRXhwYW5zaW9uUmVzcG9uc2UgPSBKU09OLnBhcnNlKHJlc3BvbnNlMSB8fCAnJykgYXMgU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlSW50ZXJmYWNlXG5cbiAgICBhd2FpdCBzZW5kQ2hhdFRvVUkoXG4gICAgICAgIHVzZXIsXG4gICAgICAgICdTaW11bGF0aW9uUHJlRXhwYW5zaW9uTWVzc2FnZScsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIF9fdHlwZW5hbWU6ICdGaW5hbmNpYWxTaW11bGF0aW9uUHJlRXhwYW5zaW9uJyxcbiAgICAgICAgICAgIGlucHV0czogcGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLmlucHV0S2V5cyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBwYXJzZWRTaW11bGF0aW9uUHJlRXhwYW5zaW9uUmVzcG9uc2UuaGlnaExldmVsRGVzY3JpcHRpb25PZklkZWFXaXRob3V0TWVudGlvbmluZ0NvZGUsXG4gICAgICAgICAgICB0aXRsZTogcGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLnRpdGxlLFxuICAgICAgICB9KSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgdXNlciArIERhdGUubm93KCkudG9TdHJpbmcoKVxuICAgIClcbiAgICBjb25zdCBtZXNzYWdlID0gYCR7cHJldmlvdXNDb2RlUnVufSBFeHBhbmQgdGhlIHNjcmlwdCwgZG8gbm90IHJlbmFtZSB0aGUgZnVuY3Rpb24sIHRoZSBpbnB1dCBzZXQgaW4gYm9keSB3aWxsIG5vdyBpbmNsdWRlIHRoZSBrZXlzICR7cGFyc2VkU2ltdWxhdGlvblByZUV4cGFuc2lvblJlc3BvbnNlLmlucHV0S2V5c1xuICAgICAgICAubWFwKChlbCkgPT4gYCR7ZWwubmFtZX06ICR7ZWwuZGVmYXVsdFZhbHVlfSwgYClcbiAgICAgICAgLmpvaW4oXG4gICAgICAgICAgICAnLCAnXG4gICAgICAgICl9IEFsbCB1c2VycyBhcmUgaW4gQ2FuYWRhIGFuZCB1c2UgdGhlIHJlZ2lzdGVyZWQgQWNjb3VudHM6IEZIU0EsIFJTUHMsIFRGU0FzLiBPdXRwdXQgdGhlIHVwZGF0ZWQgc2NyaXB0IGFzIHJ1bm5hYmxlIGNvZGVgXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0KG1lc3NhZ2UsIENoYXRGb2N1cy5BbGwsIHVzZXIsIGZhbHNlLCBDaGF0VHlwZS5TaW11bGF0aW9uRXhwYW5zaW9uLCBbXSlcbiAgICBjb25zdCByZWNvbW1lbnRhdGlvbnMgPSBKU09OLnBhcnNlKHJlc3BvbnNlIHx8ICcnKSBhcyBTaW11bGF0aW9uRXhwYW5zaW9uUmVzcG9uc2VJbnRlcmZhY2VcbiAgICBjb25zdCBuZXdDb2RlID0gcmVjb21tZW50YXRpb25zLm5ld0NvZGVcbiAgICBjb25zdCBuZXdGaWxlS2V5ID0gdXNlciArICctJyArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwMDApXG5cbiAgICBhd2FpdCBzZW5kQ2hhdFRvVUkoXG4gICAgICAgIHVzZXIsXG4gICAgICAgICdTaW11bGF0aW9uRXhwYW5zaW9uTWVzc2FnZScsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIF9fdHlwZW5hbWU6ICdGaW5hbmNpYWxTaW11bGF0aW9uRXhwYW5zaW9uJyxcbiAgICAgICAgICAgIHMzS2V5OiBuZXdGaWxlS2V5LFxuICAgICAgICB9KSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgdXNlciArIERhdGUubm93KCkudG9TdHJpbmcoKVxuICAgIClcbiAgICB0cnkge1xuICAgICAgICAvLyBVcGxvYWQgbmV3IGNvZGUgdG8gUzNcbiAgICAgICAgY29uc3QgcHV0Q29tbWFuZCA9IG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxuICAgICAgICAgICAgS2V5OiBuZXdGaWxlS2V5LFxuICAgICAgICAgICAgQm9keTogbmV3Q29kZSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vamF2YXNjcmlwdCcsIC8vIEFzc3VtaW5nIGl0J3MgSlMgY29kZVxuICAgICAgICB9KVxuXG4gICAgICAgIGF3YWl0IHMzLnNlbmQocHV0Q29tbWFuZClcblxuICAgICAgICBjb25zb2xlLmxvZyhgTmV3IGNvZGUgdXBsb2FkZWQgdG8gUzM6ICR7bmV3RmlsZUtleX1gKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVwbG9hZGluZyBuZXcgY29kZSB0byBTMzonLCBlcnJvcilcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gdXBsb2FkIG5ldyBjb2RlIHRvIFMzLicpXG4gICAgfVxuXG4gICAgY29uc29sZS5kZWJ1ZygnR290JywgcmVjb21tZW50YXRpb25zLCAnIEZyb20gR1BUJylcbiAgICByZXR1cm4ge1xuICAgICAgICBfX3R5cGVuYW1lOiAnRmluYW5jaWFsU2ltdWxhdGlvbkV4cGFuc2lvbicsXG4gICAgICAgIHMzS2V5OiBuZXdGaWxlS2V5LFxuICAgIH1cbn1cbiJdfQ==