"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseUsingFinancialContext = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const CacheEntity_1 = require("./mappers/CacheEntity");
const Encryption_1 = require("./queries/Encryption");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION'];
const mapOfInformationOptionToKey = {
    BANKACCOUNTS: 'ACCOUNT',
    INVESTMENTS: 'SECURITY',
    TRANSACTIONS: 'TRANSACTION',
};
const mapOfCacheTypeToExpiry = {
    [API_1.CacheType.InvestmentAnalysis]: 60 * 60 * 1000,
    [API_1.CacheType.PortfolioAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockNews]: 60 * 60 * 1000,
};
const getResponseUsingFinancialContext = async (event, context) => {
    console.info('Get response for', event);
    let neededInfo = { optionsForInformation: [] };
    let dateRangeResponse;
    if (event.arguments.chat.shouldRagFetch) {
        const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
        const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
        await Promise.all([informationNeeded, dateRange]);
        neededInfo = JSON.parse((await informationNeeded).content || '');
        dateRangeResponse = JSON.parse((await dateRange).content || '');
    }
    if (event.arguments.chat.cacheIdentifiers) {
        const cacheChecks = await Promise.all(event.arguments.chat.cacheIdentifiers.map((id) => {
            return client.send((0, Entities_1.GetCacheEntity)({
                id: id.key || '',
                expiresAt: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
            }));
        }));
        const itemHits = cacheChecks.flatMap((el) => el.Items ?? []);
        if (itemHits.length) {
            return {
                response: itemHits.map(CacheEntity_1.mapDdbResponseToCacheEntity).join('') || '',
                __typename: 'ChatResponse',
            };
        }
    }
    if (event.arguments.chat.chatFocus === API_1.ChatFocus.Investment &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.INVESTMENTS)) {
        neededInfo.optionsForInformation.push('INVESTMENTS');
    }
    console.info('Context: ', context);
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    const user = event.identity?.username;
    let tupleOfTypeToElements;
    tupleOfTypeToElements = await Promise.all(neededInfo.optionsForInformation.map(async (option) => {
        const entityName = mapOfInformationOptionToKey[option].toString();
        return [
            option,
            await client.send((0, Entities_1.GetEntities)({
                username: user || '',
                id: event.arguments.chat.accountId || '',
                dateRange: entityName in dateSupportedFiltering ? dateRangeResponse : undefined,
                entityName: entityName,
            })),
        ];
    }));
    /** Get the contextual data */
    const ddbResponses = await Promise.all(tupleOfTypeToElements.map(async (tuple) => {
        const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(tuple[1]?.Items ?? []);
        if (tuple[0].toString() === 'INVESTMENTS') {
            const mappedData = await (0, Security_1.mapSecuritiesToJoinedData)(decryptedItems);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (tuple[0].toString() === 'TRANSACTIONS') {
            return ('\nTranasactions:\n' +
                decryptedItems.map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (tuple[0].toString() === 'BANKACCOUNTS') {
            return '\nAccounts:\n' + decryptedItems.map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join('');
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + tuple[0]);
        }
    }));
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus, user, event.arguments.chat.requiresLiveData ?? false, event.arguments.chat.chatType ?? API_1.ChatType.Regular);
    event.arguments.chat.cacheIdentifiers?.map((id) => {
        client.send((0, Entities_1.PutCacheEntity)({
            id: id.key || '',
            expiresAt: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
        }, {}));
    });
    return {
        response: response || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStFO0FBQy9FLCtCQUF3SDtBQUN4SCw4REFBNkU7QUFDN0UsaURBQWdGO0FBQ2hGLGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLHVEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUE7QUFFN0QsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBRTlDLE1BQU0sMkJBQTJCLEdBQStCO0lBQzVELFlBQVksRUFBRSxTQUFTO0lBQ3ZCLFdBQVcsRUFBRSxVQUFVO0lBQ3ZCLFlBQVksRUFBRSxhQUFhO0NBQzlCLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUE4QjtJQUN0RCxDQUFDLGVBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtJQUM5QyxDQUFDLGVBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUU7SUFDbEQsQ0FBQyxlQUFTLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsRUFBRTtJQUM5QyxDQUFDLGVBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUk7Q0FDeEMsQ0FBQTtBQUVNLE1BQU0sZ0NBQWdDLEdBQThDLEtBQUssRUFDNUYsS0FBZ0QsRUFDaEQsT0FBZ0IsRUFDbEIsRUFBRTtJQUNBLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENB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Q0FDUCxJQUFBLHlCQUFjLEVBQ1Y7WUFDSSxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxzQkFBc0IsQ0FBQyxFQUFFLENBQUMsU0FBVSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTtTQUNoRSxFQUNELEVBQUUsQ0FDTCxDQUNKLENBQUE7SUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU87UUFDSCxRQUFRLEVBQUUsUUFBUSxJQUFJLEVBQUU7UUFDeEIsVUFBVSxFQUFFLGNBQWM7S0FDN0IsQ0FBQTtBQUNMLENBQUMsQ0FBQTtBQTNHWSxRQUFBLGdDQUFnQyxvQ0EyRzVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwU3luY0lkZW50aXR5Q29nbml0bywgQXBwU3luY1Jlc29sdmVyRXZlbnQsIEFwcFN5bmNSZXNvbHZlckhhbmRsZXIsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJ1xuaW1wb3J0IHsgQ2hhdEZvY3VzLCBDaGF0UXVlcnksIENoYXRSZXNwb25zZSwgQ2hhdFR5cGUsIENhY2hlVHlwZSB9IGZyb20gJy4vQVBJJ1xuaW1wb3J0IHsgSW5mb3JtYXRpb25PcHRpb25zLCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0LCBnZXREYXRlUmFuZ2VGcm9tTW9kZWwsIGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsIH0gZnJvbSAnLi9ncHQnXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUXVlcnlDb21tYW5kT3V0cHV0IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgR2V0Q2FjaGVFbnRpdHksIEdldEVudGl0aWVzLCBQdXRDYWNoZUVudGl0eSB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IG1hcEpvaW50RGF0YVRvQ2hhdElucHV0LCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhIH0gZnJvbSAnLi9tYXBwZXJzL1NlY3VyaXR5J1xuaW1wb3J0IHsgbWFwQWNjb3VudFRvQ2hhdElucHV0LCBtYXBEeW5hbW9EQlRvQWNjb3VudCB9IGZyb20gJy4vbWFwcGVycy9BY2NvdW50cydcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiwgbWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5pbXBvcnQgeyBtYXBEZGJSZXNwb25zZVRvQ2FjaGVFbnRpdHkgfSBmcm9tICcuL21hcHBlcnMvQ2FjaGVFbnRpdHknXG5pbXBvcnQgeyBkZWNyeXB0SXRlbXNJbkJhdGNoZXMgfSBmcm9tICcuL3F1ZXJpZXMvRW5jcnlwdGlvbidcbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuY29uc3QgZGF0ZVN1cHBvcnRlZEZpbHRlcmluZyA9IFsnVFJBTlNBQ1RJT04nXVxuZXhwb3J0IHR5cGUgRW50aXR5TmFtZSA9ICdTRUNVUklUWScgfCAnVFJBTlNBQ1RJT04nIHwgJ0FDQ09VTlQnXG5jb25zdCBtYXBPZkluZm9ybWF0aW9uT3B0aW9uVG9LZXk6IFJlY29yZDxzdHJpbmcsIEVudGl0eU5hbWU+ID0ge1xuICAgIEJBTktBQ0NPVU5UUzogJ0FDQ09VTlQnLFxuICAgIElOVkVTVE1FTlRTOiAnU0VDVVJJVFknLFxuICAgIFRSQU5TQUNUSU9OUzogJ1RSQU5TQUNUSU9OJyxcbn1cblxuY29uc3QgbWFwT2ZDYWNoZVR5cGVUb0V4cGlyeTogUmVjb3JkPENhY2hlVHlwZSwgbnVtYmVyPiA9IHtcbiAgICBbQ2FjaGVUeXBlLkludmVzdG1lbnRBbmFseXNpc106IDYwICogNjAgKiAxMDAwLFxuICAgIFtDYWNoZVR5cGUuUG9ydGZvbGlvQW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCAqIDI0LFxuICAgIFtDYWNoZVR5cGUuU3RvY2tBbmFseXNpc106IDYwICogNjAgKiAxMDAwICogMjQsXG4gICAgW0NhY2hlVHlwZS5TdG9ja05ld3NdOiA2MCAqIDYwICogMTAwMCxcbn1cblxuZXhwb3J0IGNvbnN0IGdldFJlc3BvbnNlVXNpbmdGaW5hbmNpYWxDb250ZXh0OiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgQ2hhdFJlc3BvbnNlPiA9IGFzeW5jIChcbiAgICBldmVudDogQXBwU3luY1Jlc29sdmVyRXZlbnQ8eyBjaGF0OiBDaGF0UXVlcnkgfT4sXG4gICAgY29udGV4dDogQ29udGV4dFxuKSA9PiB7XG4gICAgY29uc29sZS5pbmZvKCdHZXQgcmVzcG9uc2UgZm9yJywgZXZlbnQpXG4gICAgbGV0IG5lZWRlZEluZm86IHsgb3B0aW9uc0ZvckluZm9ybWF0aW9uOiBJbmZvcm1hdGlvbk9wdGlvbnNbXSB9ID0geyBvcHRpb25zRm9ySW5mb3JtYXRpb246IFtdIH1cbiAgICBsZXQgZGF0ZVJhbmdlUmVzcG9uc2U6IGFueVxuICAgIGlmIChldmVudC5hcmd1bWVudHMuY2hhdC5zaG91bGRSYWdGZXRjaCkge1xuICAgICAgICBjb25zdCBpbmZvcm1hdGlvbk5lZWRlZCA9IGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsKGV2ZW50LmFyZ3VtZW50cy5jaGF0LnByb21wdCB8fCAnJylcbiAgICAgICAgY29uc3QgZGF0ZVJhbmdlID0gZ2V0RGF0ZVJhbmdlRnJvbU1vZGVsKGV2ZW50LmFyZ3VtZW50cy5jaGF0LnByb21wdCB8fCAnJylcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW2luZm9ybWF0aW9uTmVlZGVkLCBkYXRlUmFuZ2VdKVxuICAgICAgICBuZWVkZWRJbmZvID0gSlNPTi5wYXJzZSgoYXdhaXQgaW5mb3JtYXRpb25OZWVkZWQpLmNvbnRlbnQgfHwgJycpXG4gICAgICAgIGRhdGVSYW5nZVJlc3BvbnNlID0gSlNPTi5wYXJzZSgoYXdhaXQgZGF0ZVJhbmdlKS5jb250ZW50IHx8ICcnKVxuICAgIH1cblxuICAgIGlmIChldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlQ2hlY2tzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzLm1hcCgoaWQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldENhY2hlRW50aXR5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZC5rZXkgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBpcmVzQXQ6IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnlbaWQuY2FjaGVUeXBlIV0gKyBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgY29uc3QgaXRlbUhpdHMgPSBjYWNoZUNoZWNrcy5mbGF0TWFwKChlbCkgPT4gZWwuSXRlbXMgPz8gW10pXG4gICAgICAgIGlmIChpdGVtSGl0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2U6IGl0ZW1IaXRzLm1hcChtYXBEZGJSZXNwb25zZVRvQ2FjaGVFbnRpdHkpLmpvaW4oJycpIHx8ICcnLFxuICAgICAgICAgICAgICAgIF9fdHlwZW5hbWU6ICdDaGF0UmVzcG9uc2UnLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdEZvY3VzID09PSBDaGF0Rm9jdXMuSW52ZXN0bWVudCAmJlxuICAgICAgICAhbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24uZmluZCgoZWwpID0+IGVsID09PSBJbmZvcm1hdGlvbk9wdGlvbnMuSU5WRVNUTUVOVFMpXG4gICAgKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLnB1c2goJ0lOVkVTVE1FTlRTJyBhcyBhbnkpXG4gICAgfVxuXG4gICAgY29uc29sZS5pbmZvKCdDb250ZXh0OiAnLCBjb250ZXh0KVxuICAgIGNvbnNvbGUuaW5mbygnTmVlZGVkIGluZm8gJywgbmVlZGVkSW5mbylcbiAgICBjb25zb2xlLmluZm8oJ0RhdGUgcmFuZ2U6ICcsIGRhdGVSYW5nZVJlc3BvbnNlKVxuICAgIGNvbnN0IHVzZXIgPSAoZXZlbnQuaWRlbnRpdHkgYXMgQXBwU3luY0lkZW50aXR5Q29nbml0byk/LnVzZXJuYW1lXG4gICAgbGV0IHR1cGxlT2ZUeXBlVG9FbGVtZW50czogW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgdHVwbGVPZlR5cGVUb0VsZW1lbnRzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLm1hcChhc3luYyAob3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gbWFwT2ZJbmZvcm1hdGlvbk9wdGlvblRvS2V5W29wdGlvbl0udG9TdHJpbmcoKVxuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBvcHRpb24sXG4gICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmFjY291bnRJZCB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVSYW5nZTogZW50aXR5TmFtZSBpbiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nID8gZGF0ZVJhbmdlUmVzcG9uc2UgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lOiBlbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pXG4gICAgKVxuXG4gICAgLyoqIEdldCB0aGUgY29udGV4dHVhbCBkYXRhICovXG4gICAgY29uc3QgZGRiUmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHR1cGxlT2ZUeXBlVG9FbGVtZW50cy5tYXAoYXN5bmMgKHR1cGxlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWRJdGVtcyA9IGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyh0dXBsZVsxXT8uSXRlbXMgPz8gW10pXG4gICAgICAgICAgICBpZiAodHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ0lOVkVTVE1FTlRTJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hcHBlZERhdGEgPSBhd2FpdCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhKGRlY3J5cHRlZEl0ZW1zKVxuICAgICAgICAgICAgICAgIHJldHVybiAnXFxuSW52ZXN0bWVudHM6XFxuJyArIG1hcEpvaW50RGF0YVRvQ2hhdElucHV0KG1hcHBlZERhdGEpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdUUkFOU0FDVElPTlMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgJ1xcblRyYW5hc2FjdGlvbnM6XFxuJyArXG4gICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEl0ZW1zLm1hcChtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24pLm1hcChtYXBUcmFuc2FjdGlvblRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ0JBTktBQ0NPVU5UUycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1xcbkFjY291bnRzOlxcbicgKyBkZWNyeXB0ZWRJdGVtcy5tYXAobWFwRHluYW1vREJUb0FjY291bnQpLm1hcChtYXBBY2NvdW50VG9DaGF0SW5wdXQpLmpvaW4oJycpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVU5SRUNPR05JWkVEIE9QVElPTiAnICsgdHVwbGVbMF0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgKVxuICAgIGNvbnN0IHJhZ0RhdGEgPSBkZGJSZXNwb25zZXMuam9pbignJylcbiAgICBjb25zb2xlLmluZm8oJ0ZJTkFMIFJBRyBEQVRBOiAnLCByYWdEYXRhKVxuICAgIGNvbnN0IHsgcHJvbXB0IH0gPSBldmVudC5hcmd1bWVudHMuY2hhdFxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY29tcGxldGVDaGF0RnJvbVByb21wdChcbiAgICAgICAgcHJvbXB0ICsgJyBVc2UgdGhpcyBkYXRhIGZvciB5b3VyIGFuc3dlcjogJyArIHJhZ0RhdGEgfHwgJycsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyxcbiAgICAgICAgdXNlcixcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQucmVxdWlyZXNMaXZlRGF0YSA/PyBmYWxzZSxcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdFR5cGUgPz8gQ2hhdFR5cGUuUmVndWxhclxuICAgIClcbiAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzPy5tYXAoKGlkKSA9PiB7XG4gICAgICAgIGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgUHV0Q2FjaGVFbnRpdHkoXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBpZDogaWQua2V5IHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBleHBpcmVzQXQ6IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnlbaWQuY2FjaGVUeXBlIV0gKyBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge31cbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgIH0pXG4gICAgcmV0dXJuIHtcbiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlIHx8ICcnLFxuICAgICAgICBfX3R5cGVuYW1lOiAnQ2hhdFJlc3BvbnNlJyxcbiAgICB9XG59XG4iXX0=