"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseUsingFinancialContext = void 0;
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION'];
const getResponseUsingFinancialContext = async (event, context) => {
    console.debug('Get response for', event);
    const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
    const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
    await Promise.all([informationNeeded, dateRange]);
    const neededInfo = JSON.parse((await informationNeeded).content || '');
    const dateRangeResponse = JSON.parse((await dateRange).content || '');
    const user = context.identity?.cognitoIdentityId;
    let tupleOfTypeToElements;
    tupleOfTypeToElements = await Promise.all(neededInfo.informationOptions.map(async (option) => {
        return [
            option,
            await client.send((0, Entities_1.GetEntities)({
                username: user || '',
                id: event.arguments.chat.id,
                dateRange: option in dateSupportedFiltering ? dateRangeResponse : undefined,
                entityName: option,
            })),
        ];
    }));
    const ddbResponses = tupleOfTypeToElements.map((tuple) => {
        if (tuple[0] === gpt_1.InformationOptions.SECURITY) {
            const mappedData = (0, Security_1.mapSecuritiesToJoinedData)(tuple[1].Items ?? []);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (tuple[0] === gpt_1.InformationOptions.TRANSACTION) {
            return ('\nTranasactions:\n' +
                (tuple[1].Items ?? []).map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (tuple[0] === gpt_1.InformationOptions.ACCOUNT) {
            return ('\nAccounts:\n' + (tuple[1].Items ?? []).map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join(''));
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + tuple[0]);
        }
    });
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus);
    return {
        response: response.content || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsK0JBT2M7QUFDZCw4REFBMkY7QUFDM0YsaURBQWdEO0FBQ2hELGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUN2QyxNQUFNLGdDQUFnQyxHQUE4QyxLQUFLLEVBQzVGLEtBQWdELEVBQ2hELE9BQWdCLEVBQ2xCLEVBQUU7SUFDQSxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ3hDLE1BQU0saUJBQWlCLEdBQUcsSUFBQSxtQ0FBNkIsRUFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUE7SUFDMUYsTUFBTSxTQUFTLEdBQUcsSUFBQSwyQkFBcUIsRUFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUE7SUFDMUUsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsaUJBQWlCLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQTtJQUNqRCxNQUFNLFVBQVUsR0FBK0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0saUJBQWlCLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUE7SUFDbEcsTUFBTSxpQkFBaUIsR0FBc0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sU0FBUyxDQUFDLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FB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dCB7IEFwcFN5bmNSZXNvbHZlckV2ZW50LCBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyLCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7IENoYXRRdWVyeSwgQ2hhdFJlc3BvbnNlIH0gZnJvbSAnLi9BUEknXG5pbXBvcnQge1xuICAgIERhdGFSYW5nZVJlc3BvbnNlLFxuICAgIEluZm9ybWF0aW9uT3B0aW9ucyxcbiAgICBJbmZvcm1hdGlvbk9wdGlvbnNSZXNwb25zZSxcbiAgICBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0LFxuICAgIGdldERhdGVSYW5nZUZyb21Nb2RlbCxcbiAgICBnZXROZWVkZWRJbmZvcm1hdGlvbkZyb21Nb2RlbCxcbn0gZnJvbSAnLi9ncHQnXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUXVlcnlDb21tYW5kLCBRdWVyeUNvbW1hbmRPdXRwdXQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBHZXRFbnRpdGllcyB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IG1hcEpvaW50RGF0YVRvQ2hhdElucHV0LCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhIH0gZnJvbSAnLi9tYXBwZXJzL1NlY3VyaXR5J1xuaW1wb3J0IHsgbWFwQWNjb3VudFRvQ2hhdElucHV0LCBtYXBEeW5hbW9EQlRvQWNjb3VudCB9IGZyb20gJy4vbWFwcGVycy9BY2NvdW50cydcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiwgbWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPSBbJ1RSQU5TQUNUSU9OJ11cbmV4cG9ydCBjb25zdCBnZXRSZXNwb25zZVVzaW5nRmluYW5jaWFsQ29udGV4dDogQXBwU3luY1Jlc29sdmVySGFuZGxlcjxhbnksIENoYXRSZXNwb25zZT4gPSBhc3luYyAoXG4gICAgZXZlbnQ6IEFwcFN5bmNSZXNvbHZlckV2ZW50PHsgY2hhdDogQ2hhdFF1ZXJ5IH0+LFxuICAgIGNvbnRleHQ6IENvbnRleHRcbikgPT4ge1xuICAgIGNvbnNvbGUuZGVidWcoJ0dldCByZXNwb25zZSBmb3InLCBldmVudClcbiAgICBjb25zdCBpbmZvcm1hdGlvbk5lZWRlZCA9IGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsKGV2ZW50LmFyZ3VtZW50cy5jaGF0LnByb21wdCB8fCAnJylcbiAgICBjb25zdCBkYXRlUmFuZ2UgPSBnZXREYXRlUmFuZ2VGcm9tTW9kZWwoZXZlbnQuYXJndW1lbnRzLmNoYXQucHJvbXB0IHx8ICcnKVxuICAgIGF3YWl0IFByb21pc2UuYWxsKFtpbmZvcm1hdGlvbk5lZWRlZCwgZGF0ZVJhbmdlXSlcbiAgICBjb25zdCBuZWVkZWRJbmZvOiBJbmZvcm1hdGlvbk9wdGlvbnNSZXNwb25zZSA9IEpTT04ucGFyc2UoKGF3YWl0IGluZm9ybWF0aW9uTmVlZGVkKS5jb250ZW50IHx8ICcnKVxuICAgIGNvbnN0IGRhdGVSYW5nZVJlc3BvbnNlOiBEYXRhUmFuZ2VSZXNwb25zZSA9IEpTT04ucGFyc2UoKGF3YWl0IGRhdGVSYW5nZSkuY29udGVudCB8fCAnJylcbiAgICBjb25zdCB1c2VyID0gY29udGV4dC5pZGVudGl0eT8uY29nbml0b0lkZW50aXR5SWRcbiAgICBsZXQgdHVwbGVPZlR5cGVUb0VsZW1lbnRzOiBbSW5mb3JtYXRpb25PcHRpb25zLCBRdWVyeUNvbW1hbmRPdXRwdXRdW11cbiAgICB0dXBsZU9mVHlwZVRvRWxlbWVudHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgbmVlZGVkSW5mby5pbmZvcm1hdGlvbk9wdGlvbnMubWFwKGFzeW5jIChvcHRpb24pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgb3B0aW9uLFxuICAgICAgICAgICAgICAgIGF3YWl0IGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICBHZXRFbnRpdGllcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdXNlciB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAoZXZlbnQuYXJndW1lbnRzLmNoYXQgYXMgYW55KS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVSYW5nZTogb3B0aW9uIGluIGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPyBkYXRlUmFuZ2VSZXNwb25zZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6IG9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXVxuICAgICAgICB9KVxuICAgIClcbiAgICBjb25zdCBkZGJSZXNwb25zZXMgPSB0dXBsZU9mVHlwZVRvRWxlbWVudHMubWFwKCh0dXBsZSkgPT4ge1xuICAgICAgICBpZiAodHVwbGVbMF0gPT09IEluZm9ybWF0aW9uT3B0aW9ucy5TRUNVUklUWSkge1xuICAgICAgICAgICAgY29uc3QgbWFwcGVkRGF0YSA9IG1hcFNlY3VyaXRpZXNUb0pvaW5lZERhdGEodHVwbGVbMV0uSXRlbXMgPz8gW10pXG4gICAgICAgICAgICByZXR1cm4gJ1xcbkludmVzdG1lbnRzOlxcbicgKyBtYXBKb2ludERhdGFUb0NoYXRJbnB1dChtYXBwZWREYXRhKVxuICAgICAgICB9IGVsc2UgaWYgKHR1cGxlWzBdID09PSBJbmZvcm1hdGlvbk9wdGlvbnMuVFJBTlNBQ1RJT04pIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgJ1xcblRyYW5hc2FjdGlvbnM6XFxuJyArXG4gICAgICAgICAgICAgICAgKHR1cGxlWzFdLkl0ZW1zID8/IFtdKS5tYXAobWFwRHluYW1vREJUb1RyYW5zYWN0aW9uKS5tYXAobWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCkuam9pbignJylcbiAgICAgICAgICAgIClcbiAgICAgICAgfSBlbHNlIGlmICh0dXBsZVswXSA9PT0gSW5mb3JtYXRpb25PcHRpb25zLkFDQ09VTlQpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgJ1xcbkFjY291bnRzOlxcbicgKyAodHVwbGVbMV0uSXRlbXMgPz8gW10pLm1hcChtYXBEeW5hbW9EQlRvQWNjb3VudCkubWFwKG1hcEFjY291bnRUb0NoYXRJbnB1dCkuam9pbignJylcbiAgICAgICAgICAgIClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVU5SRUNPR05JWkVEIE9QVElPTiAnICsgdHVwbGVbMF0pXG4gICAgICAgIH1cbiAgICB9KVxuICAgIGNvbnN0IHJhZ0RhdGEgPSBkZGJSZXNwb25zZXMuam9pbignJylcbiAgICBjb25zb2xlLmluZm8oJ0ZJTkFMIFJBRyBEQVRBOiAnLCByYWdEYXRhKVxuICAgIGNvbnN0IHsgcHJvbXB0IH0gPSBldmVudC5hcmd1bWVudHMuY2hhdFxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY29tcGxldGVDaGF0RnJvbVByb21wdChcbiAgICAgICAgcHJvbXB0ICsgJyBVc2UgdGhpcyBkYXRhIGZvciB5b3VyIGFuc3dlcjogJyArIHJhZ0RhdGEgfHwgJycsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1c1xuICAgIClcbiAgICByZXR1cm4ge1xuICAgICAgICByZXNwb25zZTogcmVzcG9uc2UuY29udGVudCB8fCAnJyxcbiAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgfVxufVxuIl19