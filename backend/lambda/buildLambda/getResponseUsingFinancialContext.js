"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCacheKey = exports.getResponseUsingFinancialContext = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const CacheEntity_1 = require("./mappers/CacheEntity");
const Encryption_1 = require("./queries/Encryption");
const MonthlySummary_1 = require("./mappers/MonthlySummary");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION', 'MONTHLYSUMMARY'];
const mapOfInformationOptionToKey = {
    ACCOUNTS: 'ACCOUNT',
    INVESTMENTS: 'SECURITY',
    TRANSACTIONS: 'TRANSACTION',
    MONTHLYSUMMARY: 'MONTHLYSUMMARY',
};
const mapOfCacheTypeToExpiry = {
    [API_1.CacheType.InvestmentAnalysis]: 60 * 60 * 1000 * 4,
    [API_1.CacheType.PortfolioAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockNews]: 60 * 60 * 1000 * 4,
    [API_1.CacheType.TransactionRecommendation]: 60 * 60 * 1000 * 24 * 5,
    [API_1.CacheType.GeneralRecommendation]: 60 * 60 * 1000 * 24,
};
const getResponseUsingFinancialContext = async (event, context) => {
    const user = event.identity?.username;
    console.info('Get response for', event);
    const maxAccounts = event.arguments.chat.accountIds?.slice(0, 10) ?? [];
    let neededInfo = { optionsForInformation: [] };
    let dateRangeResponse;
    if (!event.arguments.chat.doNotUseAdvancedRag &&
        !(event.arguments.chat.currentDateRange && event.arguments.chat.highLevelCategory) &&
        !event.arguments.chat.doNotUseAdvancedRag) {
        const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
        const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
        await Promise.all([informationNeeded, dateRange]);
        neededInfo = JSON.parse((await informationNeeded).content || '');
        dateRangeResponse = JSON.parse((await dateRange).content || '');
    }
    if (event.arguments.chat.cacheIdentifiers) {
        const cacheChecks = await Promise.all(event.arguments.chat.cacheIdentifiers.map((id) => {
            let cacheKey = (0, exports.getCacheKey)(user, id);
            return client.send((0, Entities_1.GetCacheEntity)({
                id: cacheKey || '',
                sk: id.cacheType?.toString() ?? '',
                expire_at: Date.now(),
            }));
        }));
        const itemHits = cacheChecks.flatMap((el) => el.Items ?? []);
        if (itemHits.length) {
            return {
                response: itemHits
                    .map(CacheEntity_1.mapDdbResponseToCacheEntity)
                    ?.map((el) => el.response)
                    .join('') || '',
                __typename: 'ChatResponse',
            };
        }
    }
    if (event.arguments.chat.chatFocus === API_1.ChatFocus.Investment &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.INVESTMENTS)) {
        neededInfo.optionsForInformation.push('INVESTMENTS');
    }
    else if ((event.arguments.chat.chatFocus === API_1.ChatFocus.Transaction ||
        event.arguments.chat.chatType === API_1.ChatType.TransactionRecommendation) &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.TRANSACTIONS)) {
        neededInfo.optionsForInformation.push('TRANSACTIONS');
    }
    if (event.arguments.chat.chatType === API_1.ChatType.GeneralRecommendation) {
        neededInfo.optionsForInformation = ['INVESTMENTS', 'ACCOUNTS', 'MONTHLYSUMMARY'];
    }
    if (neededInfo.optionsForInformation?.length === 0) {
        neededInfo.optionsForInformation = ['ACCOUNTS', 'MONTHLYSUMMARY'];
    }
    console.info('Context: ', context);
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    let tupleOfTypeToElements;
    tupleOfTypeToElements = (await Promise.all(neededInfo.optionsForInformation.map(async (option) => {
        const entityName = mapOfInformationOptionToKey[option].toString();
        return await Promise.all(entityName !== 'MONTHLYSUMMARY'
            ? maxAccounts?.map(async (accountId) => {
                return [
                    option,
                    await client.send((0, Entities_1.GetEntities)({
                        username: user || '',
                        id: accountId || '',
                        dateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? dateRangeResponse
                            : undefined,
                        entityName: entityName,
                        customDateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? event.arguments.chat?.currentDateRange?.map((el) => el ? parseInt(el) : undefined) ?? undefined
                            : undefined,
                        highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
                    })),
                ];
            }) ?? [option, undefined]
            : [
                [
                    option,
                    await client.send((0, Entities_1.GetEntities)({
                        username: user || '',
                        id: 'v0',
                        dateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? dateRangeResponse
                            : undefined,
                        entityName: entityName,
                        customDateRange: undefined,
                        highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
                    })),
                ],
            ]);
    }))).flatMap((el) => [...el]);
    console.info(tupleOfTypeToElements, 'good');
    /** Get the contextual data */
    const ddbResponses = await Promise.all(tupleOfTypeToElements.map(async (tuple) => {
        await tuple[0];
        const awaitedTuple = tuple;
        const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(awaitedTuple[1]?.Items ?? []);
        if (awaitedTuple[0].toString() === 'INVESTMENTS') {
            const mappedData = await (0, Security_1.mapSecuritiesToJoinedData)(decryptedItems);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (awaitedTuple[0].toString() === 'TRANSACTIONS') {
            return ('\nTranasactions:\n' +
                decryptedItems.map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (awaitedTuple[0].toString() === 'ACCOUNTS') {
            return '\nAccounts:\n' + decryptedItems.map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join('');
        }
        else if (awaitedTuple[0].toString() === 'MONTHLYSUMMARY') {
            return ('\nMonthly Spending:\n' +
                decryptedItems.map(MonthlySummary_1.mapDynamoDBToMonthlySummary).map(MonthlySummary_1.mapSpendingSummaryToChatInput).join(''));
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + awaitedTuple[0]);
        }
    }));
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus, user, event.arguments.chat.requiresLiveData ?? false, event.arguments.chat.chatType ?? API_1.ChatType.Regular);
    event.arguments.chat.cacheIdentifiers?.map((id) => {
        let cacheKey = (0, exports.getCacheKey)(user, id);
        client.send((0, Entities_1.PutCacheEntity)({
            id: cacheKey || '',
            expire_at: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
            sk: id.cacheType?.toString() ?? '',
        }, { response: { S: response } }));
    });
    return {
        response: response || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
const getCacheKey = (user, id) => {
    let cacheKey = id.key;
    if (id.cacheType === API_1.CacheType.InvestmentAnalysis ||
        id.cacheType === API_1.CacheType.PortfolioAnalysis ||
        id.cacheType === API_1.CacheType.TransactionRecommendation ||
        id.cacheType === API_1.CacheType.GeneralRecommendation) {
        cacheKey = user + id.key?.slice(0, 100);
    }
    return cacheKey;
};
exports.getCacheKey = getCacheKey;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStGO0FBQy9GLCtCQUF3SDtBQUN4SCw4REFBNkU7QUFDN0UsaURBQWdGO0FBQ2hGLGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLHVEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQsNkRBQXFHO0FBQ3JHLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtBQUVoRSxNQUFNLDJCQUEyQixHQUErQjtJQUM1RCxRQUFRLEVBQUUsU0FBUztJQUNuQixXQUFXLEVBQUUsVUFBVTtJQUN2QixZQUFZLEVBQUUsYUFBYTtJQUMzQixjQUFjLEVBQUUsZ0JBQWdCO0NBQ25DLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUE4QjtJQUN0RCxDQUFDLGVBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDbEQsQ0FBQyxlQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxFQUFFO0lBQ2xELENBQUMsZUFBUyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUU7SUFDOUMsQ0FBQyxlQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUN6QyxDQUFDLGVBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdB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QixDQUFDLEVBQUUsQ0FBQyxTQUFVLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzdELEVBQUUsRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7U0FDckMsRUFDRCxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUNoQyxDQUNKLENBQUE7SUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU87UUFDSCxRQUFRLEVBQUUsUUFBUSxJQUFJLEVBQUU7UUFDeEIsVUFBVSxFQUFFLGNBQWM7S0FDN0IsQ0FBQTtBQUNMLENBQUMsQ0FBQTtBQTlLWSxRQUFBLGdDQUFnQyxvQ0E4SzVDO0FBRU0sTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBa0IsRUFBRSxFQUFFO0lBQzVELElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUE7SUFDckIsSUFDSSxFQUFFLENBQUMsU0FBUyxLQUFLLGVBQVMsQ0FBQyxrQkFBa0I7UUFDN0MsRUFBRSxDQUFDLFNBQVMsS0FBSyxlQUFTLENBQUMsaUJBQWlCO1FBQzVDLEVBQUUsQ0FBQyxTQUFTLEtBQUssZUFBUyxDQUFDLHlCQUF5QjtRQUNwRCxFQUFFLENBQUMsU0FBUyxLQUFLLGVBQVMsQ0FBQyxxQkFBcUIsRUFDbEQsQ0FBQztRQUNDLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQzNDLENBQUM7SUFDRCxPQUFPLFFBQVEsQ0FBQTtBQUNuQixDQUFDLENBQUE7QUFYWSxRQUFBLFdBQVcsZUFXdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvLCBBcHBTeW5jUmVzb2x2ZXJFdmVudCwgQXBwU3luY1Jlc29sdmVySGFuZGxlciwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBDaGF0Rm9jdXMsIENoYXRRdWVyeSwgQ2hhdFJlc3BvbnNlLCBDaGF0VHlwZSwgQ2FjaGVUeXBlLCBDYWNoZUlkZW50aWZlciB9IGZyb20gJy4vQVBJJ1xuaW1wb3J0IHsgSW5mb3JtYXRpb25PcHRpb25zLCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0LCBnZXREYXRlUmFuZ2VGcm9tTW9kZWwsIGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsIH0gZnJvbSAnLi9ncHQnXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUXVlcnlDb21tYW5kT3V0cHV0IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgR2V0Q2FjaGVFbnRpdHksIEdldEVudGl0aWVzLCBQdXRDYWNoZUVudGl0eSB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IG1hcEpvaW50RGF0YVRvQ2hhdElucHV0LCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhIH0gZnJvbSAnLi9tYXBwZXJzL1NlY3VyaXR5J1xuaW1wb3J0IHsgbWFwQWNjb3VudFRvQ2hhdElucHV0LCBtYXBEeW5hbW9EQlRvQWNjb3VudCB9IGZyb20gJy4vbWFwcGVycy9BY2NvdW50cydcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiwgbWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5pbXBvcnQgeyBtYXBEZGJSZXNwb25zZVRvQ2FjaGVFbnRpdHkgfSBmcm9tICcuL21hcHBlcnMvQ2FjaGVFbnRpdHknXG5pbXBvcnQgeyBkZWNyeXB0SXRlbXNJbkJhdGNoZXMgfSBmcm9tICcuL3F1ZXJpZXMvRW5jcnlwdGlvbidcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9Nb250aGx5U3VtbWFyeSwgbWFwU3BlbmRpbmdTdW1tYXJ5VG9DaGF0SW5wdXQgfSBmcm9tICcuL21hcHBlcnMvTW9udGhseVN1bW1hcnknXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPSBbJ1RSQU5TQUNUSU9OJywgJ01PTlRITFlTVU1NQVJZJ11cbmV4cG9ydCB0eXBlIEVudGl0eU5hbWUgPSAnU0VDVVJJVFknIHwgJ1RSQU5TQUNUSU9OJyB8ICdBQ0NPVU5UJyB8ICdNT05USExZU1VNTUFSWSdcbmNvbnN0IG1hcE9mSW5mb3JtYXRpb25PcHRpb25Ub0tleTogUmVjb3JkPHN0cmluZywgRW50aXR5TmFtZT4gPSB7XG4gICAgQUNDT1VOVFM6ICdBQ0NPVU5UJyxcbiAgICBJTlZFU1RNRU5UUzogJ1NFQ1VSSVRZJyxcbiAgICBUUkFOU0FDVElPTlM6ICdUUkFOU0FDVElPTicsXG4gICAgTU9OVEhMWVNVTU1BUlk6ICdNT05USExZU1VNTUFSWScsXG59XG5cbmNvbnN0IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnk6IFJlY29yZDxDYWNoZVR5cGUsIG51bWJlcj4gPSB7XG4gICAgW0NhY2hlVHlwZS5JbnZlc3RtZW50QW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCAqIDQsXG4gICAgW0NhY2hlVHlwZS5Qb3J0Zm9saW9BbmFseXNpc106IDYwICogNjAgKiAxMDAwICogMjQsXG4gICAgW0NhY2hlVHlwZS5TdG9ja0FuYWx5c2lzXTogNjAgKiA2MCAqIDEwMDAgKiAyNCxcbiAgICBbQ2FjaGVUeXBlLlN0b2NrTmV3c106IDYwICogNjAgKiAxMDAwICogNCxcbiAgICBbQ2FjaGVUeXBlLlRyYW5zYWN0aW9uUmVjb21tZW5kYXRpb25dOiA2MCAqIDYwICogMTAwMCAqIDI0ICogNSxcbiAgICBbQ2FjaGVUeXBlLkdlbmVyYWxSZWNvbW1lbmRhdGlvbl06IDYwICogNjAgKiAxMDAwICogMjQsXG59XG5cbmV4cG9ydCBjb25zdCBnZXRSZXNwb25zZVVzaW5nRmluYW5jaWFsQ29udGV4dDogQXBwU3luY1Jlc29sdmVySGFuZGxlcjxhbnksIENoYXRSZXNwb25zZT4gPSBhc3luYyAoXG4gICAgZXZlbnQ6IEFwcFN5bmNSZXNvbHZlckV2ZW50PHsgY2hhdDogQ2hhdFF1ZXJ5IH0+LFxuICAgIGNvbnRleHQ6IENvbnRleHRcbikgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSAoZXZlbnQuaWRlbnRpdHkgYXMgQXBwU3luY0lkZW50aXR5Q29nbml0byk/LnVzZXJuYW1lXG4gICAgY29uc29sZS5pbmZvKCdHZXQgcmVzcG9uc2UgZm9yJywgZXZlbnQpXG4gICAgY29uc3QgbWF4QWNjb3VudHMgPSBldmVudC5hcmd1bWVudHMuY2hhdC5hY2NvdW50SWRzPy5zbGljZSgwLCAxMCkgPz8gW11cbiAgICBsZXQgbmVlZGVkSW5mbzogeyBvcHRpb25zRm9ySW5mb3JtYXRpb246IEluZm9ybWF0aW9uT3B0aW9uc1tdIH0gPSB7IG9wdGlvbnNGb3JJbmZvcm1hdGlvbjogW10gfVxuICAgIGxldCBkYXRlUmFuZ2VSZXNwb25zZTogYW55XG4gICAgaWYgKFxuICAgICAgICAhZXZlbnQuYXJndW1lbnRzLmNoYXQuZG9Ob3RVc2VBZHZhbmNlZFJhZyAmJlxuICAgICAgICAhKGV2ZW50LmFyZ3VtZW50cy5jaGF0LmN1cnJlbnREYXRlUmFuZ2UgJiYgZXZlbnQuYXJndW1lbnRzLmNoYXQuaGlnaExldmVsQ2F0ZWdvcnkpICYmXG4gICAgICAgICFldmVudC5hcmd1bWVudHMuY2hhdC5kb05vdFVzZUFkdmFuY2VkUmFnXG4gICAgKSB7XG4gICAgICAgIGNvbnN0IGluZm9ybWF0aW9uTmVlZGVkID0gZ2V0TmVlZGVkSW5mb3JtYXRpb25Gcm9tTW9kZWwoZXZlbnQuYXJndW1lbnRzLmNoYXQucHJvbXB0IHx8ICcnKVxuICAgICAgICBjb25zdCBkYXRlUmFuZ2UgPSBnZXREYXRlUmFuZ2VGcm9tTW9kZWwoZXZlbnQuYXJndW1lbnRzLmNoYXQucHJvbXB0IHx8ICcnKVxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbaW5mb3JtYXRpb25OZWVkZWQsIGRhdGVSYW5nZV0pXG4gICAgICAgIG5lZWRlZEluZm8gPSBKU09OLnBhcnNlKChhd2FpdCBpbmZvcm1hdGlvbk5lZWRlZCkuY29udGVudCB8fCAnJylcbiAgICAgICAgZGF0ZVJhbmdlUmVzcG9uc2UgPSBKU09OLnBhcnNlKChhd2FpdCBkYXRlUmFuZ2UpLmNvbnRlbnQgfHwgJycpXG4gICAgfVxuXG4gICAgaWYgKGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNhY2hlSWRlbnRpZmllcnMpIHtcbiAgICAgICAgY29uc3QgY2FjaGVDaGVja3MgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNhY2hlSWRlbnRpZmllcnMubWFwKChpZCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjYWNoZUtleSA9IGdldENhY2hlS2V5KHVzZXIsIGlkKVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICBHZXRDYWNoZUVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogY2FjaGVLZXkgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBzazogaWQuY2FjaGVUeXBlPy50b1N0cmluZygpID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0OiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgY29uc3QgaXRlbUhpdHMgPSBjYWNoZUNoZWNrcy5mbGF0TWFwKChlbCkgPT4gZWwuSXRlbXMgPz8gW10pXG4gICAgICAgIGlmIChpdGVtSGl0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2U6XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1IaXRzXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKG1hcERkYlJlc3BvbnNlVG9DYWNoZUVudGl0eSlcbiAgICAgICAgICAgICAgICAgICAgICAgID8ubWFwKChlbCkgPT4gZWwucmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAuam9pbignJykgfHwgJycsXG4gICAgICAgICAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFxuICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMgPT09IENoYXRGb2N1cy5JbnZlc3RtZW50ICYmXG4gICAgICAgICFuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5maW5kKChlbCkgPT4gZWwgPT09IEluZm9ybWF0aW9uT3B0aW9ucy5JTlZFU1RNRU5UUylcbiAgICApIHtcbiAgICAgICAgbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24ucHVzaCgnSU5WRVNUTUVOVFMnIGFzIGFueSlcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgICAoZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdEZvY3VzID09PSBDaGF0Rm9jdXMuVHJhbnNhY3Rpb24gfHxcbiAgICAgICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRUeXBlID09PSBDaGF0VHlwZS5UcmFuc2FjdGlvblJlY29tbWVuZGF0aW9uKSAmJlxuICAgICAgICAhbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24uZmluZCgoZWwpID0+IGVsID09PSBJbmZvcm1hdGlvbk9wdGlvbnMuVFJBTlNBQ1RJT05TKVxuICAgICkge1xuICAgICAgICBuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5wdXNoKCdUUkFOU0FDVElPTlMnIGFzIGFueSlcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdFR5cGUgPT09IENoYXRUeXBlLkdlbmVyYWxSZWNvbW1lbmRhdGlvbikge1xuICAgICAgICBuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbiA9IFsnSU5WRVNUTUVOVFMnIGFzIGFueSwgJ0FDQ09VTlRTJyBhcyBhbnksICdNT05USExZU1VNTUFSWScgYXMgYW55XVxuICAgIH1cblxuICAgIGlmIChuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbj8ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uID0gWydBQ0NPVU5UUycgYXMgYW55LCAnTU9OVEhMWVNVTU1BUlknIGFzIGFueV1cbiAgICB9XG5cbiAgICBjb25zb2xlLmluZm8oJ0NvbnRleHQ6ICcsIGNvbnRleHQpXG4gICAgY29uc29sZS5pbmZvKCdOZWVkZWQgaW5mbyAnLCBuZWVkZWRJbmZvKVxuICAgIGNvbnNvbGUuaW5mbygnRGF0ZSByYW5nZTogJywgZGF0ZVJhbmdlUmVzcG9uc2UpXG4gICAgbGV0IHR1cGxlT2ZUeXBlVG9FbGVtZW50czogW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgdHVwbGVPZlR5cGVUb0VsZW1lbnRzID0gKFxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLm1hcChhc3luYyAob3B0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW50aXR5TmFtZSA9IG1hcE9mSW5mb3JtYXRpb25PcHRpb25Ub0tleVtvcHRpb25dLnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWUgIT09ICdNT05USExZU1VNTUFSWSdcbiAgICAgICAgICAgICAgICAgICAgICAgID8gbWF4QWNjb3VudHM/Lm1hcChhc3luYyAoYWNjb3VudElkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGllbnQuc2VuZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR2V0RW50aXRpZXMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXIgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYWNjb3VudElkIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nLmZpbmQoKGVsKSA9PiBlbCA9PT0gZW50aXR5TmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGRhdGVSYW5nZVJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lOiBlbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0ZVJhbmdlOiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nLmZpbmQoKGVsKSA9PiBlbCA9PT0gZW50aXR5TmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IChldmVudC5hcmd1bWVudHMuY2hhdD8uY3VycmVudERhdGVSYW5nZT8ubWFwKChlbCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA/IHBhcnNlSW50KGVsKSA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSBhcyBhbnkpID8/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlnaExldmVsQ2F0ZWdvcnk6IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmhpZ2hMZXZlbENhdGVnb3J5ID8/IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KSA/PyBbb3B0aW9uLCB1bmRlZmluZWRdXG4gICAgICAgICAgICAgICAgICAgICAgICA6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICd2MCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlUmFuZ2U6IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcuZmluZCgoZWwpID0+IGVsID09PSBlbnRpdHlOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0ZVJhbmdlUmVzcG9uc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6IGVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21EYXRlUmFuZ2U6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hMZXZlbENhdGVnb3J5OiBldmVudC5hcmd1bWVudHMuY2hhdC5oaWdoTGV2ZWxDYXRlZ29yeSA/PyB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgKS5mbGF0TWFwKChlbDogYW55KSA9PiBbLi4uZWxdKSBhcyBhbnkgYXMgW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgY29uc29sZS5pbmZvKHR1cGxlT2ZUeXBlVG9FbGVtZW50cywgJ2dvb2QnKVxuICAgIC8qKiBHZXQgdGhlIGNvbnRleHR1YWwgZGF0YSAqL1xuICAgIGNvbnN0IGRkYlJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICB0dXBsZU9mVHlwZVRvRWxlbWVudHMubWFwKGFzeW5jICh0dXBsZSkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdHVwbGVbMF1cbiAgICAgICAgICAgIGNvbnN0IGF3YWl0ZWRUdXBsZSA9IHR1cGxlXG4gICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWRJdGVtcyA9IGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyhhd2FpdGVkVHVwbGVbMV0/Lkl0ZW1zID8/IFtdKVxuICAgICAgICAgICAgaWYgKGF3YWl0ZWRUdXBsZVswXS50b1N0cmluZygpID09PSAnSU5WRVNUTUVOVFMnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWFwcGVkRGF0YSA9IGF3YWl0IG1hcFNlY3VyaXRpZXNUb0pvaW5lZERhdGEoZGVjcnlwdGVkSXRlbXMpXG4gICAgICAgICAgICAgICAgcmV0dXJuICdcXG5JbnZlc3RtZW50czpcXG4nICsgbWFwSm9pbnREYXRhVG9DaGF0SW5wdXQobWFwcGVkRGF0YSlcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXdhaXRlZFR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdUUkFOU0FDVElPTlMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgJ1xcblRyYW5hc2FjdGlvbnM6XFxuJyArXG4gICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEl0ZW1zLm1hcChtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24pLm1hcChtYXBUcmFuc2FjdGlvblRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXdhaXRlZFR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdBQ0NPVU5UUycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1xcbkFjY291bnRzOlxcbicgKyBkZWNyeXB0ZWRJdGVtcy5tYXAobWFwRHluYW1vREJUb0FjY291bnQpLm1hcChtYXBBY2NvdW50VG9DaGF0SW5wdXQpLmpvaW4oJycpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGF3YWl0ZWRUdXBsZVswXS50b1N0cmluZygpID09PSAnTU9OVEhMWVNVTU1BUlknKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgJ1xcbk1vbnRobHkgU3BlbmRpbmc6XFxuJyArXG4gICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEl0ZW1zLm1hcChtYXBEeW5hbW9EQlRvTW9udGhseVN1bW1hcnkpLm1hcChtYXBTcGVuZGluZ1N1bW1hcnlUb0NoYXRJbnB1dCkuam9pbignJylcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVU5SRUNPR05JWkVEIE9QVElPTiAnICsgYXdhaXRlZFR1cGxlWzBdKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIClcbiAgICBjb25zdCByYWdEYXRhID0gZGRiUmVzcG9uc2VzLmpvaW4oJycpXG4gICAgY29uc29sZS5pbmZvKCdGSU5BTCBSQUcgREFUQTogJywgcmFnRGF0YSlcbiAgICBjb25zdCB7IHByb21wdCB9ID0gZXZlbnQuYXJndW1lbnRzLmNoYXRcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNvbXBsZXRlQ2hhdEZyb21Qcm9tcHQoXG4gICAgICAgIHByb21wdCArICcgVXNlIHRoaXMgZGF0YSBmb3IgeW91ciBhbnN3ZXI6ICcgKyByYWdEYXRhIHx8ICcnLFxuICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMsXG4gICAgICAgIHVzZXIsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LnJlcXVpcmVzTGl2ZURhdGEgPz8gZmFsc2UsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRUeXBlID8/IENoYXRUeXBlLlJlZ3VsYXJcbiAgICApXG4gICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycz8ubWFwKChpZCkgPT4ge1xuICAgICAgICBsZXQgY2FjaGVLZXkgPSBnZXRDYWNoZUtleSh1c2VyLCBpZClcbiAgICAgICAgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICBQdXRDYWNoZUVudGl0eShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBjYWNoZUtleSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0OiBtYXBPZkNhY2hlVHlwZVRvRXhwaXJ5W2lkLmNhY2hlVHlwZSFdICsgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICAgICAgc2s6IGlkLmNhY2hlVHlwZT8udG9TdHJpbmcoKSA/PyAnJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgcmVzcG9uc2U6IHsgUzogcmVzcG9uc2UgfSB9XG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICB9KVxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3BvbnNlOiByZXNwb25zZSB8fCAnJyxcbiAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgZ2V0Q2FjaGVLZXkgPSAodXNlcjogc3RyaW5nLCBpZDogQ2FjaGVJZGVudGlmZXIpID0+IHtcbiAgICBsZXQgY2FjaGVLZXkgPSBpZC5rZXlcbiAgICBpZiAoXG4gICAgICAgIGlkLmNhY2hlVHlwZSA9PT0gQ2FjaGVUeXBlLkludmVzdG1lbnRBbmFseXNpcyB8fFxuICAgICAgICBpZC5jYWNoZVR5cGUgPT09IENhY2hlVHlwZS5Qb3J0Zm9saW9BbmFseXNpcyB8fFxuICAgICAgICBpZC5jYWNoZVR5cGUgPT09IENhY2hlVHlwZS5UcmFuc2FjdGlvblJlY29tbWVuZGF0aW9uIHx8XG4gICAgICAgIGlkLmNhY2hlVHlwZSA9PT0gQ2FjaGVUeXBlLkdlbmVyYWxSZWNvbW1lbmRhdGlvblxuICAgICkge1xuICAgICAgICBjYWNoZUtleSA9IHVzZXIgKyBpZC5rZXk/LnNsaWNlKDAsIDEwMClcbiAgICB9XG4gICAgcmV0dXJuIGNhY2hlS2V5XG59XG4iXX0=