"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseUsingFinancialContext = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const CacheEntity_1 = require("./mappers/CacheEntity");
const Encryption_1 = require("./queries/Encryption");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION'];
const mapOfInformationOptionToKey = {
    BANKACCOUNTS: 'ACCOUNT',
    INVESTMENTS: 'SECURITY',
    TRANSACTIONS: 'TRANSACTION',
};
const mapOfCacheTypeToExpiry = {
    [API_1.CacheType.InvestmentAnalysis]: 60 * 60 * 1000,
    [API_1.CacheType.PortfolioAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockNews]: 60 * 60 * 1000,
};
const getResponseUsingFinancialContext = async (event, context) => {
    console.info('Get response for', event);
    let neededInfo = { optionsForInformation: [] };
    let dateRangeResponse;
    if (event.arguments.chat.shouldRagFetch &&
        !(event.arguments.chat.currentDateRange && event.arguments.chat.highLevelCategory)) {
        const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
        const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
        await Promise.all([informationNeeded, dateRange]);
        neededInfo = JSON.parse((await informationNeeded).content || '');
        dateRangeResponse = JSON.parse((await dateRange).content || '');
    }
    if (event.arguments.chat.cacheIdentifiers) {
        const cacheChecks = await Promise.all(event.arguments.chat.cacheIdentifiers.map((id) => {
            return client.send((0, Entities_1.GetCacheEntity)({
                id: id.key || '',
                expiresAt: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
            }));
        }));
        const itemHits = cacheChecks.flatMap((el) => el.Items ?? []);
        if (itemHits.length) {
            return {
                response: itemHits.map(CacheEntity_1.mapDdbResponseToCacheEntity).join('') || '',
                __typename: 'ChatResponse',
            };
        }
    }
    if (event.arguments.chat.chatFocus === API_1.ChatFocus.Investment &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.INVESTMENTS)) {
        neededInfo.optionsForInformation.push('INVESTMENTS');
    }
    else if (event.arguments.chat.chatFocus === API_1.ChatFocus.Transaction &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.TRANSACTIONS)) {
        neededInfo.optionsForInformation.push('TRANSACTIONS');
    }
    console.info('Context: ', context);
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    const user = event.identity?.username;
    let tupleOfTypeToElements;
    tupleOfTypeToElements = await Promise.all(neededInfo.optionsForInformation.map(async (option) => {
        const entityName = mapOfInformationOptionToKey[option].toString();
        return [
            option,
            await client.send((0, Entities_1.GetEntities)({
                username: user || '',
                id: event.arguments.chat.accountId || '',
                dateRange: entityName in dateSupportedFiltering ? dateRangeResponse : undefined,
                entityName: entityName,
                customDateRange: event.arguments.chat?.currentDateRange?.map((el) => el ? parseInt(el) : undefined) ?? undefined,
                highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
            })),
        ];
    }));
    /** Get the contextual data */
    const ddbResponses = await Promise.all(tupleOfTypeToElements.map(async (tuple) => {
        const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(tuple[1]?.Items ?? []);
        if (tuple[0].toString() === 'INVESTMENTS') {
            const mappedData = await (0, Security_1.mapSecuritiesToJoinedData)(decryptedItems);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (tuple[0].toString() === 'TRANSACTIONS') {
            return ('\nTranasactions:\n' +
                decryptedItems.map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (tuple[0].toString() === 'BANKACCOUNTS') {
            return '\nAccounts:\n' + decryptedItems.map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join('');
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + tuple[0]);
        }
    }));
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus, user, event.arguments.chat.requiresLiveData ?? false, event.arguments.chat.chatType ?? API_1.ChatType.Regular);
    event.arguments.chat.cacheIdentifiers?.map((id) => {
        client.send((0, Entities_1.PutCacheEntity)({
            id: id.key || '',
            expiresAt: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
        }, {}));
    });
    return {
        response: response || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStFO0FBQy9FLCtCQUF3SDtBQUN4SCw4REFBNkU7QUFDN0UsaURBQWdGO0FBQ2hGLGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLHVEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUE7QUFFN0QsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBRTlDLE1BQU0sMkJBQTJCLEdBQStCO0lBQzVELFlBQVksRUFBRSxTQUFTO0lBQ3ZCLFdBQVcsRUFBRSxVQUFVO0lBQ3ZCLFlBQVksRUFBRSxhQUFhO0NBQzlCLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUE4QjtJQUN0RCxDQUFDLGVBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtJQUM5QyxDQUFDLGVBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUU7SUFDbEQsQ0FBQyxlQUFTLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsRUFBRTtJQUM5QyxDQUFDLGVBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUk7Q0FDeEMsQ0FBQTtBQUVNLE1BQU0sZ0NBQWdDLEdBQThDLEtBQUssRUFDNUYsS0FBZ0QsRUFDaEQsT0FBZ0IsRUFDbEIsRUFBRTtJQUNBLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENB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dCB7IEFwcFN5bmNJZGVudGl0eUNvZ25pdG8sIEFwcFN5bmNSZXNvbHZlckV2ZW50LCBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyLCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7IENoYXRGb2N1cywgQ2hhdFF1ZXJ5LCBDaGF0UmVzcG9uc2UsIENoYXRUeXBlLCBDYWNoZVR5cGUgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IEluZm9ybWF0aW9uT3B0aW9ucywgY29tcGxldGVDaGF0RnJvbVByb21wdCwgZ2V0RGF0ZVJhbmdlRnJvbU1vZGVsLCBnZXROZWVkZWRJbmZvcm1hdGlvbkZyb21Nb2RlbCB9IGZyb20gJy4vZ3B0J1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFF1ZXJ5Q29tbWFuZE91dHB1dCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYidcbmltcG9ydCB7IEdldENhY2hlRW50aXR5LCBHZXRFbnRpdGllcywgUHV0Q2FjaGVFbnRpdHkgfSBmcm9tICcuL3F1ZXJpZXMvRW50aXRpZXMnXG5pbXBvcnQgeyBtYXBKb2ludERhdGFUb0NoYXRJbnB1dCwgbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YSB9IGZyb20gJy4vbWFwcGVycy9TZWN1cml0eSdcbmltcG9ydCB7IG1hcEFjY291bnRUb0NoYXRJbnB1dCwgbWFwRHluYW1vREJUb0FjY291bnQgfSBmcm9tICcuL21hcHBlcnMvQWNjb3VudHMnXG5pbXBvcnQgeyBtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24sIG1hcFRyYW5zYWN0aW9uVG9DaGF0SW5wdXQgfSBmcm9tICcuL21hcHBlcnMvVHJhbnNhY3Rpb25zJ1xuaW1wb3J0IHsgbWFwRGRiUmVzcG9uc2VUb0NhY2hlRW50aXR5IH0gZnJvbSAnLi9tYXBwZXJzL0NhY2hlRW50aXR5J1xuaW1wb3J0IHsgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzIH0gZnJvbSAnLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPSBbJ1RSQU5TQUNUSU9OJ11cbmV4cG9ydCB0eXBlIEVudGl0eU5hbWUgPSAnU0VDVVJJVFknIHwgJ1RSQU5TQUNUSU9OJyB8ICdBQ0NPVU5UJ1xuY29uc3QgbWFwT2ZJbmZvcm1hdGlvbk9wdGlvblRvS2V5OiBSZWNvcmQ8c3RyaW5nLCBFbnRpdHlOYW1lPiA9IHtcbiAgICBCQU5LQUNDT1VOVFM6ICdBQ0NPVU5UJyxcbiAgICBJTlZFU1RNRU5UUzogJ1NFQ1VSSVRZJyxcbiAgICBUUkFOU0FDVElPTlM6ICdUUkFOU0FDVElPTicsXG59XG5cbmNvbnN0IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnk6IFJlY29yZDxDYWNoZVR5cGUsIG51bWJlcj4gPSB7XG4gICAgW0NhY2hlVHlwZS5JbnZlc3RtZW50QW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCxcbiAgICBbQ2FjaGVUeXBlLlBvcnRmb2xpb0FuYWx5c2lzXTogNjAgKiA2MCAqIDEwMDAgKiAyNCxcbiAgICBbQ2FjaGVUeXBlLlN0b2NrQW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCAqIDI0LFxuICAgIFtDYWNoZVR5cGUuU3RvY2tOZXdzXTogNjAgKiA2MCAqIDEwMDAsXG59XG5cbmV4cG9ydCBjb25zdCBnZXRSZXNwb25zZVVzaW5nRmluYW5jaWFsQ29udGV4dDogQXBwU3luY1Jlc29sdmVySGFuZGxlcjxhbnksIENoYXRSZXNwb25zZT4gPSBhc3luYyAoXG4gICAgZXZlbnQ6IEFwcFN5bmNSZXNvbHZlckV2ZW50PHsgY2hhdDogQ2hhdFF1ZXJ5IH0+LFxuICAgIGNvbnRleHQ6IENvbnRleHRcbikgPT4ge1xuICAgIGNvbnNvbGUuaW5mbygnR2V0IHJlc3BvbnNlIGZvcicsIGV2ZW50KVxuICAgIGxldCBuZWVkZWRJbmZvOiB7IG9wdGlvbnNGb3JJbmZvcm1hdGlvbjogSW5mb3JtYXRpb25PcHRpb25zW10gfSA9IHsgb3B0aW9uc0ZvckluZm9ybWF0aW9uOiBbXSB9XG4gICAgbGV0IGRhdGVSYW5nZVJlc3BvbnNlOiBhbnlcbiAgICBpZiAoXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LnNob3VsZFJhZ0ZldGNoICYmXG4gICAgICAgICEoZXZlbnQuYXJndW1lbnRzLmNoYXQuY3VycmVudERhdGVSYW5nZSAmJiBldmVudC5hcmd1bWVudHMuY2hhdC5oaWdoTGV2ZWxDYXRlZ29yeSlcbiAgICApIHtcbiAgICAgICAgY29uc3QgaW5mb3JtYXRpb25OZWVkZWQgPSBnZXROZWVkZWRJbmZvcm1hdGlvbkZyb21Nb2RlbChldmVudC5hcmd1bWVudHMuY2hhdC5wcm9tcHQgfHwgJycpXG4gICAgICAgIGNvbnN0IGRhdGVSYW5nZSA9IGdldERhdGVSYW5nZUZyb21Nb2RlbChldmVudC5hcmd1bWVudHMuY2hhdC5wcm9tcHQgfHwgJycpXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtpbmZvcm1hdGlvbk5lZWRlZCwgZGF0ZVJhbmdlXSlcbiAgICAgICAgbmVlZGVkSW5mbyA9IEpTT04ucGFyc2UoKGF3YWl0IGluZm9ybWF0aW9uTmVlZGVkKS5jb250ZW50IHx8ICcnKVxuICAgICAgICBkYXRlUmFuZ2VSZXNwb25zZSA9IEpTT04ucGFyc2UoKGF3YWl0IGRhdGVSYW5nZSkuY29udGVudCB8fCAnJylcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycykge1xuICAgICAgICBjb25zdCBjYWNoZUNoZWNrcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycy5tYXAoKGlkKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICBHZXRDYWNoZUVudGl0eSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQua2V5IHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwaXJlc0F0OiBtYXBPZkNhY2hlVHlwZVRvRXhwaXJ5W2lkLmNhY2hlVHlwZSFdICsgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIGNvbnN0IGl0ZW1IaXRzID0gY2FjaGVDaGVja3MuZmxhdE1hcCgoZWwpID0+IGVsLkl0ZW1zID8/IFtdKVxuICAgICAgICBpZiAoaXRlbUhpdHMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlOiBpdGVtSGl0cy5tYXAobWFwRGRiUmVzcG9uc2VUb0NhY2hlRW50aXR5KS5qb2luKCcnKSB8fCAnJyxcbiAgICAgICAgICAgICAgICBfX3R5cGVuYW1lOiAnQ2hhdFJlc3BvbnNlJyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyA9PT0gQ2hhdEZvY3VzLkludmVzdG1lbnQgJiZcbiAgICAgICAgIW5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLmZpbmQoKGVsKSA9PiBlbCA9PT0gSW5mb3JtYXRpb25PcHRpb25zLklOVkVTVE1FTlRTKVxuICAgICkge1xuICAgICAgICBuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5wdXNoKCdJTlZFU1RNRU5UUycgYXMgYW55KVxuICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyA9PT0gQ2hhdEZvY3VzLlRyYW5zYWN0aW9uICYmXG4gICAgICAgICFuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5maW5kKChlbCkgPT4gZWwgPT09IEluZm9ybWF0aW9uT3B0aW9ucy5UUkFOU0FDVElPTlMpXG4gICAgKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLnB1c2goJ1RSQU5TQUNUSU9OUycgYXMgYW55KVxuICAgIH1cbiAgICBjb25zb2xlLmluZm8oJ0NvbnRleHQ6ICcsIGNvbnRleHQpXG4gICAgY29uc29sZS5pbmZvKCdOZWVkZWQgaW5mbyAnLCBuZWVkZWRJbmZvKVxuICAgIGNvbnNvbGUuaW5mbygnRGF0ZSByYW5nZTogJywgZGF0ZVJhbmdlUmVzcG9uc2UpXG4gICAgY29uc3QgdXNlciA9IChldmVudC5pZGVudGl0eSBhcyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvKT8udXNlcm5hbWVcbiAgICBsZXQgdHVwbGVPZlR5cGVUb0VsZW1lbnRzOiBbSW5mb3JtYXRpb25PcHRpb25zLCBRdWVyeUNvbW1hbmRPdXRwdXRdW11cbiAgICB0dXBsZU9mVHlwZVRvRWxlbWVudHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24ubWFwKGFzeW5jIChvcHRpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eU5hbWUgPSBtYXBPZkluZm9ybWF0aW9uT3B0aW9uVG9LZXlbb3B0aW9uXS50b1N0cmluZygpXG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgIG9wdGlvbixcbiAgICAgICAgICAgICAgICBhd2FpdCBjbGllbnQuc2VuZChcbiAgICAgICAgICAgICAgICAgICAgR2V0RW50aXRpZXMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXIgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogZXZlbnQuYXJndW1lbnRzLmNoYXQuYWNjb3VudElkIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiBlbnRpdHlOYW1lIGluIGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPyBkYXRlUmFuZ2VSZXNwb25zZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6IGVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21EYXRlUmFuZ2U6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGV2ZW50LmFyZ3VtZW50cy5jaGF0Py5jdXJyZW50RGF0ZVJhbmdlPy5tYXAoKGVsKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA/IHBhcnNlSW50KGVsKSA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgYXMgYW55KSA/PyB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBoaWdoTGV2ZWxDYXRlZ29yeTogZXZlbnQuYXJndW1lbnRzLmNoYXQuaGlnaExldmVsQ2F0ZWdvcnkgPz8gdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pXG4gICAgKVxuXG4gICAgLyoqIEdldCB0aGUgY29udGV4dHVhbCBkYXRhICovXG4gICAgY29uc3QgZGRiUmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHR1cGxlT2ZUeXBlVG9FbGVtZW50cy5tYXAoYXN5bmMgKHR1cGxlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWRJdGVtcyA9IGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyh0dXBsZVsxXT8uSXRlbXMgPz8gW10pXG4gICAgICAgICAgICBpZiAodHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ0lOVkVTVE1FTlRTJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hcHBlZERhdGEgPSBhd2FpdCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhKGRlY3J5cHRlZEl0ZW1zKVxuICAgICAgICAgICAgICAgIHJldHVybiAnXFxuSW52ZXN0bWVudHM6XFxuJyArIG1hcEpvaW50RGF0YVRvQ2hhdElucHV0KG1hcHBlZERhdGEpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdUUkFOU0FDVElPTlMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgJ1xcblRyYW5hc2FjdGlvbnM6XFxuJyArXG4gICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEl0ZW1zLm1hcChtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24pLm1hcChtYXBUcmFuc2FjdGlvblRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ0JBTktBQ0NPVU5UUycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1xcbkFjY291bnRzOlxcbicgKyBkZWNyeXB0ZWRJdGVtcy5tYXAobWFwRHluYW1vREJUb0FjY291bnQpLm1hcChtYXBBY2NvdW50VG9DaGF0SW5wdXQpLmpvaW4oJycpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVU5SRUNPR05JWkVEIE9QVElPTiAnICsgdHVwbGVbMF0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgKVxuICAgIGNvbnN0IHJhZ0RhdGEgPSBkZGJSZXNwb25zZXMuam9pbignJylcbiAgICBjb25zb2xlLmluZm8oJ0ZJTkFMIFJBRyBEQVRBOiAnLCByYWdEYXRhKVxuICAgIGNvbnN0IHsgcHJvbXB0IH0gPSBldmVudC5hcmd1bWVudHMuY2hhdFxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY29tcGxldGVDaGF0RnJvbVByb21wdChcbiAgICAgICAgcHJvbXB0ICsgJyBVc2UgdGhpcyBkYXRhIGZvciB5b3VyIGFuc3dlcjogJyArIHJhZ0RhdGEgfHwgJycsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyxcbiAgICAgICAgdXNlcixcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQucmVxdWlyZXNMaXZlRGF0YSA/PyBmYWxzZSxcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdFR5cGUgPz8gQ2hhdFR5cGUuUmVndWxhclxuICAgIClcbiAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzPy5tYXAoKGlkKSA9PiB7XG4gICAgICAgIGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgUHV0Q2FjaGVFbnRpdHkoXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBpZDogaWQua2V5IHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBleHBpcmVzQXQ6IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnlbaWQuY2FjaGVUeXBlIV0gKyBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge31cbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgIH0pXG4gICAgcmV0dXJuIHtcbiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlIHx8ICcnLFxuICAgICAgICBfX3R5cGVuYW1lOiAnQ2hhdFJlc3BvbnNlJyxcbiAgICB9XG59XG4iXX0=