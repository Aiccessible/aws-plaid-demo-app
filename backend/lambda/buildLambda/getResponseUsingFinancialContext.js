"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseUsingFinancialContext = void 0;
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION'];
const getResponseUsingFinancialContext = async (event, context) => {
    console.debug('Get response for', event);
    const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
    const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
    await Promise.all([informationNeeded, dateRange]);
    const neededInfo = JSON.parse((await informationNeeded).content || '');
    const dateRangeResponse = JSON.parse((await dateRange).content || '');
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    const user = context.identity?.cognitoIdentityId;
    let tupleOfTypeToElements;
    tupleOfTypeToElements = await Promise.all(neededInfo.informationOptions.map(async (option) => {
        return [
            option,
            await client.send((0, Entities_1.GetEntities)({
                username: user || '',
                id: event.arguments.chat.id,
                dateRange: option in dateSupportedFiltering ? dateRangeResponse : undefined,
                entityName: option,
            })),
        ];
    }));
    const ddbResponses = tupleOfTypeToElements.map((tuple) => {
        if (tuple[0] === gpt_1.InformationOptions.SECURITY) {
            const mappedData = (0, Security_1.mapSecuritiesToJoinedData)(tuple[1].Items ?? []);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (tuple[0] === gpt_1.InformationOptions.TRANSACTION) {
            return ('\nTranasactions:\n' +
                (tuple[1].Items ?? []).map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (tuple[0] === gpt_1.InformationOptions.ACCOUNT) {
            return ('\nAccounts:\n' + (tuple[1].Items ?? []).map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join(''));
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + tuple[0]);
        }
    });
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus);
    return {
        response: response.content || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsK0JBT2M7QUFDZCw4REFBMkY7QUFDM0YsaURBQWdEO0FBQ2hELGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUN2QyxNQUFNLGdDQUFnQyxHQUE4QyxLQUFLLEVBQzVGLEtBQWdELEVBQ2hELE9BQWdCLEVBQ2xCLEVBQUU7SUFDQSxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ3hDLE1BQU0saUJBQWlCLEdBQUcsSUFBQSxtQ0FBNkIsRUFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUE7SUFDMUYsTUFBTSxTQUFTLEdBQUcsSUFBQSwyQkFBcUIsRUFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUE7SUFDMUUsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsaUJBQWlCLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQTtJQUNqRCxNQUFNLFVBQVUsR0FBK0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0saUJBQWlCLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUE7SUFDbEcsTUFBTSxpQkFBaUIsR0FBc0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sU0FBUyxDQUFDLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FB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LEVBQUU7UUFDaEMsVUFBVSxFQUFFLGNBQWM7S0FDN0IsQ0FBQTtBQUNMLENBQUMsQ0FBQTtBQXpEWSxRQUFBLGdDQUFnQyxvQ0F5RDVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwU3luY1Jlc29sdmVyRXZlbnQsIEFwcFN5bmNSZXNvbHZlckhhbmRsZXIsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJ1xuaW1wb3J0IHsgQ2hhdFF1ZXJ5LCBDaGF0UmVzcG9uc2UgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7XG4gICAgRGF0YVJhbmdlUmVzcG9uc2UsXG4gICAgSW5mb3JtYXRpb25PcHRpb25zLFxuICAgIEluZm9ybWF0aW9uT3B0aW9uc1Jlc3BvbnNlLFxuICAgIGNvbXBsZXRlQ2hhdEZyb21Qcm9tcHQsXG4gICAgZ2V0RGF0ZVJhbmdlRnJvbU1vZGVsLFxuICAgIGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsLFxufSBmcm9tICcuL2dwdCdcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBRdWVyeUNvbW1hbmQsIFF1ZXJ5Q29tbWFuZE91dHB1dCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYidcbmltcG9ydCB7IEdldEVudGl0aWVzIH0gZnJvbSAnLi9xdWVyaWVzL0VudGl0aWVzJ1xuaW1wb3J0IHsgbWFwSm9pbnREYXRhVG9DaGF0SW5wdXQsIG1hcFNlY3VyaXRpZXNUb0pvaW5lZERhdGEgfSBmcm9tICcuL21hcHBlcnMvU2VjdXJpdHknXG5pbXBvcnQgeyBtYXBBY2NvdW50VG9DaGF0SW5wdXQsIG1hcER5bmFtb0RCVG9BY2NvdW50IH0gZnJvbSAnLi9tYXBwZXJzL0FjY291bnRzJ1xuaW1wb3J0IHsgbWFwRHluYW1vREJUb1RyYW5zYWN0aW9uLCBtYXBUcmFuc2FjdGlvblRvQ2hhdElucHV0IH0gZnJvbSAnLi9tYXBwZXJzL1RyYW5zYWN0aW9ucydcbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuY29uc3QgZGF0ZVN1cHBvcnRlZEZpbHRlcmluZyA9IFsnVFJBTlNBQ1RJT04nXVxuZXhwb3J0IGNvbnN0IGdldFJlc3BvbnNlVXNpbmdGaW5hbmNpYWxDb250ZXh0OiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgQ2hhdFJlc3BvbnNlPiA9IGFzeW5jIChcbiAgICBldmVudDogQXBwU3luY1Jlc29sdmVyRXZlbnQ8eyBjaGF0OiBDaGF0UXVlcnkgfT4sXG4gICAgY29udGV4dDogQ29udGV4dFxuKSA9PiB7XG4gICAgY29uc29sZS5kZWJ1ZygnR2V0IHJlc3BvbnNlIGZvcicsIGV2ZW50KVxuICAgIGNvbnN0IGluZm9ybWF0aW9uTmVlZGVkID0gZ2V0TmVlZGVkSW5mb3JtYXRpb25Gcm9tTW9kZWwoZXZlbnQuYXJndW1lbnRzLmNoYXQucHJvbXB0IHx8ICcnKVxuICAgIGNvbnN0IGRhdGVSYW5nZSA9IGdldERhdGVSYW5nZUZyb21Nb2RlbChldmVudC5hcmd1bWVudHMuY2hhdC5wcm9tcHQgfHwgJycpXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW2luZm9ybWF0aW9uTmVlZGVkLCBkYXRlUmFuZ2VdKVxuICAgIGNvbnN0IG5lZWRlZEluZm86IEluZm9ybWF0aW9uT3B0aW9uc1Jlc3BvbnNlID0gSlNPTi5wYXJzZSgoYXdhaXQgaW5mb3JtYXRpb25OZWVkZWQpLmNvbnRlbnQgfHwgJycpXG4gICAgY29uc3QgZGF0ZVJhbmdlUmVzcG9uc2U6IERhdGFSYW5nZVJlc3BvbnNlID0gSlNPTi5wYXJzZSgoYXdhaXQgZGF0ZVJhbmdlKS5jb250ZW50IHx8ICcnKVxuICAgIGNvbnNvbGUuaW5mbygnTmVlZGVkIGluZm8gJywgbmVlZGVkSW5mbylcbiAgICBjb25zb2xlLmluZm8oJ0RhdGUgcmFuZ2U6ICcsIGRhdGVSYW5nZVJlc3BvbnNlKVxuICAgIGNvbnN0IHVzZXIgPSBjb250ZXh0LmlkZW50aXR5Py5jb2duaXRvSWRlbnRpdHlJZFxuICAgIGxldCB0dXBsZU9mVHlwZVRvRWxlbWVudHM6IFtJbmZvcm1hdGlvbk9wdGlvbnMsIFF1ZXJ5Q29tbWFuZE91dHB1dF1bXVxuICAgIHR1cGxlT2ZUeXBlVG9FbGVtZW50cyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBuZWVkZWRJbmZvLmluZm9ybWF0aW9uT3B0aW9ucy5tYXAoYXN5bmMgKG9wdGlvbikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBvcHRpb24sXG4gICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IChldmVudC5hcmd1bWVudHMuY2hhdCBhcyBhbnkpLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiBvcHRpb24gaW4gZGF0ZVN1cHBvcnRlZEZpbHRlcmluZyA/IGRhdGVSYW5nZVJlc3BvbnNlIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5TmFtZTogb3B0aW9uLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pXG4gICAgKVxuICAgIGNvbnN0IGRkYlJlc3BvbnNlcyA9IHR1cGxlT2ZUeXBlVG9FbGVtZW50cy5tYXAoKHR1cGxlKSA9PiB7XG4gICAgICAgIGlmICh0dXBsZVswXSA9PT0gSW5mb3JtYXRpb25PcHRpb25zLlNFQ1VSSVRZKSB7XG4gICAgICAgICAgICBjb25zdCBtYXBwZWREYXRhID0gbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YSh0dXBsZVsxXS5JdGVtcyA/PyBbXSlcbiAgICAgICAgICAgIHJldHVybiAnXFxuSW52ZXN0bWVudHM6XFxuJyArIG1hcEpvaW50RGF0YVRvQ2hhdElucHV0KG1hcHBlZERhdGEpXG4gICAgICAgIH0gZWxzZSBpZiAodHVwbGVbMF0gPT09IEluZm9ybWF0aW9uT3B0aW9ucy5UUkFOU0FDVElPTikge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAnXFxuVHJhbmFzYWN0aW9uczpcXG4nICtcbiAgICAgICAgICAgICAgICAodHVwbGVbMV0uSXRlbXMgPz8gW10pLm1hcChtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24pLm1hcChtYXBUcmFuc2FjdGlvblRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgKVxuICAgICAgICB9IGVsc2UgaWYgKHR1cGxlWzBdID09PSBJbmZvcm1hdGlvbk9wdGlvbnMuQUNDT1VOVCkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAnXFxuQWNjb3VudHM6XFxuJyArICh0dXBsZVsxXS5JdGVtcyA/PyBbXSkubWFwKG1hcER5bmFtb0RCVG9BY2NvdW50KS5tYXAobWFwQWNjb3VudFRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVTlJFQ09HTklaRUQgT1BUSU9OICcgKyB0dXBsZVswXSlcbiAgICAgICAgfVxuICAgIH0pXG4gICAgY29uc3QgcmFnRGF0YSA9IGRkYlJlc3BvbnNlcy5qb2luKCcnKVxuICAgIGNvbnNvbGUuaW5mbygnRklOQUwgUkFHIERBVEE6ICcsIHJhZ0RhdGEpXG4gICAgY29uc3QgeyBwcm9tcHQgfSA9IGV2ZW50LmFyZ3VtZW50cy5jaGF0XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0KFxuICAgICAgICBwcm9tcHQgKyAnIFVzZSB0aGlzIGRhdGEgZm9yIHlvdXIgYW5zd2VyOiAnICsgcmFnRGF0YSB8fCAnJyxcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdEZvY3VzXG4gICAgKVxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3BvbnNlOiByZXNwb25zZS5jb250ZW50IHx8ICcnLFxuICAgICAgICBfX3R5cGVuYW1lOiAnQ2hhdFJlc3BvbnNlJyxcbiAgICB9XG59XG4iXX0=