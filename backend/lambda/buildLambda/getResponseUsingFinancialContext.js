"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseUsingFinancialContext = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const CacheEntity_1 = require("./mappers/CacheEntity");
const Encryption_1 = require("./queries/Encryption");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION'];
const mapOfInformationOptionToKey = {
    BANKACCOUNTS: 'ACCOUNT',
    INVESTMENTS: 'SECURITY',
    TRANSACTIONS: 'TRANSACTION',
};
const mapOfCacheTypeToExpiry = {
    [API_1.CacheType.InvestmentAnalysis]: 60 * 60 * 1000 * 4,
    [API_1.CacheType.PortfolioAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockNews]: 60 * 60 * 1000 * 4,
};
const getResponseUsingFinancialContext = async (event, context) => {
    console.info('Get response for', event);
    let neededInfo = { optionsForInformation: [] };
    let dateRangeResponse;
    if (event.arguments.chat.shouldRagFetch &&
        !(event.arguments.chat.currentDateRange && event.arguments.chat.highLevelCategory)) {
        const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
        const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
        await Promise.all([informationNeeded, dateRange]);
        neededInfo = JSON.parse((await informationNeeded).content || '');
        dateRangeResponse = JSON.parse((await dateRange).content || '');
    }
    if (event.arguments.chat.cacheIdentifiers) {
        const cacheChecks = await Promise.all(event.arguments.chat.cacheIdentifiers.map((id) => {
            return client.send((0, Entities_1.GetCacheEntity)({
                id: id.key || '',
                sk: id.cacheType?.toString() ?? '',
                expire_at: Date.now(),
            }));
        }));
        const itemHits = cacheChecks.flatMap((el) => el.Items ?? []);
        if (itemHits.length) {
            return {
                response: itemHits
                    .map(CacheEntity_1.mapDdbResponseToCacheEntity)
                    ?.map((el) => el.response)
                    .join('') || '',
                __typename: 'ChatResponse',
            };
        }
    }
    if (event.arguments.chat.chatFocus === API_1.ChatFocus.Investment &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.INVESTMENTS)) {
        neededInfo.optionsForInformation.push('INVESTMENTS');
    }
    else if (event.arguments.chat.chatFocus === API_1.ChatFocus.Transaction &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.TRANSACTIONS)) {
        neededInfo.optionsForInformation.push('TRANSACTIONS');
    }
    console.info('Context: ', context);
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    const user = event.identity?.username;
    let tupleOfTypeToElements;
    tupleOfTypeToElements = await Promise.all(neededInfo.optionsForInformation.map(async (option) => {
        const entityName = mapOfInformationOptionToKey[option].toString();
        return [
            option,
            await client.send((0, Entities_1.GetEntities)({
                username: user || '',
                id: event.arguments.chat.accountId || '',
                dateRange: entityName in dateSupportedFiltering ? dateRangeResponse : undefined,
                entityName: entityName,
                customDateRange: event.arguments.chat?.currentDateRange?.map((el) => el ? parseInt(el) : undefined) ?? undefined,
                highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
            })),
        ];
    }));
    /** Get the contextual data */
    const ddbResponses = await Promise.all(tupleOfTypeToElements.map(async (tuple) => {
        const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(tuple[1]?.Items ?? []);
        if (tuple[0].toString() === 'INVESTMENTS') {
            const mappedData = await (0, Security_1.mapSecuritiesToJoinedData)(decryptedItems);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (tuple[0].toString() === 'TRANSACTIONS') {
            return ('\nTranasactions:\n' +
                decryptedItems.map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (tuple[0].toString() === 'BANKACCOUNTS') {
            return '\nAccounts:\n' + decryptedItems.map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join('');
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + tuple[0]);
        }
    }));
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus, user, event.arguments.chat.requiresLiveData ?? false, event.arguments.chat.chatType ?? API_1.ChatType.Regular);
    event.arguments.chat.cacheIdentifiers?.map((id) => {
        client.send((0, Entities_1.PutCacheEntity)({
            id: id.key || '',
            expire_at: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
            sk: id.cacheType?.toString() ?? '',
        }, { response: { S: response } }));
    });
    return {
        response: response || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStFO0FBQy9FLCtCQUF3SDtBQUN4SCw4REFBNkU7QUFDN0UsaURBQWdGO0FBQ2hGLGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLHVEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUE7QUFFN0QsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBRTlDLE1BQU0sMkJBQTJCLEdBQStCO0lBQzVELFlBQVksRUFBRSxTQUFTO0lBQ3ZCLFdBQVcsRUFBRSxVQUFVO0lBQ3ZCLFlBQVksRUFBRSxhQUFhO0NBQzlCLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUE4QjtJQUN0RCxDQUFDLGVBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDbEQsQ0FBQyxlQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxFQUFFO0lBQ2xELENBQUMsZUFBUyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUU7SUFDOUMsQ0FBQyxlQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQztDQUM1QyxDQUFBO0FBRU0sTUFBTSxnQ0FBZ0MsR0FBOEMsS0FBSyxFQUM1RixLQUFnRCxFQUNoRCxPQUFnQixFQUNsQixFQUFFO0lBQ0EsT0FBTyxDQUFDLElBQUksQ0FBQyxrQkFB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QUUsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FDaEMsQ0FDSixDQUFBO0lBQ0wsQ0FBQyxDQUFDLENBQUE7SUFDRixPQUFPO1FBQ0gsUUFBUSxFQUFFLFFBQVEsSUFBSSxFQUFFO1FBQ3hCLFVBQVUsRUFBRSxjQUFjO0tBQzdCLENBQUE7QUFDTCxDQUFDLENBQUE7QUE3SFksUUFBQSxnQ0FBZ0Msb0NBNkg1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcFN5bmNJZGVudGl0eUNvZ25pdG8sIEFwcFN5bmNSZXNvbHZlckV2ZW50LCBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyLCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7IENoYXRGb2N1cywgQ2hhdFF1ZXJ5LCBDaGF0UmVzcG9uc2UsIENoYXRUeXBlLCBDYWNoZVR5cGUgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IEluZm9ybWF0aW9uT3B0aW9ucywgY29tcGxldGVDaGF0RnJvbVByb21wdCwgZ2V0RGF0ZVJhbmdlRnJvbU1vZGVsLCBnZXROZWVkZWRJbmZvcm1hdGlvbkZyb21Nb2RlbCB9IGZyb20gJy4vZ3B0J1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFF1ZXJ5Q29tbWFuZE91dHB1dCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYidcbmltcG9ydCB7IEdldENhY2hlRW50aXR5LCBHZXRFbnRpdGllcywgUHV0Q2FjaGVFbnRpdHkgfSBmcm9tICcuL3F1ZXJpZXMvRW50aXRpZXMnXG5pbXBvcnQgeyBtYXBKb2ludERhdGFUb0NoYXRJbnB1dCwgbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YSB9IGZyb20gJy4vbWFwcGVycy9TZWN1cml0eSdcbmltcG9ydCB7IG1hcEFjY291bnRUb0NoYXRJbnB1dCwgbWFwRHluYW1vREJUb0FjY291bnQgfSBmcm9tICcuL21hcHBlcnMvQWNjb3VudHMnXG5pbXBvcnQgeyBtYXBEeW5hbW9EQlRvVHJhbnNhY3Rpb24sIG1hcFRyYW5zYWN0aW9uVG9DaGF0SW5wdXQgfSBmcm9tICcuL21hcHBlcnMvVHJhbnNhY3Rpb25zJ1xuaW1wb3J0IHsgbWFwRGRiUmVzcG9uc2VUb0NhY2hlRW50aXR5IH0gZnJvbSAnLi9tYXBwZXJzL0NhY2hlRW50aXR5J1xuaW1wb3J0IHsgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzIH0gZnJvbSAnLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPSBbJ1RSQU5TQUNUSU9OJ11cbmV4cG9ydCB0eXBlIEVudGl0eU5hbWUgPSAnU0VDVVJJVFknIHwgJ1RSQU5TQUNUSU9OJyB8ICdBQ0NPVU5UJ1xuY29uc3QgbWFwT2ZJbmZvcm1hdGlvbk9wdGlvblRvS2V5OiBSZWNvcmQ8c3RyaW5nLCBFbnRpdHlOYW1lPiA9IHtcbiAgICBCQU5LQUNDT1VOVFM6ICdBQ0NPVU5UJyxcbiAgICBJTlZFU1RNRU5UUzogJ1NFQ1VSSVRZJyxcbiAgICBUUkFOU0FDVElPTlM6ICdUUkFOU0FDVElPTicsXG59XG5cbmNvbnN0IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnk6IFJlY29yZDxDYWNoZVR5cGUsIG51bWJlcj4gPSB7XG4gICAgW0NhY2hlVHlwZS5JbnZlc3RtZW50QW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCAqIDQsXG4gICAgW0NhY2hlVHlwZS5Qb3J0Zm9saW9BbmFseXNpc106IDYwICogNjAgKiAxMDAwICogMjQsXG4gICAgW0NhY2hlVHlwZS5TdG9ja0FuYWx5c2lzXTogNjAgKiA2MCAqIDEwMDAgKiAyNCxcbiAgICBbQ2FjaGVUeXBlLlN0b2NrTmV3c106IDYwICogNjAgKiAxMDAwICogNCxcbn1cblxuZXhwb3J0IGNvbnN0IGdldFJlc3BvbnNlVXNpbmdGaW5hbmNpYWxDb250ZXh0OiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgQ2hhdFJlc3BvbnNlPiA9IGFzeW5jIChcbiAgICBldmVudDogQXBwU3luY1Jlc29sdmVyRXZlbnQ8eyBjaGF0OiBDaGF0UXVlcnkgfT4sXG4gICAgY29udGV4dDogQ29udGV4dFxuKSA9PiB7XG4gICAgY29uc29sZS5pbmZvKCdHZXQgcmVzcG9uc2UgZm9yJywgZXZlbnQpXG4gICAgbGV0IG5lZWRlZEluZm86IHsgb3B0aW9uc0ZvckluZm9ybWF0aW9uOiBJbmZvcm1hdGlvbk9wdGlvbnNbXSB9ID0geyBvcHRpb25zRm9ySW5mb3JtYXRpb246IFtdIH1cbiAgICBsZXQgZGF0ZVJhbmdlUmVzcG9uc2U6IGFueVxuICAgIGlmIChcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuc2hvdWxkUmFnRmV0Y2ggJiZcbiAgICAgICAgIShldmVudC5hcmd1bWVudHMuY2hhdC5jdXJyZW50RGF0ZVJhbmdlICYmIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmhpZ2hMZXZlbENhdGVnb3J5KVxuICAgICkge1xuICAgICAgICBjb25zdCBpbmZvcm1hdGlvbk5lZWRlZCA9IGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsKGV2ZW50LmFyZ3VtZW50cy5jaGF0LnByb21wdCB8fCAnJylcbiAgICAgICAgY29uc3QgZGF0ZVJhbmdlID0gZ2V0RGF0ZVJhbmdlRnJvbU1vZGVsKGV2ZW50LmFyZ3VtZW50cy5jaGF0LnByb21wdCB8fCAnJylcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW2luZm9ybWF0aW9uTmVlZGVkLCBkYXRlUmFuZ2VdKVxuICAgICAgICBuZWVkZWRJbmZvID0gSlNPTi5wYXJzZSgoYXdhaXQgaW5mb3JtYXRpb25OZWVkZWQpLmNvbnRlbnQgfHwgJycpXG4gICAgICAgIGRhdGVSYW5nZVJlc3BvbnNlID0gSlNPTi5wYXJzZSgoYXdhaXQgZGF0ZVJhbmdlKS5jb250ZW50IHx8ICcnKVxuICAgIH1cblxuICAgIGlmIChldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlQ2hlY2tzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jYWNoZUlkZW50aWZpZXJzLm1hcCgoaWQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldENhY2hlRW50aXR5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZC5rZXkgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBzazogaWQuY2FjaGVUeXBlPy50b1N0cmluZygpID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0OiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgY29uc3QgaXRlbUhpdHMgPSBjYWNoZUNoZWNrcy5mbGF0TWFwKChlbCkgPT4gZWwuSXRlbXMgPz8gW10pXG4gICAgICAgIGlmIChpdGVtSGl0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2U6XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1IaXRzXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKG1hcERkYlJlc3BvbnNlVG9DYWNoZUVudGl0eSlcbiAgICAgICAgICAgICAgICAgICAgICAgID8ubWFwKChlbCkgPT4gZWwucmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAuam9pbignJykgfHwgJycsXG4gICAgICAgICAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFxuICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMgPT09IENoYXRGb2N1cy5JbnZlc3RtZW50ICYmXG4gICAgICAgICFuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5maW5kKChlbCkgPT4gZWwgPT09IEluZm9ybWF0aW9uT3B0aW9ucy5JTlZFU1RNRU5UUylcbiAgICApIHtcbiAgICAgICAgbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24ucHVzaCgnSU5WRVNUTUVOVFMnIGFzIGFueSlcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMgPT09IENoYXRGb2N1cy5UcmFuc2FjdGlvbiAmJlxuICAgICAgICAhbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24uZmluZCgoZWwpID0+IGVsID09PSBJbmZvcm1hdGlvbk9wdGlvbnMuVFJBTlNBQ1RJT05TKVxuICAgICkge1xuICAgICAgICBuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5wdXNoKCdUUkFOU0FDVElPTlMnIGFzIGFueSlcbiAgICB9XG4gICAgY29uc29sZS5pbmZvKCdDb250ZXh0OiAnLCBjb250ZXh0KVxuICAgIGNvbnNvbGUuaW5mbygnTmVlZGVkIGluZm8gJywgbmVlZGVkSW5mbylcbiAgICBjb25zb2xlLmluZm8oJ0RhdGUgcmFuZ2U6ICcsIGRhdGVSYW5nZVJlc3BvbnNlKVxuICAgIGNvbnN0IHVzZXIgPSAoZXZlbnQuaWRlbnRpdHkgYXMgQXBwU3luY0lkZW50aXR5Q29nbml0byk/LnVzZXJuYW1lXG4gICAgbGV0IHR1cGxlT2ZUeXBlVG9FbGVtZW50czogW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgdHVwbGVPZlR5cGVUb0VsZW1lbnRzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLm1hcChhc3luYyAob3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gbWFwT2ZJbmZvcm1hdGlvbk9wdGlvblRvS2V5W29wdGlvbl0udG9TdHJpbmcoKVxuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBvcHRpb24sXG4gICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmFjY291bnRJZCB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVSYW5nZTogZW50aXR5TmFtZSBpbiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nID8gZGF0ZVJhbmdlUmVzcG9uc2UgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lOiBlbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0ZVJhbmdlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChldmVudC5hcmd1bWVudHMuY2hhdD8uY3VycmVudERhdGVSYW5nZT8ubWFwKChlbCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwgPyBwYXJzZUludChlbCkgOiB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApIGFzIGFueSkgPz8gdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGlnaExldmVsQ2F0ZWdvcnk6IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmhpZ2hMZXZlbENhdGVnb3J5ID8/IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXVxuICAgICAgICB9KVxuICAgIClcblxuICAgIC8qKiBHZXQgdGhlIGNvbnRleHR1YWwgZGF0YSAqL1xuICAgIGNvbnN0IGRkYlJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICB0dXBsZU9mVHlwZVRvRWxlbWVudHMubWFwKGFzeW5jICh0dXBsZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGVjcnlwdGVkSXRlbXMgPSBhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXModHVwbGVbMV0/Lkl0ZW1zID8/IFtdKVxuICAgICAgICAgICAgaWYgKHR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdJTlZFU1RNRU5UUycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXBwZWREYXRhID0gYXdhaXQgbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YShkZWNyeXB0ZWRJdGVtcylcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1xcbkludmVzdG1lbnRzOlxcbicgKyBtYXBKb2ludERhdGFUb0NoYXRJbnB1dChtYXBwZWREYXRhKVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0dXBsZVswXS50b1N0cmluZygpID09PSAnVFJBTlNBQ1RJT05TJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgICdcXG5UcmFuYXNhY3Rpb25zOlxcbicgK1xuICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtcy5tYXAobWFwRHluYW1vREJUb1RyYW5zYWN0aW9uKS5tYXAobWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCkuam9pbignJylcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdCQU5LQUNDT1VOVFMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdcXG5BY2NvdW50czpcXG4nICsgZGVjcnlwdGVkSXRlbXMubWFwKG1hcER5bmFtb0RCVG9BY2NvdW50KS5tYXAobWFwQWNjb3VudFRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VOUkVDT0dOSVpFRCBPUFRJT04gJyArIHR1cGxlWzBdKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIClcbiAgICBjb25zdCByYWdEYXRhID0gZGRiUmVzcG9uc2VzLmpvaW4oJycpXG4gICAgY29uc29sZS5pbmZvKCdGSU5BTCBSQUcgREFUQTogJywgcmFnRGF0YSlcbiAgICBjb25zdCB7IHByb21wdCB9ID0gZXZlbnQuYXJndW1lbnRzLmNoYXRcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNvbXBsZXRlQ2hhdEZyb21Qcm9tcHQoXG4gICAgICAgIHByb21wdCArICcgVXNlIHRoaXMgZGF0YSBmb3IgeW91ciBhbnN3ZXI6ICcgKyByYWdEYXRhIHx8ICcnLFxuICAgICAgICBldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMsXG4gICAgICAgIHVzZXIsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LnJlcXVpcmVzTGl2ZURhdGEgPz8gZmFsc2UsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRUeXBlID8/IENoYXRUeXBlLlJlZ3VsYXJcbiAgICApXG4gICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycz8ubWFwKChpZCkgPT4ge1xuICAgICAgICBjbGllbnQuc2VuZChcbiAgICAgICAgICAgIFB1dENhY2hlRW50aXR5KFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLmtleSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0OiBtYXBPZkNhY2hlVHlwZVRvRXhwaXJ5W2lkLmNhY2hlVHlwZSFdICsgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICAgICAgc2s6IGlkLmNhY2hlVHlwZT8udG9TdHJpbmcoKSA/PyAnJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgcmVzcG9uc2U6IHsgUzogcmVzcG9uc2UgfSB9XG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICB9KVxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3BvbnNlOiByZXNwb25zZSB8fCAnJyxcbiAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgfVxufVxuIl19