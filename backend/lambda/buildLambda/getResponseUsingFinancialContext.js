"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCacheKey = exports.getResponseUsingFinancialContext = void 0;
const API_1 = require("./API");
const gpt_1 = require("./gpt");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const Transactions_1 = require("./mappers/Transactions");
const CacheEntity_1 = require("./mappers/CacheEntity");
const Encryption_1 = require("./queries/Encryption");
const MonthlySummary_1 = require("./mappers/MonthlySummary");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
const dateSupportedFiltering = ['TRANSACTION', 'MONTHLYSUMMARY'];
const mapOfInformationOptionToKey = {
    ACCOUNTS: 'ACCOUNT',
    INVESTMENTS: 'SECURITY',
    TRANSACTIONS: 'TRANSACTION',
    MONTHLYSUMMARY: 'MONTHLYSUMMARY',
};
const mapOfCacheTypeToExpiry = {
    [API_1.CacheType.InvestmentAnalysis]: 60 * 60 * 1000 * 4,
    [API_1.CacheType.PortfolioAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockAnalysis]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.StockNews]: 60 * 60 * 1000 * 4,
    [API_1.CacheType.TransactionRecommendation]: 60 * 60 * 1000 * 24 * 5,
    [API_1.CacheType.GeneralRecommendation]: 60 * 60 * 1000 * 24,
    [API_1.CacheType.BudgetRecommendation]: 60 * 60 * 1000 * 24 * 20,
};
const getResponseUsingFinancialContext = async (event, context) => {
    const user = event.identity?.username;
    console.info('Get response for', event);
    const maxAccounts = event.arguments.chat.accountIds?.slice(0, 10) ?? [];
    let neededInfo = { optionsForInformation: [] };
    let dateRangeResponse;
    if (!event.arguments.chat.doNotUseAdvancedRag &&
        !(event.arguments.chat.currentDateRange && event.arguments.chat.highLevelCategory) &&
        !event.arguments.chat.doNotUseAdvancedRag) {
        const informationNeeded = (0, gpt_1.getNeededInformationFromModel)(event.arguments.chat.prompt || '');
        const dateRange = (0, gpt_1.getDateRangeFromModel)(event.arguments.chat.prompt || '');
        await Promise.all([informationNeeded, dateRange]);
        neededInfo = JSON.parse((await informationNeeded).content || '');
        dateRangeResponse = JSON.parse((await dateRange).content || '');
    }
    if (event.arguments.chat.cacheIdentifiers) {
        const cacheChecks = await Promise.all(event.arguments.chat.cacheIdentifiers.map((id) => {
            let cacheKey = (0, exports.getCacheKey)(user, id);
            return client.send((0, Entities_1.GetCacheEntity)({
                id: cacheKey || '',
                sk: id.cacheType?.toString() ?? '',
                expire_at: Date.now(),
            }));
        }));
        const itemHits = cacheChecks.flatMap((el) => el.Items ?? []);
        if (itemHits.length) {
            return {
                response: itemHits
                    .map(CacheEntity_1.mapDdbResponseToCacheEntity)
                    ?.map((el) => el.response)
                    .join('') || '',
                __typename: 'ChatResponse',
            };
        }
    }
    if (event.arguments.chat.chatFocus === API_1.ChatFocus.Investment &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.INVESTMENTS)) {
        neededInfo.optionsForInformation.push('INVESTMENTS');
    }
    else if ((event.arguments.chat.chatFocus === API_1.ChatFocus.Transaction ||
        event.arguments.chat.chatType === API_1.ChatType.TransactionRecommendation) &&
        !neededInfo.optionsForInformation.find((el) => el === gpt_1.InformationOptions.TRANSACTIONS)) {
        neededInfo.optionsForInformation.push('TRANSACTIONS');
    }
    if (event.arguments.chat.chatType === API_1.ChatType.GeneralRecommendation) {
        neededInfo.optionsForInformation = ['INVESTMENTS', 'ACCOUNTS', 'MONTHLYSUMMARY'];
    }
    if (event.arguments.chat.chatType === API_1.ChatType.RecommendBudget) {
        neededInfo.optionsForInformation = ['ACCOUNTS', 'MONTHLYSUMMARY'];
    }
    if (neededInfo.optionsForInformation?.length === 0) {
        neededInfo.optionsForInformation = ['ACCOUNTS', 'MONTHLYSUMMARY'];
    }
    console.info('Context: ', context);
    console.info('Needed info ', neededInfo);
    console.info('Date range: ', dateRangeResponse);
    let tupleOfTypeToElements;
    tupleOfTypeToElements = (await Promise.all(neededInfo.optionsForInformation.map(async (option) => {
        const entityName = mapOfInformationOptionToKey[option].toString();
        return await Promise.all(entityName !== 'MONTHLYSUMMARY'
            ? maxAccounts?.map(async (accountId) => {
                return [
                    option,
                    await client.send((0, Entities_1.GetEntities)({
                        username: user || '',
                        id: accountId || '',
                        dateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? dateRangeResponse
                            : undefined,
                        entityName: entityName,
                        customDateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? event.arguments.chat?.currentDateRange?.map((el) => el ? parseInt(el) : undefined) ?? undefined
                            : undefined,
                        highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
                    })),
                ];
            }) ?? [option, undefined]
            : [
                [
                    option,
                    await client.send((0, Entities_1.GetEntities)({
                        username: user || '',
                        id: 'v0',
                        dateRange: dateSupportedFiltering.find((el) => el === entityName)
                            ? dateRangeResponse
                            : undefined,
                        entityName: entityName,
                        customDateRange: undefined,
                        highLevelCategory: event.arguments.chat.highLevelCategory ?? undefined,
                    })),
                ],
            ]);
    }))).flatMap((el) => [...el]);
    /** Get the contextual data */
    const ddbResponses = await Promise.all(tupleOfTypeToElements.map(async (tuple) => {
        await tuple[0];
        const awaitedTuple = tuple;
        const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(awaitedTuple[1]?.Items ?? []);
        if (awaitedTuple[0].toString() === 'INVESTMENTS') {
            const mappedData = await (0, Security_1.mapSecuritiesToJoinedData)(decryptedItems);
            return '\nInvestments:\n' + (0, Security_1.mapJointDataToChatInput)(mappedData);
        }
        else if (awaitedTuple[0].toString() === 'TRANSACTIONS') {
            return ('\nTranasactions:\n' +
                decryptedItems.map(Transactions_1.mapDynamoDBToTransaction).map(Transactions_1.mapTransactionToChatInput).join(''));
        }
        else if (awaitedTuple[0].toString() === 'ACCOUNTS') {
            return '\nAccounts:\n' + decryptedItems.map(Accounts_1.mapDynamoDBToAccount).map(Accounts_1.mapAccountToChatInput).join('');
        }
        else if (awaitedTuple[0].toString() === 'MONTHLYSUMMARY') {
            return ('\nMonthly Spending:\n' +
                decryptedItems.map(MonthlySummary_1.mapDynamoDBToMonthlySummary).map(MonthlySummary_1.mapSpendingSummaryToChatInput).join(''));
        }
        else {
            throw new Error('UNRECOGNIZED OPTION ' + awaitedTuple[0]);
        }
    }));
    const ragData = ddbResponses.join('');
    console.info('FINAL RAG DATA: ', ragData);
    const { prompt } = event.arguments.chat;
    const response = await (0, gpt_1.completeChatFromPrompt)(prompt + ' Use this data for your answer: ' + ragData || '', event.arguments.chat.chatFocus, user, event.arguments.chat.requiresLiveData ?? false, event.arguments.chat.chatType ?? API_1.ChatType.Regular, event.arguments.chat.chatHistory ?? []);
    event.arguments.chat.cacheIdentifiers?.map((id) => {
        let cacheKey = (0, exports.getCacheKey)(user, id);
        client.send((0, Entities_1.PutCacheEntity)({
            id: cacheKey || '',
            expire_at: mapOfCacheTypeToExpiry[id.cacheType] + Date.now(),
            sk: id.cacheType?.toString() ?? '',
        }, { response: { S: response } }));
    });
    return {
        response: response || '',
        __typename: 'ChatResponse',
    };
};
exports.getResponseUsingFinancialContext = getResponseUsingFinancialContext;
const getCacheKey = (user, id) => {
    let cacheKey = id.key;
    if (id.cacheType === API_1.CacheType.InvestmentAnalysis ||
        id.cacheType === API_1.CacheType.PortfolioAnalysis ||
        id.cacheType === API_1.CacheType.TransactionRecommendation ||
        id.cacheType === API_1.CacheType.GeneralRecommendation) {
        cacheKey = user + id.key?.slice(0, 100);
    }
    return cacheKey;
};
exports.getCacheKey = getCacheKey;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2V0UmVzcG9uc2VVc2luZ0ZpbmFuY2lhbENvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStGO0FBQy9GLCtCQUF3SDtBQUN4SCw4REFBNkU7QUFDN0UsaURBQWdGO0FBQ2hGLGlEQUF1RjtBQUN2RixpREFBZ0Y7QUFDaEYseURBQTRGO0FBQzVGLHVEQUFtRTtBQUNuRSxxREFBNEQ7QUFDNUQsNkRBQXFHO0FBQ3JHLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtBQUVoRSxNQUFNLDJCQUEyQixHQUErQjtJQUM1RCxRQUFRLEVBQUUsU0FBUztJQUNuQixXQUFXLEVBQUUsVUFBVTtJQUN2QixZQUFZLEVBQUUsYUFBYTtJQUMzQixjQUFjLEVBQUUsZ0JBQWdCO0NBQ25DLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUE4QjtJQUN0RCxDQUFDLGVBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDbEQsQ0FBQyxlQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxFQUFFO0lBQ2xELENBQUMsZUFBUyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUU7SUFDOUMsQ0FBQyxlQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUN6QyxDQUFDLGVBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdB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O0lBQzNDLENBQUM7SUFDRCxPQUFPLFFBQVEsQ0FBQTtBQUNuQixDQUFDLENBQUE7QUFYWSxRQUFBLFdBQVcsZUFXdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvLCBBcHBTeW5jUmVzb2x2ZXJFdmVudCwgQXBwU3luY1Jlc29sdmVySGFuZGxlciwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBDaGF0Rm9jdXMsIENoYXRRdWVyeSwgQ2hhdFJlc3BvbnNlLCBDaGF0VHlwZSwgQ2FjaGVUeXBlLCBDYWNoZUlkZW50aWZlciB9IGZyb20gJy4vQVBJJ1xuaW1wb3J0IHsgSW5mb3JtYXRpb25PcHRpb25zLCBjb21wbGV0ZUNoYXRGcm9tUHJvbXB0LCBnZXREYXRlUmFuZ2VGcm9tTW9kZWwsIGdldE5lZWRlZEluZm9ybWF0aW9uRnJvbU1vZGVsIH0gZnJvbSAnLi9ncHQnXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUXVlcnlDb21tYW5kT3V0cHV0IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgR2V0Q2FjaGVFbnRpdHksIEdldEVudGl0aWVzLCBQdXRDYWNoZUVudGl0eSB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IG1hcEpvaW50RGF0YVRvQ2hhdElucHV0LCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhIH0gZnJvbSAnLi9tYXBwZXJzL1NlY3VyaXR5J1xuaW1wb3J0IHsgbWFwQWNjb3VudFRvQ2hhdElucHV0LCBtYXBEeW5hbW9EQlRvQWNjb3VudCB9IGZyb20gJy4vbWFwcGVycy9BY2NvdW50cydcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbiwgbWFwVHJhbnNhY3Rpb25Ub0NoYXRJbnB1dCB9IGZyb20gJy4vbWFwcGVycy9UcmFuc2FjdGlvbnMnXG5pbXBvcnQgeyBtYXBEZGJSZXNwb25zZVRvQ2FjaGVFbnRpdHkgfSBmcm9tICcuL21hcHBlcnMvQ2FjaGVFbnRpdHknXG5pbXBvcnQgeyBkZWNyeXB0SXRlbXNJbkJhdGNoZXMgfSBmcm9tICcuL3F1ZXJpZXMvRW5jcnlwdGlvbidcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9Nb250aGx5U3VtbWFyeSwgbWFwU3BlbmRpbmdTdW1tYXJ5VG9DaGF0SW5wdXQgfSBmcm9tICcuL21hcHBlcnMvTW9udGhseVN1bW1hcnknXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcgPSBbJ1RSQU5TQUNUSU9OJywgJ01PTlRITFlTVU1NQVJZJ11cbmV4cG9ydCB0eXBlIEVudGl0eU5hbWUgPSAnU0VDVVJJVFknIHwgJ1RSQU5TQUNUSU9OJyB8ICdBQ0NPVU5UJyB8ICdNT05USExZU1VNTUFSWSdcbmNvbnN0IG1hcE9mSW5mb3JtYXRpb25PcHRpb25Ub0tleTogUmVjb3JkPHN0cmluZywgRW50aXR5TmFtZT4gPSB7XG4gICAgQUNDT1VOVFM6ICdBQ0NPVU5UJyxcbiAgICBJTlZFU1RNRU5UUzogJ1NFQ1VSSVRZJyxcbiAgICBUUkFOU0FDVElPTlM6ICdUUkFOU0FDVElPTicsXG4gICAgTU9OVEhMWVNVTU1BUlk6ICdNT05USExZU1VNTUFSWScsXG59XG5cbmNvbnN0IG1hcE9mQ2FjaGVUeXBlVG9FeHBpcnk6IFJlY29yZDxDYWNoZVR5cGUsIG51bWJlcj4gPSB7XG4gICAgW0NhY2hlVHlwZS5JbnZlc3RtZW50QW5hbHlzaXNdOiA2MCAqIDYwICogMTAwMCAqIDQsXG4gICAgW0NhY2hlVHlwZS5Qb3J0Zm9saW9BbmFseXNpc106IDYwICogNjAgKiAxMDAwICogMjQsXG4gICAgW0NhY2hlVHlwZS5TdG9ja0FuYWx5c2lzXTogNjAgKiA2MCAqIDEwMDAgKiAyNCxcbiAgICBbQ2FjaGVUeXBlLlN0b2NrTmV3c106IDYwICogNjAgKiAxMDAwICogNCxcbiAgICBbQ2FjaGVUeXBlLlRyYW5zYWN0aW9uUmVjb21tZW5kYXRpb25dOiA2MCAqIDYwICogMTAwMCAqIDI0ICogNSxcbiAgICBbQ2FjaGVUeXBlLkdlbmVyYWxSZWNvbW1lbmRhdGlvbl06IDYwICogNjAgKiAxMDAwICogMjQsXG4gICAgW0NhY2hlVHlwZS5CdWRnZXRSZWNvbW1lbmRhdGlvbl06IDYwICogNjAgKiAxMDAwICogMjQgKiAyMCxcbn1cblxuZXhwb3J0IGNvbnN0IGdldFJlc3BvbnNlVXNpbmdGaW5hbmNpYWxDb250ZXh0OiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgQ2hhdFJlc3BvbnNlPiA9IGFzeW5jIChcbiAgICBldmVudDogQXBwU3luY1Jlc29sdmVyRXZlbnQ8eyBjaGF0OiBDaGF0UXVlcnkgfT4sXG4gICAgY29udGV4dDogQ29udGV4dFxuKSA9PiB7XG4gICAgY29uc3QgdXNlciA9IChldmVudC5pZGVudGl0eSBhcyBBcHBTeW5jSWRlbnRpdHlDb2duaXRvKT8udXNlcm5hbWVcbiAgICBjb25zb2xlLmluZm8oJ0dldCByZXNwb25zZSBmb3InLCBldmVudClcbiAgICBjb25zdCBtYXhBY2NvdW50cyA9IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmFjY291bnRJZHM/LnNsaWNlKDAsIDEwKSA/PyBbXVxuICAgIGxldCBuZWVkZWRJbmZvOiB7IG9wdGlvbnNGb3JJbmZvcm1hdGlvbjogSW5mb3JtYXRpb25PcHRpb25zW10gfSA9IHsgb3B0aW9uc0ZvckluZm9ybWF0aW9uOiBbXSB9XG4gICAgbGV0IGRhdGVSYW5nZVJlc3BvbnNlOiBhbnlcbiAgICBpZiAoXG4gICAgICAgICFldmVudC5hcmd1bWVudHMuY2hhdC5kb05vdFVzZUFkdmFuY2VkUmFnICYmXG4gICAgICAgICEoZXZlbnQuYXJndW1lbnRzLmNoYXQuY3VycmVudERhdGVSYW5nZSAmJiBldmVudC5hcmd1bWVudHMuY2hhdC5oaWdoTGV2ZWxDYXRlZ29yeSkgJiZcbiAgICAgICAgIWV2ZW50LmFyZ3VtZW50cy5jaGF0LmRvTm90VXNlQWR2YW5jZWRSYWdcbiAgICApIHtcbiAgICAgICAgY29uc3QgaW5mb3JtYXRpb25OZWVkZWQgPSBnZXROZWVkZWRJbmZvcm1hdGlvbkZyb21Nb2RlbChldmVudC5hcmd1bWVudHMuY2hhdC5wcm9tcHQgfHwgJycpXG4gICAgICAgIGNvbnN0IGRhdGVSYW5nZSA9IGdldERhdGVSYW5nZUZyb21Nb2RlbChldmVudC5hcmd1bWVudHMuY2hhdC5wcm9tcHQgfHwgJycpXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtpbmZvcm1hdGlvbk5lZWRlZCwgZGF0ZVJhbmdlXSlcbiAgICAgICAgbmVlZGVkSW5mbyA9IEpTT04ucGFyc2UoKGF3YWl0IGluZm9ybWF0aW9uTmVlZGVkKS5jb250ZW50IHx8ICcnKVxuICAgICAgICBkYXRlUmFuZ2VSZXNwb25zZSA9IEpTT04ucGFyc2UoKGF3YWl0IGRhdGVSYW5nZSkuY29udGVudCB8fCAnJylcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycykge1xuICAgICAgICBjb25zdCBjYWNoZUNoZWNrcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycy5tYXAoKGlkKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkodXNlciwgaWQpXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldENhY2hlRW50aXR5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBjYWNoZUtleSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNrOiBpZC5jYWNoZVR5cGU/LnRvU3RyaW5nKCkgPz8gJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBpcmVfYXQ6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICBjb25zdCBpdGVtSGl0cyA9IGNhY2hlQ2hlY2tzLmZsYXRNYXAoKGVsKSA9PiBlbC5JdGVtcyA/PyBbXSlcbiAgICAgICAgaWYgKGl0ZW1IaXRzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZTpcbiAgICAgICAgICAgICAgICAgICAgaXRlbUhpdHNcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAobWFwRGRiUmVzcG9uc2VUb0NhY2hlRW50aXR5KVxuICAgICAgICAgICAgICAgICAgICAgICAgPy5tYXAoKGVsKSA9PiBlbC5yZXNwb25zZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5qb2luKCcnKSB8fCAnJyxcbiAgICAgICAgICAgICAgICBfX3R5cGVuYW1lOiAnQ2hhdFJlc3BvbnNlJyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyA9PT0gQ2hhdEZvY3VzLkludmVzdG1lbnQgJiZcbiAgICAgICAgIW5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLmZpbmQoKGVsKSA9PiBlbCA9PT0gSW5mb3JtYXRpb25PcHRpb25zLklOVkVTVE1FTlRTKVxuICAgICkge1xuICAgICAgICBuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5wdXNoKCdJTlZFU1RNRU5UUycgYXMgYW55KVxuICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIChldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0Rm9jdXMgPT09IENoYXRGb2N1cy5UcmFuc2FjdGlvbiB8fFxuICAgICAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdFR5cGUgPT09IENoYXRUeXBlLlRyYW5zYWN0aW9uUmVjb21tZW5kYXRpb24pICYmXG4gICAgICAgICFuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbi5maW5kKChlbCkgPT4gZWwgPT09IEluZm9ybWF0aW9uT3B0aW9ucy5UUkFOU0FDVElPTlMpXG4gICAgKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLnB1c2goJ1RSQU5TQUNUSU9OUycgYXMgYW55KVxuICAgIH1cblxuICAgIGlmIChldmVudC5hcmd1bWVudHMuY2hhdC5jaGF0VHlwZSA9PT0gQ2hhdFR5cGUuR2VuZXJhbFJlY29tbWVuZGF0aW9uKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uID0gWydJTlZFU1RNRU5UUycgYXMgYW55LCAnQUNDT1VOVFMnIGFzIGFueSwgJ01PTlRITFlTVU1NQVJZJyBhcyBhbnldXG4gICAgfVxuXG4gICAgaWYgKGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRUeXBlID09PSBDaGF0VHlwZS5SZWNvbW1lbmRCdWRnZXQpIHtcbiAgICAgICAgbmVlZGVkSW5mby5vcHRpb25zRm9ySW5mb3JtYXRpb24gPSBbJ0FDQ09VTlRTJyBhcyBhbnksICdNT05USExZU1VNTUFSWScgYXMgYW55XVxuICAgIH1cblxuICAgIGlmIChuZWVkZWRJbmZvLm9wdGlvbnNGb3JJbmZvcm1hdGlvbj8ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uID0gWydBQ0NPVU5UUycgYXMgYW55LCAnTU9OVEhMWVNVTU1BUlknIGFzIGFueV1cbiAgICB9XG5cbiAgICBjb25zb2xlLmluZm8oJ0NvbnRleHQ6ICcsIGNvbnRleHQpXG4gICAgY29uc29sZS5pbmZvKCdOZWVkZWQgaW5mbyAnLCBuZWVkZWRJbmZvKVxuICAgIGNvbnNvbGUuaW5mbygnRGF0ZSByYW5nZTogJywgZGF0ZVJhbmdlUmVzcG9uc2UpXG4gICAgbGV0IHR1cGxlT2ZUeXBlVG9FbGVtZW50czogW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgdHVwbGVPZlR5cGVUb0VsZW1lbnRzID0gKFxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgIG5lZWRlZEluZm8ub3B0aW9uc0ZvckluZm9ybWF0aW9uLm1hcChhc3luYyAob3B0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW50aXR5TmFtZSA9IG1hcE9mSW5mb3JtYXRpb25PcHRpb25Ub0tleVtvcHRpb25dLnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWUgIT09ICdNT05USExZU1VNTUFSWSdcbiAgICAgICAgICAgICAgICAgICAgICAgID8gbWF4QWNjb3VudHM/Lm1hcChhc3luYyAoYWNjb3VudElkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGllbnQuc2VuZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR2V0RW50aXRpZXMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXIgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYWNjb3VudElkIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nLmZpbmQoKGVsKSA9PiBlbCA9PT0gZW50aXR5TmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGRhdGVSYW5nZVJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lOiBlbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0ZVJhbmdlOiBkYXRlU3VwcG9ydGVkRmlsdGVyaW5nLmZpbmQoKGVsKSA9PiBlbCA9PT0gZW50aXR5TmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IChldmVudC5hcmd1bWVudHMuY2hhdD8uY3VycmVudERhdGVSYW5nZT8ubWFwKChlbCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA/IHBhcnNlSW50KGVsKSA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSBhcyBhbnkpID8/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlnaExldmVsQ2F0ZWdvcnk6IGV2ZW50LmFyZ3VtZW50cy5jaGF0LmhpZ2hMZXZlbENhdGVnb3J5ID8/IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KSA/PyBbb3B0aW9uLCB1bmRlZmluZWRdXG4gICAgICAgICAgICAgICAgICAgICAgICA6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICd2MCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlUmFuZ2U6IGRhdGVTdXBwb3J0ZWRGaWx0ZXJpbmcuZmluZCgoZWwpID0+IGVsID09PSBlbnRpdHlOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0ZVJhbmdlUmVzcG9uc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6IGVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21EYXRlUmFuZ2U6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hMZXZlbENhdGVnb3J5OiBldmVudC5hcmd1bWVudHMuY2hhdC5oaWdoTGV2ZWxDYXRlZ29yeSA/PyB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgKS5mbGF0TWFwKChlbDogYW55KSA9PiBbLi4uZWxdKSBhcyBhbnkgYXMgW0luZm9ybWF0aW9uT3B0aW9ucywgUXVlcnlDb21tYW5kT3V0cHV0XVtdXG4gICAgLyoqIEdldCB0aGUgY29udGV4dHVhbCBkYXRhICovXG4gICAgY29uc3QgZGRiUmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHR1cGxlT2ZUeXBlVG9FbGVtZW50cy5tYXAoYXN5bmMgKHR1cGxlKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0dXBsZVswXVxuICAgICAgICAgICAgY29uc3QgYXdhaXRlZFR1cGxlID0gdHVwbGVcbiAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZEl0ZW1zID0gYXdhaXQgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzKGF3YWl0ZWRUdXBsZVsxXT8uSXRlbXMgPz8gW10pXG4gICAgICAgICAgICBpZiAoYXdhaXRlZFR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdJTlZFU1RNRU5UUycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXBwZWREYXRhID0gYXdhaXQgbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YShkZWNyeXB0ZWRJdGVtcylcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1xcbkludmVzdG1lbnRzOlxcbicgKyBtYXBKb2ludERhdGFUb0NoYXRJbnB1dChtYXBwZWREYXRhKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChhd2FpdGVkVHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ1RSQU5TQUNUSU9OUycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICAnXFxuVHJhbmFzYWN0aW9uczpcXG4nICtcbiAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkSXRlbXMubWFwKG1hcER5bmFtb0RCVG9UcmFuc2FjdGlvbikubWFwKG1hcFRyYW5zYWN0aW9uVG9DaGF0SW5wdXQpLmpvaW4oJycpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChhd2FpdGVkVHVwbGVbMF0udG9TdHJpbmcoKSA9PT0gJ0FDQ09VTlRTJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnXFxuQWNjb3VudHM6XFxuJyArIGRlY3J5cHRlZEl0ZW1zLm1hcChtYXBEeW5hbW9EQlRvQWNjb3VudCkubWFwKG1hcEFjY291bnRUb0NoYXRJbnB1dCkuam9pbignJylcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXdhaXRlZFR1cGxlWzBdLnRvU3RyaW5nKCkgPT09ICdNT05USExZU1VNTUFSWScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICAnXFxuTW9udGhseSBTcGVuZGluZzpcXG4nICtcbiAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkSXRlbXMubWFwKG1hcER5bmFtb0RCVG9Nb250aGx5U3VtbWFyeSkubWFwKG1hcFNwZW5kaW5nU3VtbWFyeVRvQ2hhdElucHV0KS5qb2luKCcnKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVTlJFQ09HTklaRUQgT1BUSU9OICcgKyBhd2FpdGVkVHVwbGVbMF0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgKVxuICAgIGNvbnN0IHJhZ0RhdGEgPSBkZGJSZXNwb25zZXMuam9pbignJylcbiAgICBjb25zb2xlLmluZm8oJ0ZJTkFMIFJBRyBEQVRBOiAnLCByYWdEYXRhKVxuICAgIGNvbnN0IHsgcHJvbXB0IH0gPSBldmVudC5hcmd1bWVudHMuY2hhdFxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY29tcGxldGVDaGF0RnJvbVByb21wdChcbiAgICAgICAgcHJvbXB0ICsgJyBVc2UgdGhpcyBkYXRhIGZvciB5b3VyIGFuc3dlcjogJyArIHJhZ0RhdGEgfHwgJycsXG4gICAgICAgIGV2ZW50LmFyZ3VtZW50cy5jaGF0LmNoYXRGb2N1cyxcbiAgICAgICAgdXNlcixcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQucmVxdWlyZXNMaXZlRGF0YSA/PyBmYWxzZSxcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdFR5cGUgPz8gQ2hhdFR5cGUuUmVndWxhcixcbiAgICAgICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2hhdEhpc3RvcnkgPz8gW11cbiAgICApXG4gICAgZXZlbnQuYXJndW1lbnRzLmNoYXQuY2FjaGVJZGVudGlmaWVycz8ubWFwKChpZCkgPT4ge1xuICAgICAgICBsZXQgY2FjaGVLZXkgPSBnZXRDYWNoZUtleSh1c2VyLCBpZClcbiAgICAgICAgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICBQdXRDYWNoZUVudGl0eShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBjYWNoZUtleSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0OiBtYXBPZkNhY2hlVHlwZVRvRXhwaXJ5W2lkLmNhY2hlVHlwZSFdICsgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICAgICAgc2s6IGlkLmNhY2hlVHlwZT8udG9TdHJpbmcoKSA/PyAnJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgcmVzcG9uc2U6IHsgUzogcmVzcG9uc2UgfSB9XG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICB9KVxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3BvbnNlOiByZXNwb25zZSB8fCAnJyxcbiAgICAgICAgX190eXBlbmFtZTogJ0NoYXRSZXNwb25zZScsXG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgZ2V0Q2FjaGVLZXkgPSAodXNlcjogc3RyaW5nLCBpZDogQ2FjaGVJZGVudGlmZXIpID0+IHtcbiAgICBsZXQgY2FjaGVLZXkgPSBpZC5rZXlcbiAgICBpZiAoXG4gICAgICAgIGlkLmNhY2hlVHlwZSA9PT0gQ2FjaGVUeXBlLkludmVzdG1lbnRBbmFseXNpcyB8fFxuICAgICAgICBpZC5jYWNoZVR5cGUgPT09IENhY2hlVHlwZS5Qb3J0Zm9saW9BbmFseXNpcyB8fFxuICAgICAgICBpZC5jYWNoZVR5cGUgPT09IENhY2hlVHlwZS5UcmFuc2FjdGlvblJlY29tbWVuZGF0aW9uIHx8XG4gICAgICAgIGlkLmNhY2hlVHlwZSA9PT0gQ2FjaGVUeXBlLkdlbmVyYWxSZWNvbW1lbmRhdGlvblxuICAgICkge1xuICAgICAgICBjYWNoZUtleSA9IHVzZXIgKyBpZC5rZXk/LnNsaWNlKDAsIDEwMClcbiAgICB9XG4gICAgcmV0dXJuIGNhY2hlS2V5XG59XG4iXX0=