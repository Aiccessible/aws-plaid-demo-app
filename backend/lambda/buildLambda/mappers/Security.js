"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mapHoldingsAndSecuritiesToJointData = exports.mapJointDataToChatInput = void 0;
exports.mapDynamoDBToSecurityDetails = mapDynamoDBToSecurityDetails;
exports.mapSecuritiesToJoinedData = mapSecuritiesToJoinedData;
const InvestmentHoldings_1 = require("./InvestmentHoldings");
// Mapper function for DynamoDB to SecurityDetails interface
function mapDynamoDBToSecurityDetails(item) {
    return {
        close_price: parseFloat(item.close_price?.N || ''), // DynamoDB number type
        close_price_as_of: item.close_price_as_of?.S || null, // Nullable string
        cusip: item.cusip?.S || '',
        institution_id: item.institution_id?.S || null, // Nullable string
        institution_security_id: item.institution_security_id?.S || null, // Nullable string
        is_cash_equivalent: item.is_cash_equivalent?.BOOL || false, // Boolean type
        isin: item.isin?.S || '',
        iso_currency_code: item.iso_currency_code?.S || '',
        name: item.name?.S || '',
        proxy_security_id: item.proxy_security_id?.S || null, // Nullable string
        security_id: item.security_id?.S || '',
        sedol: item.sedol?.S || null, // Nullable string
        ticker_symbol: item.ticker_symbol?.S || '',
        type: item.type?.S || '',
        unofficial_currency_code: item.unofficial_currency_code?.S || null, // Nullable string
        market_identifier_code: item.market_identifier_code?.S || '',
        option_contract: item.option_contract?.S || null, // Nullable string
        plaid_type: item.plaid_type?.S ?? '',
        __typename: 'Security',
    };
}
function mapSecuritiesToJoinedData(items) {
    const mappedItems = items.map((item) => {
        if (item.plaid_type?.S === 'Security') {
            return mapDynamoDBToSecurityDetails(item);
        }
        else if (item.plaid_type?.S === 'Holding') {
            return (0, InvestmentHoldings_1.mapDynamoDBToInvestmentHolding)(item);
        }
        else {
            throw new Error('Unsupported type');
        }
    });
    return (0, exports.mapHoldingsAndSecuritiesToJointData)(mappedItems);
}
const mapJointDataToChatInput = (jointData) => {
    const chatInputs = [];
    // Iterate over the values in the `jointData` object
    Object.values(jointData).forEach(({ security, holding }) => {
        let chatInput = '(';
        if (security) {
            // Process security fields into a chat message
            chatInput += `Security Name: ${security.name || 'N/A'}\n`;
            chatInput += `Ticker Symbol: ${security.ticker_symbol || 'N/A'}\n`;
            chatInput += `Close Price: ${security.close_price ? `$${security.close_price.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Close Price As Of: ${security.close_price_as_of || 'N/A'}\n`;
            chatInput += `Sector: ${security.sector || 'N/A'}\n`;
            chatInput += `Industry: ${security.industry || 'N/A'}\n`;
        }
        if (holding) {
            // Process holding fields into the same message
            chatInput += `Quantity: ${holding.quantity || 'N/A'}\n`;
            chatInput += `Cost Basis: ${holding.cost_basis ? `$${holding.cost_basis.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Value: ${holding.institution_value ? `$${holding.institution_value.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Price: ${holding.institution_price ? `$${holding.institution_price.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Price As Of: ${holding.institution_price_as_of || 'N/A'}`;
        }
        chatInput += ')\n';
        chatInputs.push(chatInput);
    });
    return chatInputs.join('');
};
exports.mapJointDataToChatInput = mapJointDataToChatInput;
const mapHoldingsAndSecuritiesToJointData = (holdings) => {
    const getId = (el) => el.account_id + '-' + el.security_id;
    const accountAndsecurityIdToEntity = {};
    const investments = [...holdings];
    investments?.forEach((el) => {
        if (el.plaid_type === 'Holding') {
            accountAndsecurityIdToEntity[getId(el)] = {
                security: investments?.find((sec) => sec.plaid_type === 'Security' && sec.security_id === el.security_id),
                holding: el,
            };
        }
    });
    return accountAndsecurityIdToEntity;
};
exports.mapHoldingsAndSecuritiesToJointData = mapHoldingsAndSecuritiesToJointData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VjdXJpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFwcGVycy9TZWN1cml0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFLQSxvRUFzQkM7QUFFRCw4REFXQztBQXRDRCw2REFBcUU7QUFFckUsNERBQTREO0FBQzVELFNBQWdCLDRCQUE0QixDQUFDLElBQXVDO0lBQ2hGLE9BQU87UUFDSCxXQUFXLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLHVCQUF1QjtRQUMzRSxpQkFBaUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxrQkFBa0I7UUFDeEUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUU7UUFDMUIsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxrQkFBa0I7UUFDbEUsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUUsa0JBQWtCO1FBQ3BGLGtCQUFrQixFQUFFLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLElBQUksS0FBSyxFQUFFLGVBQWU7UUFDM0UsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUU7UUFDeEIsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxFQUFFO1FBQ2xELElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFO1FBQ3hCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLGtCQUFrQjtRQUN4RSxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRTtRQUN0QyxLQUFLLEVBQUUsSUFBSSxDQUFD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LEdBQUcsQ0FBQyxVQUFVLEtBQUssVUFBVSxJQUFJLEdBQUcsQ0FBQyxXQUFXLEtBQUssRUFBRSxDQUFDLFdBQVcsQ0FDdkQ7Z0JBQ3pCLE9BQU8sRUFBRSxFQUFhO2FBQ3pCLENBQUE7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7SUFDRixPQUFPLDRCQUE0QixDQUFBO0FBQ3ZDLENBQUMsQ0FBQTtBQWZZLFFBQUEsbUNBQW1DLHVDQWUvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF0dHJpYnV0ZVZhbHVlIH0gZnJvbSAnYXdzLXNkay9jbGllbnRzL2R5bmFtb2RiJ1xuaW1wb3J0IHsgSG9sZGluZywgU2VjdXJpdHkgfSBmcm9tICcuLi9BUEknXG5pbXBvcnQgeyBtYXBEeW5hbW9EQlRvSW52ZXN0bWVudEhvbGRpbmcgfSBmcm9tICcuL0ludmVzdG1lbnRIb2xkaW5ncydcblxuLy8gTWFwcGVyIGZ1bmN0aW9uIGZvciBEeW5hbW9EQiB0byBTZWN1cml0eURldGFpbHMgaW50ZXJmYWNlXG5leHBvcnQgZnVuY3Rpb24gbWFwRHluYW1vREJUb1NlY3VyaXR5RGV0YWlscyhpdGVtOiB7IFtrZXk6IHN0cmluZ106IEF0dHJpYnV0ZVZhbHVlIH0pOiBTZWN1cml0eSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xvc2VfcHJpY2U6IHBhcnNlRmxvYXQoaXRlbS5jbG9zZV9wcmljZT8uTiB8fCAnJyksIC8vIER5bmFtb0RCIG51bWJlciB0eXBlXG4gICAgICAgIGNsb3NlX3ByaWNlX2FzX29mOiBpdGVtLmNsb3NlX3ByaWNlX2FzX29mPy5TIHx8IG51bGwsIC8vIE51bGxhYmxlIHN0cmluZ1xuICAgICAgICBjdXNpcDogaXRlbS5jdXNpcD8uUyB8fCAnJyxcbiAgICAgICAgaW5zdGl0dXRpb25faWQ6IGl0ZW0uaW5zdGl0dXRpb25faWQ/LlMgfHwgbnVsbCwgLy8gTnVsbGFibGUgc3RyaW5nXG4gICAgICAgIGluc3RpdHV0aW9uX3NlY3VyaXR5X2lkOiBpdGVtLmluc3RpdHV0aW9uX3NlY3VyaXR5X2lkPy5TIHx8IG51bGwsIC8vIE51bGxhYmxlIHN0cmluZ1xuICAgICAgICBpc19jYXNoX2VxdWl2YWxlbnQ6IGl0ZW0uaXNfY2FzaF9lcXVpdmFsZW50Py5CT09MIHx8IGZhbHNlLCAvLyBCb29sZWFuIHR5cGVcbiAgICAgICAgaXNpbjogaXRlbS5pc2luPy5TIHx8ICcnLFxuICAgICAgICBpc29fY3VycmVuY3lfY29kZTogaXRlbS5pc29fY3VycmVuY3lfY29kZT8uUyB8fCAnJyxcbiAgICAgICAgbmFtZTogaXRlbS5uYW1lPy5TIHx8ICcnLFxuICAgICAgICBwcm94eV9zZWN1cml0eV9pZDogaXRlbS5wcm94eV9zZWN1cml0eV9pZD8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgc2VjdXJpdHlfaWQ6IGl0ZW0uc2VjdXJpdHlfaWQ/LlMgfHwgJycsXG4gICAgICAgIHNlZG9sOiBpdGVtLnNlZG9sPy5TIHx8IG51bGwsIC8vIE51bGxhYmxlIHN0cmluZ1xuICAgICAgICB0aWNrZXJfc3ltYm9sOiBpdGVtLnRpY2tlcl9zeW1ib2w/LlMgfHwgJycsXG4gICAgICAgIHR5cGU6IGl0ZW0udHlwZT8uUyB8fCAnJyxcbiAgICAgICAgdW5vZmZpY2lhbF9jdXJyZW5jeV9jb2RlOiBpdGVtLnVub2ZmaWNpYWxfY3VycmVuY3lfY29kZT8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgbWFya2V0X2lkZW50aWZpZXJfY29kZTogaXRlbS5tYXJrZXRfaWRlbnRpZmllcl9jb2RlPy5TIHx8ICcnLFxuICAgICAgICBvcHRpb25fY29udHJhY3Q6IGl0ZW0ub3B0aW9uX2NvbnRyYWN0Py5TIHx8IG51bGwsIC8vIE51bGxhYmxlIHN0cmluZ1xuICAgICAgICBwbGFpZF90eXBlOiBpdGVtLnBsYWlkX3R5cGU/LlMgPz8gJycsXG4gICAgICAgIF9fdHlwZW5hbWU6ICdTZWN1cml0eScsXG4gICAgfVxufVxudHlwZSBKb2luZWRTZWN1cml0eURhdGEgPSBSZWNvcmQ8c3RyaW5nLCB7IHNlY3VyaXR5OiBTZWN1cml0eSB8IHVuZGVmaW5lZDsgaG9sZGluZzogSG9sZGluZyB9PlxuZXhwb3J0IGZ1bmN0aW9uIG1hcFNlY3VyaXRpZXNUb0pvaW5lZERhdGEoaXRlbXM6IHsgW2tleTogc3RyaW5nXTogQXR0cmlidXRlVmFsdWUgfVtdKTogSm9pbmVkU2VjdXJpdHlEYXRhIHtcbiAgICBjb25zdCBtYXBwZWRJdGVtcyA9IGl0ZW1zLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXRlbS5wbGFpZF90eXBlPy5TID09PSAnU2VjdXJpdHknKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFwRHluYW1vREJUb1NlY3VyaXR5RGV0YWlscyhpdGVtKVxuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ucGxhaWRfdHlwZT8uUyA9PT0gJ0hvbGRpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFwRHluYW1vREJUb0ludmVzdG1lbnRIb2xkaW5nKGl0ZW0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHR5cGUnKVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gbWFwSG9sZGluZ3NBbmRTZWN1cml0aWVzVG9Kb2ludERhdGEobWFwcGVkSXRlbXMpXG59XG5cbmV4cG9ydCBjb25zdCBtYXBKb2ludERhdGFUb0NoYXRJbnB1dCA9IChqb2ludERhdGE6IEpvaW5lZFNlY3VyaXR5RGF0YSk6IHN0cmluZyA9PiB7XG4gICAgY29uc3QgY2hhdElucHV0czogc3RyaW5nW10gPSBbXVxuICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgdmFsdWVzIGluIHRoZSBgam9pbnREYXRhYCBvYmplY3RcbiAgICBPYmplY3QudmFsdWVzKGpvaW50RGF0YSkuZm9yRWFjaCgoeyBzZWN1cml0eSwgaG9sZGluZyB9KSA9PiB7XG4gICAgICAgIGxldCBjaGF0SW5wdXQgPSAnKCdcblxuICAgICAgICBpZiAoc2VjdXJpdHkpIHtcbiAgICAgICAgICAgIC8vIFByb2Nlc3Mgc2VjdXJpdHkgZmllbGRzIGludG8gYSBjaGF0IG1lc3NhZ2VcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgU2VjdXJpdHkgTmFtZTogJHtzZWN1cml0eS5uYW1lIHx8ICdOL0EnfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgVGlja2VyIFN5bWJvbDogJHtzZWN1cml0eS50aWNrZXJfc3ltYm9sIHx8ICdOL0EnfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgQ2xvc2UgUHJpY2U6ICR7c2VjdXJpdHkuY2xvc2VfcHJpY2UgPyBgJCR7c2VjdXJpdHkuY2xvc2VfcHJpY2UudG9GaXhlZCgyKX1gIDogJ04vQSd9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBDbG9zZSBQcmljZSBBcyBPZjogJHtzZWN1cml0eS5jbG9zZV9wcmljZV9hc19vZiB8fCAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYFNlY3RvcjogJHtzZWN1cml0eS5zZWN0b3IgfHwgJ04vQSd9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBJbmR1c3RyeTogJHtzZWN1cml0eS5pbmR1c3RyeSB8fCAnTi9BJ31cXG5gXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaG9sZGluZykge1xuICAgICAgICAgICAgLy8gUHJvY2VzcyBob2xkaW5nIGZpZWxkcyBpbnRvIHRoZSBzYW1lIG1lc3NhZ2VcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgUXVhbnRpdHk6ICR7aG9sZGluZy5xdWFudGl0eSB8fCAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYENvc3QgQmFzaXM6ICR7aG9sZGluZy5jb3N0X2Jhc2lzID8gYCQke2hvbGRpbmcuY29zdF9iYXNpcy50b0ZpeGVkKDIpfWAgOiAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYEluc3RpdHV0aW9uIFZhbHVlOiAke1xuICAgICAgICAgICAgICAgIGhvbGRpbmcuaW5zdGl0dXRpb25fdmFsdWUgPyBgJCR7aG9sZGluZy5pbnN0aXR1dGlvbl92YWx1ZS50b0ZpeGVkKDIpfWAgOiAnTi9BJ1xuICAgICAgICAgICAgfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgSW5zdGl0dXRpb24gUHJpY2U6ICR7XG4gICAgICAgICAgICAgICAgaG9sZGluZy5pbnN0aXR1dGlvbl9wcmljZSA/IGAkJHtob2xkaW5nLmluc3RpdHV0aW9uX3ByaWNlLnRvRml4ZWQoMil9YCA6ICdOL0EnXG4gICAgICAgICAgICB9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBJbnN0aXR1dGlvbiBQcmljZSBBcyBPZjogJHtob2xkaW5nLmluc3RpdHV0aW9uX3ByaWNlX2FzX29mIHx8ICdOL0EnfWBcbiAgICAgICAgfVxuICAgICAgICBjaGF0SW5wdXQgKz0gJylcXG4nXG4gICAgICAgIGNoYXRJbnB1dHMucHVzaChjaGF0SW5wdXQpXG4gICAgfSlcbiAgICByZXR1cm4gY2hhdElucHV0cy5qb2luKCcnKVxufVxuXG5leHBvcnQgY29uc3QgbWFwSG9sZGluZ3NBbmRTZWN1cml0aWVzVG9Kb2ludERhdGEgPSAoaG9sZGluZ3M6IChIb2xkaW5nIHwgU2VjdXJpdHkpW10pID0+IHtcbiAgICBjb25zdCBnZXRJZCA9IChlbDogSG9sZGluZyB8IFNlY3VyaXR5KSA9PiBlbC5hY2NvdW50X2lkICsgJy0nICsgZWwuc2VjdXJpdHlfaWRcbiAgICBjb25zdCBhY2NvdW50QW5kc2VjdXJpdHlJZFRvRW50aXR5OiBKb2luZWRTZWN1cml0eURhdGEgPSB7fVxuICAgIGNvbnN0IGludmVzdG1lbnRzID0gWy4uLmhvbGRpbmdzXVxuICAgIGludmVzdG1lbnRzPy5mb3JFYWNoKChlbCkgPT4ge1xuICAgICAgICBpZiAoZWwucGxhaWRfdHlwZSA9PT0gJ0hvbGRpbmcnKSB7XG4gICAgICAgICAgICBhY2NvdW50QW5kc2VjdXJpdHlJZFRvRW50aXR5W2dldElkKGVsKV0gPSB7XG4gICAgICAgICAgICAgICAgc2VjdXJpdHk6IGludmVzdG1lbnRzPy5maW5kKFxuICAgICAgICAgICAgICAgICAgICAoc2VjKSA9PiBzZWMucGxhaWRfdHlwZSA9PT0gJ1NlY3VyaXR5JyAmJiBzZWMuc2VjdXJpdHlfaWQgPT09IGVsLnNlY3VyaXR5X2lkXG4gICAgICAgICAgICAgICAgKSBhcyBTZWN1cml0eSB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBob2xkaW5nOiBlbCBhcyBIb2xkaW5nLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gYWNjb3VudEFuZHNlY3VyaXR5SWRUb0VudGl0eVxufVxuIl19