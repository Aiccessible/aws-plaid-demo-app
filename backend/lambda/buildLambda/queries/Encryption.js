"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decryptItemsInBatches = decryptItemsInBatches;
const client_kms_1 = require("@aws-sdk/client-kms");
const kmsClient = new client_kms_1.KMSClient({ region: 'ca-central-1' });
const KEY_ARN = process.env.KEY_ARN;
async function encryptData(data) {
    const command = new client_kms_1.EncryptCommand({
        KeyId: KEY_ARN,
        Plaintext: Buffer.from(data),
    });
    const response = await kmsClient.send(command);
    return response.CiphertextBlob?.toString() || '';
}
async function decryptData(encryptedData) {
    const command = new client_kms_1.DecryptCommand({
        CiphertextBlob: Buffer.from(encryptedData, 'base64'),
    });
    const response = await kmsClient.send(command);
    return response.Plaintext?.toString() || '';
}
async function decryptItemsInBatches(items) {
    if (process.env.STAGE !== 'prod') {
        return items;
    }
    const decryptedItems = [];
    // Split items into batches of 100
    for (let i = 0; i < items.length; i += 100) {
        const batch = items.slice(i, i + 100);
        // Decrypt each item in the batch concurrently
        const decryptedBatch = await Promise.all(batch.map(async (item) => {
            const decryptedItem = {};
            for (const [key, value] of Object.entries(item)) {
                if (key === 'pk' || key === 'sk') {
                    decryptedItem[key] = value;
                    continue;
                }
                if (value && value.S) {
                    // Decrypt string attributes
                    decryptedItem[key] = await decryptData(value.S);
                }
                else if (value && value.N) {
                    // Keep numbers as they are
                    decryptedItem[key] = value.N;
                }
                else if (value && value.B) {
                    // Decrypt binary attributes
                    const decryptedValue = await decryptData(value.B.toString('base64'));
                    decryptedItem[key] = Buffer.from(decryptedValue, 'base64');
                }
                else if (value && value.BOOL !== undefined) {
                    decryptedItem[key] = value.BOOL;
                }
                else if (value && value.NULL !== undefined) {
                    decryptedItem[key] = null;
                }
                else if (value && value.L) {
                    // Handle lists by recursively decrypting each element
                    decryptedItem[key] = await Promise.all(value.L.map(async (item) => await decryptData(item)));
                }
                else if (value && value.M) {
                    // Handle maps by recursively decrypting each attribute in the map
                    const decryptedMap = {};
                    for (const [mapKey, mapValue] of Object.entries(value.M)) {
                        decryptedMap[mapKey] = await decryptData(mapValue);
                    }
                    decryptedItem[key] = decryptedMap;
                }
                else {
                    // If attribute type is unrecognized, return as-is
                    decryptedItem[key] = value;
                }
            }
            return decryptedItem;
        }));
        // Add the decrypted batch to the final list of decrypted items
        decryptedItems.push(...decryptedBatch);
    }
    return decryptedItems;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW5jcnlwdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL0VuY3J5cHRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUEwQkEsc0RBNkRDO0FBdEZELG9EQUErRTtBQUUvRSxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQTtBQUUzRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQTtBQUVuQyxLQUFLLFVBQVUsV0FBVyxDQUFDLElBQVk7SUFDbkMsTUFBTSxPQUFPLEdBQUcsSUFBSSwyQkFBYyxDQUFDO1FBQy9CLEtBQUssRUFBRSxPQUFPO1FBQ2QsU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0tBQy9CLENBQUMsQ0FBQTtJQUVGLE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUM5QyxPQUFPLFFBQVEsQ0FBQyxjQUFjLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFBO0FBQ3BELENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLGFBQXFCO0lBQzVDLE1BQU0sT0FBTyxHQUFHLElBQUksMkJBQWMsQ0FBQztRQUMvQixjQUFjLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDO0tBQ3ZELENBQUMsQ0FBQTtJQUVGLE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUM5QyxPQUFPLFFBQVEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFBO0FBQy9DLENBQUM7QUFFTSxLQUFLLFVBQVUscUJBQXFCLENBQUMsS0FBNEI7SUFDcEUsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxNQUFNLEVBQUUs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Q0FBQyxDQUFBO29CQUNoRSxDQUFDO29CQUNELGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxZQUFZLENBQUE7Z0JBQ3JDLENBQUM7cUJBQU0sQ0FBQztvQkFDSixrREFBa0Q7b0JBQ2xELGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUE7Z0JBQzlCLENBQUM7WUFDTCxDQUFDO1lBRUQsT0FBTyxhQUFhLENBQUE7UUFDeEIsQ0FBQyxDQUFDLENBQ0wsQ0FBQTtRQUVELCtEQUErRDtRQUMvRCxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUE7SUFDMUMsQ0FBQztJQUVELE9BQU8sY0FBYyxDQUFBO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBRdWVyeUNvbW1hbmRPdXRwdXQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBLTVNDbGllbnQsIEVuY3J5cHRDb21tYW5kLCBEZWNyeXB0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1rbXMnXG5cbmNvbnN0IGttc0NsaWVudCA9IG5ldyBLTVNDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmNvbnN0IEtFWV9BUk4gPSBwcm9jZXNzLmVudi5LRVlfQVJOXG5cbmFzeW5jIGZ1bmN0aW9uIGVuY3J5cHREYXRhKGRhdGE6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBFbmNyeXB0Q29tbWFuZCh7XG4gICAgICAgIEtleUlkOiBLRVlfQVJOLFxuICAgICAgICBQbGFpbnRleHQ6IEJ1ZmZlci5mcm9tKGRhdGEpLFxuICAgIH0pXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGttc0NsaWVudC5zZW5kKGNvbW1hbmQpXG4gICAgcmV0dXJuIHJlc3BvbnNlLkNpcGhlcnRleHRCbG9iPy50b1N0cmluZygpIHx8ICcnXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlY3J5cHREYXRhKGVuY3J5cHRlZERhdGE6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBEZWNyeXB0Q29tbWFuZCh7XG4gICAgICAgIENpcGhlcnRleHRCbG9iOiBCdWZmZXIuZnJvbShlbmNyeXB0ZWREYXRhLCAnYmFzZTY0JyksXG4gICAgfSlcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQga21zQ2xpZW50LnNlbmQoY29tbWFuZClcbiAgICByZXR1cm4gcmVzcG9uc2UuUGxhaW50ZXh0Py50b1N0cmluZygpIHx8ICcnXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoaXRlbXM6IFJlY29yZDxzdHJpbmcsIGFueT5bXSkge1xuICAgIGlmIChwcm9jZXNzLmVudi5TVEFHRSAhPT0gJ3Byb2QnKSB7XG4gICAgICAgIHJldHVybiBpdGVtc1xuICAgIH1cbiAgICBjb25zdCBkZWNyeXB0ZWRJdGVtczogUmVjb3JkPHN0cmluZywgYW55PltdID0gW11cblxuICAgIC8vIFNwbGl0IGl0ZW1zIGludG8gYmF0Y2hlcyBvZiAxMDBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSArPSAxMDApIHtcbiAgICAgICAgY29uc3QgYmF0Y2ggPSBpdGVtcy5zbGljZShpLCBpICsgMTAwKVxuXG4gICAgICAgIC8vIERlY3J5cHQgZWFjaCBpdGVtIGluIHRoZSBiYXRjaCBjb25jdXJyZW50bHlcbiAgICAgICAgY29uc3QgZGVjcnlwdGVkQmF0Y2ggPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgIGJhdGNoLm1hcChhc3luYyAoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZEl0ZW06IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fVxuXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoaXRlbSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3BrJyB8fCBrZXkgPT09ICdzaycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEl0ZW1ba2V5XSA9IHZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5TKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWNyeXB0IHN0cmluZyBhdHRyaWJ1dGVzXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtW2tleV0gPSBhd2FpdCBkZWNyeXB0RGF0YSh2YWx1ZS5TKVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHZhbHVlLk4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEtlZXAgbnVtYmVycyBhcyB0aGV5IGFyZVxuICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkSXRlbVtrZXldID0gdmFsdWUuTlxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHZhbHVlLkIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlY3J5cHQgYmluYXJ5IGF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZFZhbHVlID0gYXdhaXQgZGVjcnlwdERhdGEodmFsdWUuQi50b1N0cmluZygnYmFzZTY0JykpXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtW2tleV0gPSBCdWZmZXIuZnJvbShkZWNyeXB0ZWRWYWx1ZSwgJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdmFsdWUuQk9PTCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtW2tleV0gPSB2YWx1ZS5CT09MXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdmFsdWUuTlVMTCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtW2tleV0gPSBudWxsXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdmFsdWUuTCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIGxpc3RzIGJ5IHJlY3Vyc2l2ZWx5IGRlY3J5cHRpbmcgZWFjaCBlbGVtZW50XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRJdGVtW2tleV0gPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5MLm1hcChhc3luYyAoaXRlbTogYW55KSA9PiBhd2FpdCBkZWNyeXB0RGF0YShpdGVtKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS5NKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgbWFwcyBieSByZWN1cnNpdmVseSBkZWNyeXB0aW5nIGVhY2ggYXR0cmlidXRlIGluIHRoZSBtYXBcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZE1hcDogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IFttYXBLZXksIG1hcFZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh2YWx1ZS5NKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZE1hcFttYXBLZXldID0gYXdhaXQgZGVjcnlwdERhdGEobWFwVmFsdWUgYXMgc3RyaW5nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkSXRlbVtrZXldID0gZGVjcnlwdGVkTWFwXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBhdHRyaWJ1dGUgdHlwZSBpcyB1bnJlY29nbml6ZWQsIHJldHVybiBhcy1pc1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkSXRlbVtrZXldID0gdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBkZWNyeXB0ZWRJdGVtXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG5cbiAgICAgICAgLy8gQWRkIHRoZSBkZWNyeXB0ZWQgYmF0Y2ggdG8gdGhlIGZpbmFsIGxpc3Qgb2YgZGVjcnlwdGVkIGl0ZW1zXG4gICAgICAgIGRlY3J5cHRlZEl0ZW1zLnB1c2goLi4uZGVjcnlwdGVkQmF0Y2gpXG4gICAgfVxuXG4gICAgcmV0dXJuIGRlY3J5cHRlZEl0ZW1zXG59XG4iXX0=