"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetUser = exports.GetItems = exports.PutCacheEntity = exports.GetCacheEntity = exports.GetEntities = exports.detailedCategories = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
function mapStartDayToDate(startDay) {
    const { day, month, year } = startDay;
    // Ensure the day and month are two digits by padding them with zeroes
    const formattedDay = String(day).padStart(2, '0');
    const formattedMonth = String(month).padStart(2, '0'); // Months should be zero-padded
    // Return the date in 'YYYY-MM-DD' format
    return `${year}-${formattedMonth}-${formattedDay}`;
}
exports.detailedCategories = ['TRANSFER_IN', 'TRANSFER_OUT', 'LOAN_PAYMENTS', 'RENT_AND_UTILITIES'];
// SECURITY and ACCOUNT dont have date range in key
const GetEntities = (params) => {
    let filter = {
        KeyConditionExpression: 'pk = :pk AND begins_with(sk, :sk)',
        ExpressionAttributeValues: {
            ':pk': { S: params.pk ?? `USER#${params.username}#ITEM#${params.id}` },
            ':sk': { S: `${params.entityName}` },
        },
    };
    if (params.getAllTransactionsForUser) {
        filter = {
            KeyConditionExpression: 'gsi1pk = :gsi1pk AND begins_with(gsi1sk, :gsi1sk)',
            ExpressionAttributeValues: {
                ':gsi1pk': { S: params.pk ?? `USER#${params.username}#TRANSACTIONS` },
                ':gsi1sk': { S: `${params.entityName}` },
            },
            IndexName: 'GSI1',
        };
    }
    if (params.getAllSecuritiesForUser) {
        filter = {
            KeyConditionExpression: 'gsi1pk = :gsi1pk AND begins_with(gsi1sk, :gsi1sk)',
            ExpressionAttributeValues: {
                ':gsi1pk': { S: params.pk ?? `USER#${params.username}#SECURITY` },
                ':gsi1sk': { S: `${params.entityName}` },
            },
            IndexName: 'GSI1',
        };
    }
    if (params.dateRange && !params.dateRange.hasNoTimeConstraint) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = { S: mapStartDayToDate(params.dateRange.startDay) };
        filter['ExpressionAttributeValues'][':endDate'] = { S: mapStartDayToDate(params.dateRange.endDay) };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    if (params.customDateRange) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = {
            S: params.customDateRange[0] ? new Date(params.customDateRange[0]).toISOString().split('.')[0] : 0,
        };
        filter['ExpressionAttributeValues'][':endDate'] = {
            S: params.customDateRange[1]
                ? new Date(params.customDateRange[1]).toISOString().split('.')[0]
                : new Date().toISOString().split('.')[0],
        };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    console.info('FINAL filter', filter);
    if (params.highLevelCategory) {
        const isDetailedCategory = exports.detailedCategories
            .map((category) => params.highLevelCategory?.includes(category))
            .includes(true);
        if (!filter['FilterExpression']) {
            filter['FilterExpression'] = '#keyOne.#finance = :primaryCategory';
        }
        else {
            filter['FilterExpression'] = filter['FilterExpression'] + ' AND #keyOne.#finance = :primaryCategory';
        }
        filter['ExpressionAttributeValues'][':primaryCategory'] = {
            S: params.highLevelCategory,
        };
        filter['ExpressionAttributeNames'] = {
            ...(filter['ExpressionAttributeNames'] ?? {}),
            '#finance': isDetailedCategory ? 'detailed' : 'primary',
            '#keyOne': 'personal_finance_category',
        };
    }
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetEntities = GetEntities;
const GetCacheEntity = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk AND sk = :sk',
        ExpressionAttributeValues: {
            ':pk': { S: `CACHEENTITY#${params.id}` },
            ':sk': { S: params.sk },
        },
    };
    if (params.expire_at) {
        // Adding the FilterExpression to check if expire_at is less than the provided expire_at
        filter['FilterExpression'] = '#expiresAt > :expiresAt';
        filter['ExpressionAttributeNames'] = {
            '#expiresAt': 'expire_at', // Using attribute name mapping for ExpiresAt
        };
        filter['ExpressionAttributeValues'][':expiresAt'] = { N: params.expire_at.toString() }; // Assuming expiresAt is a number
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetCacheEntity = GetCacheEntity;
const PutCacheEntity = (params, data) => {
    const item = {
        pk: { S: `CACHEENTITY#${params.id}` },
        sk: { S: params.sk },
        expire_at: { N: params.expire_at.toString() }, // Storing ExpiresAt as a number (timestamp)
        ...data, // Spread any additional data attributes
    };
    return new client_dynamodb_1.PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: item,
    });
};
exports.PutCacheEntity = PutCacheEntity;
const GetItems = () => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `ITEMS` },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetItems = GetItems;
const GetUser = (id) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk and sk = :sk',
        ExpressionAttributeValues: {
            ':pk': { S: id },
            ':sk': { S: 'v0' },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetUser = GetUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcXVlcmllcy9FbnRpdGllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBdUU7QUFzQnZFLFNBQVMsaUJBQWlCLENBQUMsUUFBeUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFBO0lBRXJDLHNFQUFzRTtJQUN0RSxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLCtCQUErQjtJQUVyRix5Q0FBeUM7SUFDekMsT0FBTyxHQUFHLElBQUksSUFBSSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUE7QUFDdEQsQ0FBQztBQUVZLFFBQUEsa0JBQWtCLEdBQUcsQ0FBQyxhQUFhLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxDQUFBO0FBQ3hHLG1EQUFtRDtBQUM1QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQXlCLEVBQUUsRUFBRTtJQUNyRCxJQUFJLE1BQU0sR0FBUTtRQUNkLHNCQUFzQixFQUFFLG1DQUFtQztRQUMzRCx5QkFBeUIsRUFBRTtZQUN2QixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEVBQUUsSUFBSSxRQUFRLE1BQU0sQ0FBQyxRQUFRLFNBQVMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ3RFLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRTtTQUN2QztLQUNKLENBQUE7SUFDRCxJQUFJLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBQ25DLE1B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Q0FBNEM7UUFDM0YsR0FBRyxJQUFJLEVBQUUsd0NBQXdDO0tBQ3BELENBQUE7SUFFRCxPQUFPLElBQUksZ0NBQWMsQ0FBQztRQUN0QixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO1FBQ2pDLElBQUksRUFBRSxJQUFJO0tBQ2IsQ0FBQyxDQUFBO0FBQ04sQ0FBQyxDQUFBO0FBWlksUUFBQSxjQUFjLGtCQVkxQjtBQUVNLE1BQU0sUUFBUSxHQUFHLEdBQUcsRUFBRTtJQUN6QixNQUFNLE1BQU0sR0FBUTtRQUNoQixzQkFBc0IsRUFBRSxVQUFVO1FBQ2xDLHlCQUF5QixFQUFFO1lBQ3ZCLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUU7U0FDeEI7S0FDSixDQUFBO0lBQ0QsT0FBTyxJQUFJLDhCQUFZLENBQUM7UUFDcEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtRQUNqQyxHQUFHLE1BQU07S0FDWixDQUFDLENBQUE7QUFDTixDQUFDLENBQUE7QUFYWSxRQUFBLFFBQVEsWUFXcEI7QUFFTSxNQUFNLE9BQU8sR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFFO0lBQ2xDLE1BQU0sTUFBTSxHQUFRO1FBQ2hCLHNCQUFzQixFQUFFLHVCQUF1QjtRQUMvQyx5QkFBeUIsRUFBRTtZQUN2QixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ2hCLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUU7U0FDckI7S0FDSixDQUFBO0lBQ0QsT0FBTyxJQUFJLDhCQUFZLENBQUM7UUFDcEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtRQUNqQyxHQUFHLE1BQU07S0FDWixDQUFDLENBQUE7QUFDTixDQUFDLENBQUE7QUFaWSxRQUFBLE9BQU8sV0FZbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBRdWVyeUNvbW1hbmQsIFB1dEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgRGF0YVJhbmdlUmVzcG9uc2UsIEdwdERhdGVSZXNwb25zZSB9IGZyb20gJy4uL2dwdCdcbmltcG9ydCB7IEhpZ2hMZXZlbFRyYW5zYWN0aW9uQ2F0ZWdvcnkgfSBmcm9tICcuLi9BUEknXG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50aXR5UXVlcnlQYXJhbXMge1xuICAgIHVzZXJuYW1lOiBzdHJpbmdcbiAgICBpZDogc3RyaW5nXG4gICAgZGF0ZVJhbmdlOiBEYXRhUmFuZ2VSZXNwb25zZSB8IHVuZGVmaW5lZFxuICAgIGN1c3RvbURhdGVSYW5nZT86IFtudW1iZXI/LCBudW1iZXI/XSB8IG51bGwgfCB1bmRlZmluZWRcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmdcbiAgICBwaz86IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGhpZ2hMZXZlbENhdGVnb3J5PzogSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeVxuICAgIGdldEFsbFRyYW5zYWN0aW9uc0ZvclVzZXI/OiBib29sZWFuXG4gICAgZ2V0QWxsU2VjdXJpdGllc0ZvclVzZXI/OiBib29sZWFuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVFbnRpdHlRdWVyeVBhcmFtIHtcbiAgICBpZDogc3RyaW5nXG4gICAgZXhwaXJlX2F0OiBudW1iZXJcbiAgICBzazogc3RyaW5nXG59XG5cbmZ1bmN0aW9uIG1hcFN0YXJ0RGF5VG9EYXRlKHN0YXJ0RGF5OiBHcHREYXRlUmVzcG9uc2UpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgZGF5LCBtb250aCwgeWVhciB9ID0gc3RhcnREYXlcblxuICAgIC8vIEVuc3VyZSB0aGUgZGF5IGFuZCBtb250aCBhcmUgdHdvIGRpZ2l0cyBieSBwYWRkaW5nIHRoZW0gd2l0aCB6ZXJvZXNcbiAgICBjb25zdCBmb3JtYXR0ZWREYXkgPSBTdHJpbmcoZGF5KS5wYWRTdGFydCgyLCAnMCcpXG4gICAgY29uc3QgZm9ybWF0dGVkTW9udGggPSBTdHJpbmcobW9udGgpLnBhZFN0YXJ0KDIsICcwJykgLy8gTW9udGhzIHNob3VsZCBiZSB6ZXJvLXBhZGRlZFxuXG4gICAgLy8gUmV0dXJuIHRoZSBkYXRlIGluICdZWVlZLU1NLUREJyBmb3JtYXRcbiAgICByZXR1cm4gYCR7eWVhcn0tJHtmb3JtYXR0ZWRNb250aH0tJHtmb3JtYXR0ZWREYXl9YFxufVxuXG5leHBvcnQgY29uc3QgZGV0YWlsZWRDYXRlZ29yaWVzID0gWydUUkFOU0ZFUl9JTicsICdUUkFOU0ZFUl9PVVQnLCAnTE9BTl9QQVlNRU5UUycsICdSRU5UX0FORF9VVElMSVRJRVMnXVxuLy8gU0VDVVJJVFkgYW5kIEFDQ09VTlQgZG9udCBoYXZlIGRhdGUgcmFuZ2UgaW4ga2V5XG5leHBvcnQgY29uc3QgR2V0RW50aXRpZXMgPSAocGFyYW1zOiBFbnRpdHlRdWVyeVBhcmFtcykgPT4ge1xuICAgIGxldCBmaWx0ZXI6IGFueSA9IHtcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BrID0gOnBrIEFORCBiZWdpbnNfd2l0aChzaywgOnNrKScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICc6cGsnOiB7IFM6IHBhcmFtcy5wayA/PyBgVVNFUiMke3BhcmFtcy51c2VybmFtZX0jSVRFTSMke3BhcmFtcy5pZH1gIH0sXG4gICAgICAgICAgICAnOnNrJzogeyBTOiBgJHtwYXJhbXMuZW50aXR5TmFtZX1gIH0sXG4gICAgICAgIH0sXG4gICAgfVxuICAgIGlmIChwYXJhbXMuZ2V0QWxsVHJhbnNhY3Rpb25zRm9yVXNlcikge1xuICAgICAgICBmaWx0ZXIgPSB7XG4gICAgICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZ3NpMXBrID0gOmdzaTFwayBBTkQgYmVnaW5zX3dpdGgoZ3NpMXNrLCA6Z3NpMXNrKScsXG4gICAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAgICAgJzpnc2kxcGsnOiB7IFM6IHBhcmFtcy5wayA/PyBgVVNFUiMke3BhcmFtcy51c2VybmFtZX0jVFJBTlNBQ1RJT05TYCB9LFxuICAgICAgICAgICAgICAgICc6Z3NpMXNrJzogeyBTOiBgJHtwYXJhbXMuZW50aXR5TmFtZX1gIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgSW5kZXhOYW1lOiAnR1NJMScsXG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcy5nZXRBbGxTZWN1cml0aWVzRm9yVXNlcikge1xuICAgICAgICBmaWx0ZXIgPSB7XG4gICAgICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZ3NpMXBrID0gOmdzaTFwayBBTkQgYmVnaW5zX3dpdGgoZ3NpMXNrLCA6Z3NpMXNrKScsXG4gICAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAgICAgJzpnc2kxcGsnOiB7IFM6IHBhcmFtcy5wayA/PyBgVVNFUiMke3BhcmFtcy51c2VybmFtZX0jU0VDVVJJVFlgIH0sXG4gICAgICAgICAgICAgICAgJzpnc2kxc2snOiB7IFM6IGAke3BhcmFtcy5lbnRpdHlOYW1lfWAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBJbmRleE5hbWU6ICdHU0kxJyxcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocGFyYW1zLmRhdGVSYW5nZSAmJiAhcGFyYW1zLmRhdGVSYW5nZS5oYXNOb1RpbWVDb25zdHJhaW50KSB7XG4gICAgICAgIGZpbHRlciA9IHsgLi4uZmlsdGVyLCBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHt9IH1cbiAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2RhdGUgQkVUV0VFTiA6c3RhcnREYXRlIEFORCA6ZW5kRGF0ZSdcbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzpzdGFydERhdGUnXSA9IHsgUzogbWFwU3RhcnREYXlUb0RhdGUocGFyYW1zLmRhdGVSYW5nZS5zdGFydERheSkgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOmVuZERhdGUnXSA9IHsgUzogbWFwU3RhcnREYXlUb0RhdGUocGFyYW1zLmRhdGVSYW5nZS5lbmREYXkpIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA9IHsgJyNkYXRlJzogJ2RhdGUnIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcy5jdXN0b21EYXRlUmFuZ2UpIHtcbiAgICAgICAgZmlsdGVyID0geyAuLi5maWx0ZXIsIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge30gfVxuICAgICAgICBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSA9ICcjZGF0ZSBCRVRXRUVOIDpzdGFydERhdGUgQU5EIDplbmREYXRlJ1xuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOnN0YXJ0RGF0ZSddID0ge1xuICAgICAgICAgICAgUzogcGFyYW1zLmN1c3RvbURhdGVSYW5nZVswXSA/IG5ldyBEYXRlKHBhcmFtcy5jdXN0b21EYXRlUmFuZ2VbMF0pLnRvSVNPU3RyaW5nKCkuc3BsaXQoJy4nKVswXSA6IDAsXG4gICAgICAgIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzplbmREYXRlJ10gPSB7XG4gICAgICAgICAgICBTOiBwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlWzFdXG4gICAgICAgICAgICAgICAgPyBuZXcgRGF0ZShwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlWzFdKS50b0lTT1N0cmluZygpLnNwbGl0KCcuJylbMF1cbiAgICAgICAgICAgICAgICA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnLicpWzBdLFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7ICcjZGF0ZSc6ICdkYXRlJyB9XG4gICAgfVxuICAgIGNvbnNvbGUuaW5mbygnRklOQUwgZmlsdGVyJywgZmlsdGVyKVxuICAgIGlmIChwYXJhbXMuaGlnaExldmVsQ2F0ZWdvcnkpIHtcbiAgICAgICAgY29uc3QgaXNEZXRhaWxlZENhdGVnb3J5ID0gZGV0YWlsZWRDYXRlZ29yaWVzXG4gICAgICAgICAgICAubWFwKChjYXRlZ29yeSkgPT4gcGFyYW1zLmhpZ2hMZXZlbENhdGVnb3J5Py5pbmNsdWRlcyhjYXRlZ29yeSkpXG4gICAgICAgICAgICAuaW5jbHVkZXModHJ1ZSlcbiAgICAgICAgaWYgKCFmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSkge1xuICAgICAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2tleU9uZS4jZmluYW5jZSA9IDpwcmltYXJ5Q2F0ZWdvcnknXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSA9IGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddICsgJyBBTkQgI2tleU9uZS4jZmluYW5jZSA9IDpwcmltYXJ5Q2F0ZWdvcnknXG4gICAgICAgIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzpwcmltYXJ5Q2F0ZWdvcnknXSA9IHtcbiAgICAgICAgICAgIFM6IHBhcmFtcy5oaWdoTGV2ZWxDYXRlZ29yeSxcbiAgICAgICAgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyddID0ge1xuICAgICAgICAgICAgLi4uKGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPz8ge30pLFxuICAgICAgICAgICAgJyNmaW5hbmNlJzogaXNEZXRhaWxlZENhdGVnb3J5ID8gJ2RldGFpbGVkJyA6ICdwcmltYXJ5JyxcbiAgICAgICAgICAgICcja2V5T25lJzogJ3BlcnNvbmFsX2ZpbmFuY2VfY2F0ZWdvcnknLFxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICAuLi5maWx0ZXIsXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IEdldENhY2hlRW50aXR5ID0gKHBhcmFtczogQ2FjaGVFbnRpdHlRdWVyeVBhcmFtKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBBTkQgc2sgPSA6c2snLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBgQ0FDSEVFTlRJVFkjJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogcGFyYW1zLnNrIH0sXG4gICAgICAgIH0sXG4gICAgfVxuICAgIGlmIChwYXJhbXMuZXhwaXJlX2F0KSB7XG4gICAgICAgIC8vIEFkZGluZyB0aGUgRmlsdGVyRXhwcmVzc2lvbiB0byBjaGVjayBpZiBleHBpcmVfYXQgaXMgbGVzcyB0aGFuIHRoZSBwcm92aWRlZCBleHBpcmVfYXRcbiAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2V4cGlyZXNBdCA+IDpleHBpcmVzQXQnXG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7XG4gICAgICAgICAgICAnI2V4cGlyZXNBdCc6ICdleHBpcmVfYXQnLCAvLyBVc2luZyBhdHRyaWJ1dGUgbmFtZSBtYXBwaW5nIGZvciBFeHBpcmVzQXRcbiAgICAgICAgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOmV4cGlyZXNBdCddID0geyBOOiBwYXJhbXMuZXhwaXJlX2F0LnRvU3RyaW5nKCkgfSAvLyBBc3N1bWluZyBleHBpcmVzQXQgaXMgYSBudW1iZXJcbiAgICB9XG5cbiAgICBjb25zb2xlLmluZm8ocGFyYW1zKVxuICAgIHJldHVybiBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICAuLi5maWx0ZXIsXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IFB1dENhY2hlRW50aXR5ID0gKHBhcmFtczogQ2FjaGVFbnRpdHlRdWVyeVBhcmFtLCBkYXRhOiBhbnkpID0+IHtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICBwazogeyBTOiBgQ0FDSEVFTlRJVFkjJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICBzazogeyBTOiBwYXJhbXMuc2sgfSxcbiAgICAgICAgZXhwaXJlX2F0OiB7IE46IHBhcmFtcy5leHBpcmVfYXQudG9TdHJpbmcoKSB9LCAvLyBTdG9yaW5nIEV4cGlyZXNBdCBhcyBhIG51bWJlciAodGltZXN0YW1wKVxuICAgICAgICAuLi5kYXRhLCAvLyBTcHJlYWQgYW55IGFkZGl0aW9uYWwgZGF0YSBhdHRyaWJ1dGVzXG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgSXRlbTogaXRlbSxcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0SXRlbXMgPSAoKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwaycsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICc6cGsnOiB7IFM6IGBJVEVNU2AgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0VXNlciA9IChpZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBhbmQgc2sgPSA6c2snLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBpZCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogJ3YwJyB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICByZXR1cm4gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgLi4uZmlsdGVyLFxuICAgIH0pXG59XG4iXX0=