"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PutCacheEntity = exports.GetCacheEntity = exports.GetEntities = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
function mapStartDayToDate(startDay) {
    const { day, month, year } = startDay;
    // Ensure the day and month are two digits by padding them with zeroes
    const formattedDay = String(day).padStart(2, '0');
    const formattedMonth = String(month).padStart(2, '0'); // Months should be zero-padded
    // Return the date in 'YYYY-MM-DD' format
    return `${year}-${formattedMonth}-${formattedDay}`;
}
// SECURITY and ACCOUNT dont have date range in key
const GetEntities = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk AND begins_with(sk, :sk)',
        ExpressionAttributeValues: {
            ':pk': { S: `USER#${params.username}#ITEM#${params.id}` },
            ':sk': { S: `${params.entityName}` },
        },
    };
    if (params.dateRange && !params.dateRange.hasNoTimeConstraint) {
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = { S: mapStartDayToDate(params.dateRange.startDay) };
        filter['ExpressionAttributeValues'][':endDate'] = { S: mapStartDayToDate(params.dateRange.endDay) };
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetEntities = GetEntities;
const GetCacheEntity = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `CACHEENTITY#${params.id}` },
        },
    };
    if (params.expiresAt) {
        // Adding the FilterExpression to check if ExpiresAt is less than the provided expiresAt
        filter['FilterExpression'] = '#expiresAt < :expiresAt';
        filter['ExpressionAttributeNames'] = {
            '#expiresAt': 'ExpiresAt', // Using attribute name mapping for ExpiresAt
        };
        filter['ExpressionAttributeValues'][':expiresAt'] = { N: params.expiresAt.toString() }; // Assuming expiresAt is a number (timestamp)
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetCacheEntity = GetCacheEntity;
const PutCacheEntity = (params, data) => {
    const item = {
        pk: `CACHEENTITY#${params.id}`,
        ExpiresAt: params.expiresAt, // Storing ExpiresAt as a number (timestamp)
        ...data, // Spread any additional data attributes
    };
    return new client_dynamodb_1.PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: item,
    });
};
exports.PutCacheEntity = PutCacheEntity;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcXVlcmllcy9FbnRpdGllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBdUU7QUFnQnZFLFNBQVMsaUJBQWlCLENBQUMsUUFBeUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFBO0lBRXJDLHNFQUFzRTtJQUN0RSxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLCtCQUErQjtJQUVyRix5Q0FBeUM7SUFDekMsT0FBTyxHQUFHLElBQUksSUFBSSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUE7QUFDdEQsQ0FBQztBQUVELG1EQUFtRDtBQUM1QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQXlCLEVBQUUsRUFBRTtJQUNyRCxNQUFNLE1BQU0sR0FBUTtRQUNoQixzQkFBc0IsRUFBRSxtQ0FBbUM7UUFDM0QseUJBQXlCLEVBQUU7WUFDdkIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLFFBQVEsTUFBTSxDQUFDLFFBQVEsU0FBUyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUU7WUFDekQsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRSxFQUFFO1NBQ3ZDO0tBQ0osQ0FBQTtJQUNELElBQUksTUFBTSxDQUFDLFNBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUM1RCxNQUFNLENBQUMsa0JBQWtCLENBQUMsR0FBRyx1Q0FBdUMsQ0FBQTtRQUNwRSxNQUFNLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUE7UUFDdkcsTUFBTSxDQUFDLDJCQUEyQixDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFBO0lBQ3ZHLENBQUM7SUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3BCLE9BQU8sSUFBSSw4QkFBWSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVU7UUFDakMsR0FBRyxNQUFNO0tBQ1osQ0FBQyxDQUFBO0FBQ04sQ0FBQyxDQUFBO0FBbEJZLFFBQUEsV0FBVyxlQWtCdkI7QUFFTSxNQUFNLGNBQWMsR0FBRyxDQUFDLE1BQTZCLEVBQUUsRUFBRTtJQUM1RCxNQUFNLE1BQU0sR0FBUTtRQUNoQixzQkFBc0IsRUFBRSxVQUFVO1FBQ2xDLHlCQUF5QixFQUFFO1lBQ3ZCLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxlQUFlLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRTtTQUMzQztLQUNKLENBQUE7SUFDRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNuQix3RkFBd0Y7UUFDeEYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLEdBQUcseUJBQXlCLENBQUE7UUFDdEQsTUFBTSxDQUFDLDBCQUEwQixDQUFDLEdBQUc7WUFDakMsWUFBWSxFQUFFLFdBQVcsRUFBRSw2Q0FBNkM7U0FDM0UsQ0FBQTtRQUNELE1BQU0sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQSxDQUFDLDZDQUE2QztJQUN4SSxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNwQixPQUFPLElBQUksOEJBQVksQ0FBQztRQUNwQixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO1FBQ2pDLEdBQUcsTUFBTTtLQUNaLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQXJCWSxRQUFBLGNBQWMsa0JBcUIxQjtBQUVNLE1BQU0sY0FBYyxHQUFHLENBQUMsTUFBNkIsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUN2RSxNQUFNLElBQUksR0FBUTtRQUNkLEVBQUUsRUFBRSxlQUFlLE1BQU0sQ0FBQyxFQUFFLEVBQUU7UUFDOUIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTLEVBQUUsNENBQTRDO1FBQ3pFLEdBQUcsSUFBSSxFQUFFLHdDQUF3QztLQUNwRCxDQUFBO0lBRUQsT0FBTyxJQUFJLGdDQUFjLENBQUM7UUFDdEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtRQUNqQyxJQUFJLEVBQUUsSUFBSTtLQUNiLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQVhZLFFBQUEsY0FBYyxrQkFXMUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBRdWVyeUNvbW1hbmQsIFB1dEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJ1xuaW1wb3J0IHsgRGF0YVJhbmdlUmVzcG9uc2UsIEdwdERhdGVSZXNwb25zZSwgSW5mb3JtYXRpb25PcHRpb25zIH0gZnJvbSAnLi4vZ3B0J1xuaW1wb3J0IHsgRW50aXR5TmFtZSB9IGZyb20gJy4uL2dldFJlc3BvbnNlVXNpbmdGaW5hbmNpYWxDb250ZXh0J1xuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eVF1ZXJ5UGFyYW1zIHtcbiAgICB1c2VybmFtZTogc3RyaW5nXG4gICAgaWQ6IHN0cmluZ1xuICAgIGRhdGVSYW5nZTogRGF0YVJhbmdlUmVzcG9uc2UgfCB1bmRlZmluZWRcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYWNoZUVudGl0eVF1ZXJ5UGFyYW0ge1xuICAgIGlkOiBzdHJpbmdcbiAgICBleHBpcmVzQXQ6IG51bWJlclxufVxuXG5mdW5jdGlvbiBtYXBTdGFydERheVRvRGF0ZShzdGFydERheTogR3B0RGF0ZVJlc3BvbnNlKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGRheSwgbW9udGgsIHllYXIgfSA9IHN0YXJ0RGF5XG5cbiAgICAvLyBFbnN1cmUgdGhlIGRheSBhbmQgbW9udGggYXJlIHR3byBkaWdpdHMgYnkgcGFkZGluZyB0aGVtIHdpdGggemVyb2VzXG4gICAgY29uc3QgZm9ybWF0dGVkRGF5ID0gU3RyaW5nKGRheSkucGFkU3RhcnQoMiwgJzAnKVxuICAgIGNvbnN0IGZvcm1hdHRlZE1vbnRoID0gU3RyaW5nKG1vbnRoKS5wYWRTdGFydCgyLCAnMCcpIC8vIE1vbnRocyBzaG91bGQgYmUgemVyby1wYWRkZWRcblxuICAgIC8vIFJldHVybiB0aGUgZGF0ZSBpbiAnWVlZWS1NTS1ERCcgZm9ybWF0XG4gICAgcmV0dXJuIGAke3llYXJ9LSR7Zm9ybWF0dGVkTW9udGh9LSR7Zm9ybWF0dGVkRGF5fWBcbn1cblxuLy8gU0VDVVJJVFkgYW5kIEFDQ09VTlQgZG9udCBoYXZlIGRhdGUgcmFuZ2UgaW4ga2V5XG5leHBvcnQgY29uc3QgR2V0RW50aXRpZXMgPSAocGFyYW1zOiBFbnRpdHlRdWVyeVBhcmFtcykgPT4ge1xuICAgIGNvbnN0IGZpbHRlcjogYW55ID0ge1xuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsgQU5EIGJlZ2luc193aXRoKHNrLCA6c2spJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogYFVTRVIjJHtwYXJhbXMudXNlcm5hbWV9I0lURU0jJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogYCR7cGFyYW1zLmVudGl0eU5hbWV9YCB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICBpZiAocGFyYW1zLmRhdGVSYW5nZSAmJiAhcGFyYW1zLmRhdGVSYW5nZS5oYXNOb1RpbWVDb25zdHJhaW50KSB7XG4gICAgICAgIGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddID0gJyNkYXRlIEJFVFdFRU4gOnN0YXJ0RGF0ZSBBTkQgOmVuZERhdGUnXG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6c3RhcnREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2Uuc3RhcnREYXkpIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzplbmREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2UuZW5kRGF5KSB9XG4gICAgfVxuICAgIGNvbnNvbGUuaW5mbyhwYXJhbXMpXG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0Q2FjaGVFbnRpdHkgPSAocGFyYW1zOiBDYWNoZUVudGl0eVF1ZXJ5UGFyYW0pID0+IHtcbiAgICBjb25zdCBmaWx0ZXI6IGFueSA9IHtcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BrID0gOnBrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogYENBQ0hFRU5USVRZIyR7cGFyYW1zLmlkfWAgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgaWYgKHBhcmFtcy5leHBpcmVzQXQpIHtcbiAgICAgICAgLy8gQWRkaW5nIHRoZSBGaWx0ZXJFeHByZXNzaW9uIHRvIGNoZWNrIGlmIEV4cGlyZXNBdCBpcyBsZXNzIHRoYW4gdGhlIHByb3ZpZGVkIGV4cGlyZXNBdFxuICAgICAgICBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSA9ICcjZXhwaXJlc0F0IDwgOmV4cGlyZXNBdCdcbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA9IHtcbiAgICAgICAgICAgICcjZXhwaXJlc0F0JzogJ0V4cGlyZXNBdCcsIC8vIFVzaW5nIGF0dHJpYnV0ZSBuYW1lIG1hcHBpbmcgZm9yIEV4cGlyZXNBdFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6ZXhwaXJlc0F0J10gPSB7IE46IHBhcmFtcy5leHBpcmVzQXQudG9TdHJpbmcoKSB9IC8vIEFzc3VtaW5nIGV4cGlyZXNBdCBpcyBhIG51bWJlciAodGltZXN0YW1wKVxuICAgIH1cblxuICAgIGNvbnNvbGUuaW5mbyhwYXJhbXMpXG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgUHV0Q2FjaGVFbnRpdHkgPSAocGFyYW1zOiBDYWNoZUVudGl0eVF1ZXJ5UGFyYW0sIGRhdGE6IGFueSkgPT4ge1xuICAgIGNvbnN0IGl0ZW06IGFueSA9IHtcbiAgICAgICAgcGs6IGBDQUNIRUVOVElUWSMke3BhcmFtcy5pZH1gLFxuICAgICAgICBFeHBpcmVzQXQ6IHBhcmFtcy5leHBpcmVzQXQsIC8vIFN0b3JpbmcgRXhwaXJlc0F0IGFzIGEgbnVtYmVyICh0aW1lc3RhbXApXG4gICAgICAgIC4uLmRhdGEsIC8vIFNwcmVhZCBhbnkgYWRkaXRpb25hbCBkYXRhIGF0dHJpYnV0ZXNcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICBJdGVtOiBpdGVtLFxuICAgIH0pXG59XG4iXX0=