"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetUser = exports.GetItems = exports.PutCacheEntity = exports.GetCacheEntity = exports.GetEntities = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
function mapStartDayToDate(startDay) {
    const { day, month, year } = startDay;
    // Ensure the day and month are two digits by padding them with zeroes
    const formattedDay = String(day).padStart(2, '0');
    const formattedMonth = String(month).padStart(2, '0'); // Months should be zero-padded
    // Return the date in 'YYYY-MM-DD' format
    return `${year}-${formattedMonth}-${formattedDay}`;
}
// SECURITY and ACCOUNT dont have date range in key
const GetEntities = (params) => {
    let filter = {
        KeyConditionExpression: 'pk = :pk AND begins_with(sk, :sk)',
        ExpressionAttributeValues: {
            ':pk': { S: params.pk ?? `USER#${params.username}#ITEM#${params.id}` },
            ':sk': { S: `${params.entityName}` },
        },
    };
    if (params.dateRange && !params.dateRange.hasNoTimeConstraint) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = { S: mapStartDayToDate(params.dateRange.startDay) };
        filter['ExpressionAttributeValues'][':endDate'] = { S: mapStartDayToDate(params.dateRange.endDay) };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    if (params.customDateRange) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = {
            S: params.customDateRange[0] ? new Date(params.customDateRange[0]).toISOString().split('.')[0] : 0,
        };
        filter['ExpressionAttributeValues'][':endDate'] = {
            S: params.customDateRange[1]
                ? new Date(params.customDateRange[1]).toISOString().split('.')[0]
                : new Date().toISOString().split('.')[0],
        };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    console.info('FINAL filter', filter);
    if (params.highLevelCategory) {
        if (!filter['FilterExpression']) {
            filter['FilterExpression'] = '#keyOne.#finance = :primaryCategory';
        }
        else {
            filter['FilterExpression'] = filter['FilterExpression'] + ' AND #keyOne.#finance = :primaryCategory';
        }
        filter['ExpressionAttributeValues'][':primaryCategory'] = {
            S: params.highLevelCategory,
        };
        filter['ExpressionAttributeNames'] = {
            ...(filter['ExpressionAttributeNames'] ?? {}),
            '#finance': 'primary',
            '#keyOne': 'personal_finance_category',
        };
    }
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetEntities = GetEntities;
const GetCacheEntity = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk AND sk = :sk',
        ExpressionAttributeValues: {
            ':pk': { S: `CACHEENTITY#${params.id}` },
            ':sk': { S: params.sk },
        },
    };
    if (params.expire_at) {
        // Adding the FilterExpression to check if expire_at is less than the provided expire_at
        filter['FilterExpression'] = '#expiresAt > :expiresAt';
        filter['ExpressionAttributeNames'] = {
            '#expiresAt': 'expire_at', // Using attribute name mapping for ExpiresAt
        };
        filter['ExpressionAttributeValues'][':expiresAt'] = { N: params.expire_at.toString() }; // Assuming expiresAt is a number
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetCacheEntity = GetCacheEntity;
const PutCacheEntity = (params, data) => {
    const item = {
        pk: { S: `CACHEENTITY#${params.id}` },
        sk: { S: params.sk },
        expire_at: { N: params.expire_at.toString() }, // Storing ExpiresAt as a number (timestamp)
        ...data, // Spread any additional data attributes
    };
    return new client_dynamodb_1.PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: item,
    });
};
exports.PutCacheEntity = PutCacheEntity;
const GetItems = () => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `ITEMS` },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetItems = GetItems;
const GetUser = (id) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk and sk = :sk',
        ExpressionAttributeValues: {
            ':pk': { S: id },
            ':sk': { S: 'v0' },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetUser = GetUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcXVlcmllcy9FbnRpdGllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBdUU7QUFvQnZFLFNBQVMsaUJBQWlCLENBQUMsUUFBeUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFBO0lBRXJDLHNFQUFzRTtJQUN0RSxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLCtCQUErQjtJQUVyRix5Q0FBeUM7SUFDekMsT0FBTyxHQUFHLElBQUksSUFBSSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUE7QUFDdEQsQ0FBQztBQUVELG1EQUFtRDtBQUM1QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQXlCLEVBQUUsRUFBRTtJQUNyRCxJQUFJLE1BQU0sR0FBUTtRQUNkLHNCQUFzQixFQUFFLG1DQUFtQztRQUMzRCx5QkFBeUIsRUFBRTtZQUN2QixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEVBQUUsSUFBSSxRQUFRLE1BQU0sQ0FBQyxRQUFRLFNBQVMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ3RFLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRTtTQUN2QztLQUNKLENBQUE7SUFDRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDNUQsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLEVBQUUsd0JBQXdCLEVBQUUs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Q29tbWFuZCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBEYXRhUmFuZ2VSZXNwb25zZSwgR3B0RGF0ZVJlc3BvbnNlIH0gZnJvbSAnLi4vZ3B0J1xuaW1wb3J0IHsgSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeSB9IGZyb20gJy4uL0FQSSdcblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlRdWVyeVBhcmFtcyB7XG4gICAgdXNlcm5hbWU6IHN0cmluZ1xuICAgIGlkOiBzdHJpbmdcbiAgICBkYXRlUmFuZ2U6IERhdGFSYW5nZVJlc3BvbnNlIHwgdW5kZWZpbmVkXG4gICAgY3VzdG9tRGF0ZVJhbmdlPzogW251bWJlcj8sIG51bWJlcj9dIHwgbnVsbCB8IHVuZGVmaW5lZFxuICAgIGVudGl0eU5hbWU6IHN0cmluZ1xuICAgIHBrPzogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgaGlnaExldmVsQ2F0ZWdvcnk/OiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVFbnRpdHlRdWVyeVBhcmFtIHtcbiAgICBpZDogc3RyaW5nXG4gICAgZXhwaXJlX2F0OiBudW1iZXJcbiAgICBzazogc3RyaW5nXG59XG5cbmZ1bmN0aW9uIG1hcFN0YXJ0RGF5VG9EYXRlKHN0YXJ0RGF5OiBHcHREYXRlUmVzcG9uc2UpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgZGF5LCBtb250aCwgeWVhciB9ID0gc3RhcnREYXlcblxuICAgIC8vIEVuc3VyZSB0aGUgZGF5IGFuZCBtb250aCBhcmUgdHdvIGRpZ2l0cyBieSBwYWRkaW5nIHRoZW0gd2l0aCB6ZXJvZXNcbiAgICBjb25zdCBmb3JtYXR0ZWREYXkgPSBTdHJpbmcoZGF5KS5wYWRTdGFydCgyLCAnMCcpXG4gICAgY29uc3QgZm9ybWF0dGVkTW9udGggPSBTdHJpbmcobW9udGgpLnBhZFN0YXJ0KDIsICcwJykgLy8gTW9udGhzIHNob3VsZCBiZSB6ZXJvLXBhZGRlZFxuXG4gICAgLy8gUmV0dXJuIHRoZSBkYXRlIGluICdZWVlZLU1NLUREJyBmb3JtYXRcbiAgICByZXR1cm4gYCR7eWVhcn0tJHtmb3JtYXR0ZWRNb250aH0tJHtmb3JtYXR0ZWREYXl9YFxufVxuXG4vLyBTRUNVUklUWSBhbmQgQUNDT1VOVCBkb250IGhhdmUgZGF0ZSByYW5nZSBpbiBrZXlcbmV4cG9ydCBjb25zdCBHZXRFbnRpdGllcyA9IChwYXJhbXM6IEVudGl0eVF1ZXJ5UGFyYW1zKSA9PiB7XG4gICAgbGV0IGZpbHRlcjogYW55ID0ge1xuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsgQU5EIGJlZ2luc193aXRoKHNrLCA6c2spJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogcGFyYW1zLnBrID8/IGBVU0VSIyR7cGFyYW1zLnVzZXJuYW1lfSNJVEVNIyR7cGFyYW1zLmlkfWAgfSxcbiAgICAgICAgICAgICc6c2snOiB7IFM6IGAke3BhcmFtcy5lbnRpdHlOYW1lfWAgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgaWYgKHBhcmFtcy5kYXRlUmFuZ2UgJiYgIXBhcmFtcy5kYXRlUmFuZ2UuaGFzTm9UaW1lQ29uc3RyYWludCkge1xuICAgICAgICBmaWx0ZXIgPSB7IC4uLmZpbHRlciwgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7fSB9XG4gICAgICAgIGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddID0gJyNkYXRlIEJFVFdFRU4gOnN0YXJ0RGF0ZSBBTkQgOmVuZERhdGUnXG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6c3RhcnREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2Uuc3RhcnREYXkpIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzplbmREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2UuZW5kRGF5KSB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7ICcjZGF0ZSc6ICdkYXRlJyB9XG4gICAgfVxuICAgIGlmIChwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlKSB7XG4gICAgICAgIGZpbHRlciA9IHsgLi4uZmlsdGVyLCBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHt9IH1cbiAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2RhdGUgQkVUV0VFTiA6c3RhcnREYXRlIEFORCA6ZW5kRGF0ZSdcbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzpzdGFydERhdGUnXSA9IHtcbiAgICAgICAgICAgIFM6IHBhcmFtcy5jdXN0b21EYXRlUmFuZ2VbMF0gPyBuZXcgRGF0ZShwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlWzBdKS50b0lTT1N0cmluZygpLnNwbGl0KCcuJylbMF0gOiAwLFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6ZW5kRGF0ZSddID0ge1xuICAgICAgICAgICAgUzogcGFyYW1zLmN1c3RvbURhdGVSYW5nZVsxXVxuICAgICAgICAgICAgICAgID8gbmV3IERhdGUocGFyYW1zLmN1c3RvbURhdGVSYW5nZVsxXSkudG9JU09TdHJpbmcoKS5zcGxpdCgnLicpWzBdXG4gICAgICAgICAgICAgICAgOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJy4nKVswXSxcbiAgICAgICAgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyddID0geyAnI2RhdGUnOiAnZGF0ZScgfVxuICAgIH1cbiAgICBjb25zb2xlLmluZm8oJ0ZJTkFMIGZpbHRlcicsIGZpbHRlcilcbiAgICBpZiAocGFyYW1zLmhpZ2hMZXZlbENhdGVnb3J5KSB7XG4gICAgICAgIGlmICghZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10pIHtcbiAgICAgICAgICAgIGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddID0gJyNrZXlPbmUuI2ZpbmFuY2UgPSA6cHJpbWFyeUNhdGVnb3J5J1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSArICcgQU5EICNrZXlPbmUuI2ZpbmFuY2UgPSA6cHJpbWFyeUNhdGVnb3J5J1xuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6cHJpbWFyeUNhdGVnb3J5J10gPSB7XG4gICAgICAgICAgICBTOiBwYXJhbXMuaGlnaExldmVsQ2F0ZWdvcnksXG4gICAgICAgIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA9IHtcbiAgICAgICAgICAgIC4uLihmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyddID8/IHt9KSxcbiAgICAgICAgICAgICcjZmluYW5jZSc6ICdwcmltYXJ5JyxcbiAgICAgICAgICAgICcja2V5T25lJzogJ3BlcnNvbmFsX2ZpbmFuY2VfY2F0ZWdvcnknLFxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICAuLi5maWx0ZXIsXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IEdldENhY2hlRW50aXR5ID0gKHBhcmFtczogQ2FjaGVFbnRpdHlRdWVyeVBhcmFtKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBBTkQgc2sgPSA6c2snLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBgQ0FDSEVFTlRJVFkjJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogcGFyYW1zLnNrIH0sXG4gICAgICAgIH0sXG4gICAgfVxuICAgIGlmIChwYXJhbXMuZXhwaXJlX2F0KSB7XG4gICAgICAgIC8vIEFkZGluZyB0aGUgRmlsdGVyRXhwcmVzc2lvbiB0byBjaGVjayBpZiBleHBpcmVfYXQgaXMgbGVzcyB0aGFuIHRoZSBwcm92aWRlZCBleHBpcmVfYXRcbiAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2V4cGlyZXNBdCA+IDpleHBpcmVzQXQnXG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7XG4gICAgICAgICAgICAnI2V4cGlyZXNBdCc6ICdleHBpcmVfYXQnLCAvLyBVc2luZyBhdHRyaWJ1dGUgbmFtZSBtYXBwaW5nIGZvciBFeHBpcmVzQXRcbiAgICAgICAgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOmV4cGlyZXNBdCddID0geyBOOiBwYXJhbXMuZXhwaXJlX2F0LnRvU3RyaW5nKCkgfSAvLyBBc3N1bWluZyBleHBpcmVzQXQgaXMgYSBudW1iZXJcbiAgICB9XG5cbiAgICBjb25zb2xlLmluZm8ocGFyYW1zKVxuICAgIHJldHVybiBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICAuLi5maWx0ZXIsXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IFB1dENhY2hlRW50aXR5ID0gKHBhcmFtczogQ2FjaGVFbnRpdHlRdWVyeVBhcmFtLCBkYXRhOiBhbnkpID0+IHtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICBwazogeyBTOiBgQ0FDSEVFTlRJVFkjJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICBzazogeyBTOiBwYXJhbXMuc2sgfSxcbiAgICAgICAgZXhwaXJlX2F0OiB7IE46IHBhcmFtcy5leHBpcmVfYXQudG9TdHJpbmcoKSB9LCAvLyBTdG9yaW5nIEV4cGlyZXNBdCBhcyBhIG51bWJlciAodGltZXN0YW1wKVxuICAgICAgICAuLi5kYXRhLCAvLyBTcHJlYWQgYW55IGFkZGl0aW9uYWwgZGF0YSBhdHRyaWJ1dGVzXG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgSXRlbTogaXRlbSxcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0SXRlbXMgPSAoKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwaycsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICc6cGsnOiB7IFM6IGBJVEVNU2AgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0VXNlciA9IChpZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBhbmQgc2sgPSA6c2snLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBpZCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogJ3YwJyB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICByZXR1cm4gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgLi4uZmlsdGVyLFxuICAgIH0pXG59XG4iXX0=