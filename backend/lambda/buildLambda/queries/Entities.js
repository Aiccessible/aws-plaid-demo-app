"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetUser = exports.GetItems = exports.PutCacheEntity = exports.GetCacheEntity = exports.GetEntities = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
function mapStartDayToDate(startDay) {
    const { day, month, year } = startDay;
    // Ensure the day and month are two digits by padding them with zeroes
    const formattedDay = String(day).padStart(2, '0');
    const formattedMonth = String(month).padStart(2, '0'); // Months should be zero-padded
    // Return the date in 'YYYY-MM-DD' format
    return `${year}-${formattedMonth}-${formattedDay}`;
}
// SECURITY and ACCOUNT dont have date range in key
const GetEntities = (params) => {
    let filter = {
        KeyConditionExpression: 'pk = :pk AND begins_with(sk, :sk)',
        ExpressionAttributeValues: {
            ':pk': { S: params.pk ?? `USER#${params.username}#ITEM#${params.id}` },
            ':sk': { S: `${params.entityName}` },
        },
    };
    if (params.dateRange && !params.dateRange.hasNoTimeConstraint) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = { S: mapStartDayToDate(params.dateRange.startDay) };
        filter['ExpressionAttributeValues'][':endDate'] = { S: mapStartDayToDate(params.dateRange.endDay) };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    if (params.customDateRange) {
        filter = { ...filter, ExpressionAttributeNames: {} };
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = {
            S: params.customDateRange[0] ? new Date(params.customDateRange[0]).toISOString().split('.')[0] : 0,
        };
        filter['ExpressionAttributeValues'][':endDate'] = {
            S: params.customDateRange[1]
                ? new Date(params.customDateRange[1]).toISOString().split('.')[0]
                : new Date().toISOString().split('.')[0],
        };
        filter['ExpressionAttributeNames'] = { '#date': 'date' };
    }
    if (params.highLevelCategory) {
        if (!filter['FilterExpression']) {
            filter['FilterExpression'] = '#finance = :primaryCategory';
        }
        else {
            filter['FilterExpression'] = filter['FilterExpression'] + ' AND #finance = :primaryCategory';
        }
        filter['ExpressionAttributeValues'][':primaryCategory'] = {
            S: params.highLevelCategory,
        };
        filter['ExpressionAttributeNames'] = {
            ...(filter['ExpressionAttributeNames'] ?? {}),
            '#finance': 'personal_finance_category.primary',
        };
    }
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetEntities = GetEntities;
const GetCacheEntity = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `CACHEENTITY#${params.id}` },
        },
    };
    if (params.expiresAt) {
        // Adding the FilterExpression to check if ExpiresAt is less than the provided expiresAt
        filter['FilterExpression'] = '#expiresAt < :expiresAt';
        filter['ExpressionAttributeNames'] = {
            '#expiresAt': 'ExpiresAt', // Using attribute name mapping for ExpiresAt
        };
        filter['ExpressionAttributeValues'][':expiresAt'] = { N: params.expiresAt.toString() }; // Assuming expiresAt is a number (timestamp)
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetCacheEntity = GetCacheEntity;
const PutCacheEntity = (params, data) => {
    const item = {
        pk: `CACHEENTITY#${params.id}`,
        ExpiresAt: params.expiresAt, // Storing ExpiresAt as a number (timestamp)
        ...data, // Spread any additional data attributes
    };
    return new client_dynamodb_1.PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: item,
    });
};
exports.PutCacheEntity = PutCacheEntity;
const GetItems = () => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `ITEMS` },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetItems = GetItems;
const GetUser = (id) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk and sk = :sk',
        ExpressionAttributeValues: {
            ':pk': { S: id },
            ':sk': { S: 'v0' },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetUser = GetUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcXVlcmllcy9FbnRpdGllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBdUU7QUFtQnZFLFNBQVMsaUJBQWlCLENBQUMsUUFBeUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFBO0lBRXJDLHNFQUFzRTtJQUN0RSxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLCtCQUErQjtJQUVyRix5Q0FBeUM7SUFDekMsT0FBTyxHQUFHLElBQUksSUFBSSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUE7QUFDdEQsQ0FBQztBQUVELG1EQUFtRDtBQUM1QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQXlCLEVBQUUsRUFBRTtJQUNyRCxJQUFJLE1BQU0sR0FBUTtRQUNkLHNCQUFzQixFQUFFLG1DQUFtQztRQUMzRCx5QkFBeUIsRUFBRTtZQUN2QixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEVBQUUsSUFBSSxRQUFRLE1BQU0sQ0FBQyxRQUFRLFNBQVMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ3RFLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRTtTQUN2QztLQUNKLENBQUE7SUFDRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDNUQsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLEVBQUUsd0JBQXdCLEVBQUUs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QUFBLGNBQWMsa0JBVzFCO0FBRU0sTUFBTSxRQUFRLEdBQUcsR0FBRyxFQUFFO0lBQ3pCLE1BQU0sTUFBTSxHQUFRO1FBQ2hCLHNCQUFzQixFQUFFLFVBQVU7UUFDbEMseUJBQXlCLEVBQUU7WUFDdkIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRTtTQUN4QjtLQUNKLENBQUE7SUFDRCxPQUFPLElBQUksOEJBQVksQ0FBQztRQUNwQixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO1FBQ2pDLEdBQUcsTUFBTTtLQUNaLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQVhZLFFBQUEsUUFBUSxZQVdwQjtBQUVNLE1BQU0sT0FBTyxHQUFHLENBQUMsRUFBVSxFQUFFLEVBQUU7SUFDbEMsTUFBTSxNQUFNLEdBQVE7UUFDaEIsc0JBQXNCLEVBQUUsdUJBQXVCO1FBQy9DLHlCQUF5QixFQUFFO1lBQ3ZCLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUU7WUFDaEIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRTtTQUNyQjtLQUNKLENBQUE7SUFDRCxPQUFPLElBQUksOEJBQVksQ0FBQztRQUNwQixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO1FBQ2pDLEdBQUcsTUFBTTtLQUNaLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQVpZLFFBQUEsT0FBTyxXQVluQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5Q29tbWFuZCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBEYXRhUmFuZ2VSZXNwb25zZSwgR3B0RGF0ZVJlc3BvbnNlIH0gZnJvbSAnLi4vZ3B0J1xuaW1wb3J0IHsgSGlnaExldmVsVHJhbnNhY3Rpb25DYXRlZ29yeSB9IGZyb20gJy4uL0FQSSdcblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlRdWVyeVBhcmFtcyB7XG4gICAgdXNlcm5hbWU6IHN0cmluZ1xuICAgIGlkOiBzdHJpbmdcbiAgICBkYXRlUmFuZ2U6IERhdGFSYW5nZVJlc3BvbnNlIHwgdW5kZWZpbmVkXG4gICAgY3VzdG9tRGF0ZVJhbmdlPzogW251bWJlcj8sIG51bWJlcj9dIHwgbnVsbCB8IHVuZGVmaW5lZFxuICAgIGVudGl0eU5hbWU6IHN0cmluZ1xuICAgIHBrPzogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgaGlnaExldmVsQ2F0ZWdvcnk/OiBIaWdoTGV2ZWxUcmFuc2FjdGlvbkNhdGVnb3J5XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVFbnRpdHlRdWVyeVBhcmFtIHtcbiAgICBpZDogc3RyaW5nXG4gICAgZXhwaXJlc0F0OiBudW1iZXJcbn1cblxuZnVuY3Rpb24gbWFwU3RhcnREYXlUb0RhdGUoc3RhcnREYXk6IEdwdERhdGVSZXNwb25zZSk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBkYXksIG1vbnRoLCB5ZWFyIH0gPSBzdGFydERheVxuXG4gICAgLy8gRW5zdXJlIHRoZSBkYXkgYW5kIG1vbnRoIGFyZSB0d28gZGlnaXRzIGJ5IHBhZGRpbmcgdGhlbSB3aXRoIHplcm9lc1xuICAgIGNvbnN0IGZvcm1hdHRlZERheSA9IFN0cmluZyhkYXkpLnBhZFN0YXJ0KDIsICcwJylcbiAgICBjb25zdCBmb3JtYXR0ZWRNb250aCA9IFN0cmluZyhtb250aCkucGFkU3RhcnQoMiwgJzAnKSAvLyBNb250aHMgc2hvdWxkIGJlIHplcm8tcGFkZGVkXG5cbiAgICAvLyBSZXR1cm4gdGhlIGRhdGUgaW4gJ1lZWVktTU0tREQnIGZvcm1hdFxuICAgIHJldHVybiBgJHt5ZWFyfS0ke2Zvcm1hdHRlZE1vbnRofS0ke2Zvcm1hdHRlZERheX1gXG59XG5cbi8vIFNFQ1VSSVRZIGFuZCBBQ0NPVU5UIGRvbnQgaGF2ZSBkYXRlIHJhbmdlIGluIGtleVxuZXhwb3J0IGNvbnN0IEdldEVudGl0aWVzID0gKHBhcmFtczogRW50aXR5UXVlcnlQYXJhbXMpID0+IHtcbiAgICBsZXQgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBBTkQgYmVnaW5zX3dpdGgoc2ssIDpzayknLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBwYXJhbXMucGsgPz8gYFVTRVIjJHtwYXJhbXMudXNlcm5hbWV9I0lURU0jJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogYCR7cGFyYW1zLmVudGl0eU5hbWV9YCB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICBpZiAocGFyYW1zLmRhdGVSYW5nZSAmJiAhcGFyYW1zLmRhdGVSYW5nZS5oYXNOb1RpbWVDb25zdHJhaW50KSB7XG4gICAgICAgIGZpbHRlciA9IHsgLi4uZmlsdGVyLCBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHt9IH1cbiAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2RhdGUgQkVUV0VFTiA6c3RhcnREYXRlIEFORCA6ZW5kRGF0ZSdcbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzpzdGFydERhdGUnXSA9IHsgUzogbWFwU3RhcnREYXlUb0RhdGUocGFyYW1zLmRhdGVSYW5nZS5zdGFydERheSkgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOmVuZERhdGUnXSA9IHsgUzogbWFwU3RhcnREYXlUb0RhdGUocGFyYW1zLmRhdGVSYW5nZS5lbmREYXkpIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA9IHsgJyNkYXRlJzogJ2RhdGUnIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcy5jdXN0b21EYXRlUmFuZ2UpIHtcbiAgICAgICAgZmlsdGVyID0geyAuLi5maWx0ZXIsIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge30gfVxuICAgICAgICBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSA9ICcjZGF0ZSBCRVRXRUVOIDpzdGFydERhdGUgQU5EIDplbmREYXRlJ1xuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOnN0YXJ0RGF0ZSddID0ge1xuICAgICAgICAgICAgUzogcGFyYW1zLmN1c3RvbURhdGVSYW5nZVswXSA/IG5ldyBEYXRlKHBhcmFtcy5jdXN0b21EYXRlUmFuZ2VbMF0pLnRvSVNPU3RyaW5nKCkuc3BsaXQoJy4nKVswXSA6IDAsXG4gICAgICAgIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzplbmREYXRlJ10gPSB7XG4gICAgICAgICAgICBTOiBwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlWzFdXG4gICAgICAgICAgICAgICAgPyBuZXcgRGF0ZShwYXJhbXMuY3VzdG9tRGF0ZVJhbmdlWzFdKS50b0lTT1N0cmluZygpLnNwbGl0KCcuJylbMF1cbiAgICAgICAgICAgICAgICA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnLicpWzBdLFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7ICcjZGF0ZSc6ICdkYXRlJyB9XG4gICAgfVxuICAgIGlmIChwYXJhbXMuaGlnaExldmVsQ2F0ZWdvcnkpIHtcbiAgICAgICAgaWYgKCFmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSkge1xuICAgICAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSAnI2ZpbmFuY2UgPSA6cHJpbWFyeUNhdGVnb3J5J1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmlsdGVyWydGaWx0ZXJFeHByZXNzaW9uJ10gPSBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSArICcgQU5EICNmaW5hbmNlID0gOnByaW1hcnlDYXRlZ29yeSdcbiAgICAgICAgfVxuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMnXVsnOnByaW1hcnlDYXRlZ29yeSddID0ge1xuICAgICAgICAgICAgUzogcGFyYW1zLmhpZ2hMZXZlbENhdGVnb3J5LFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzJ10gPSB7XG4gICAgICAgICAgICAuLi4oZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA/PyB7fSksXG4gICAgICAgICAgICAnI2ZpbmFuY2UnOiAncGVyc29uYWxfZmluYW5jZV9jYXRlZ29yeS5wcmltYXJ5JyxcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgLi4uZmlsdGVyLFxuICAgIH0pXG59XG5cbmV4cG9ydCBjb25zdCBHZXRDYWNoZUVudGl0eSA9IChwYXJhbXM6IENhY2hlRW50aXR5UXVlcnlQYXJhbSkgPT4ge1xuICAgIGNvbnN0IGZpbHRlcjogYW55ID0ge1xuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsnLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBgQ0FDSEVFTlRJVFkjJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICBpZiAocGFyYW1zLmV4cGlyZXNBdCkge1xuICAgICAgICAvLyBBZGRpbmcgdGhlIEZpbHRlckV4cHJlc3Npb24gdG8gY2hlY2sgaWYgRXhwaXJlc0F0IGlzIGxlc3MgdGhhbiB0aGUgcHJvdmlkZWQgZXhwaXJlc0F0XG4gICAgICAgIGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddID0gJyNleHBpcmVzQXQgPCA6ZXhwaXJlc0F0J1xuICAgICAgICBmaWx0ZXJbJ0V4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyddID0ge1xuICAgICAgICAgICAgJyNleHBpcmVzQXQnOiAnRXhwaXJlc0F0JywgLy8gVXNpbmcgYXR0cmlidXRlIG5hbWUgbWFwcGluZyBmb3IgRXhwaXJlc0F0XG4gICAgICAgIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzpleHBpcmVzQXQnXSA9IHsgTjogcGFyYW1zLmV4cGlyZXNBdC50b1N0cmluZygpIH0gLy8gQXNzdW1pbmcgZXhwaXJlc0F0IGlzIGEgbnVtYmVyICh0aW1lc3RhbXApXG4gICAgfVxuXG4gICAgY29uc29sZS5pbmZvKHBhcmFtcylcbiAgICByZXR1cm4gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgLi4uZmlsdGVyLFxuICAgIH0pXG59XG5cbmV4cG9ydCBjb25zdCBQdXRDYWNoZUVudGl0eSA9IChwYXJhbXM6IENhY2hlRW50aXR5UXVlcnlQYXJhbSwgZGF0YTogYW55KSA9PiB7XG4gICAgY29uc3QgaXRlbTogYW55ID0ge1xuICAgICAgICBwazogYENBQ0hFRU5USVRZIyR7cGFyYW1zLmlkfWAsXG4gICAgICAgIEV4cGlyZXNBdDogcGFyYW1zLmV4cGlyZXNBdCwgLy8gU3RvcmluZyBFeHBpcmVzQXQgYXMgYSBudW1iZXIgKHRpbWVzdGFtcClcbiAgICAgICAgLi4uZGF0YSwgLy8gU3ByZWFkIGFueSBhZGRpdGlvbmFsIGRhdGEgYXR0cmlidXRlc1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIEl0ZW06IGl0ZW0sXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IEdldEl0ZW1zID0gKCkgPT4ge1xuICAgIGNvbnN0IGZpbHRlcjogYW55ID0ge1xuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsnLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBgSVRFTVNgIH0sXG4gICAgICAgIH0sXG4gICAgfVxuICAgIHJldHVybiBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICAuLi5maWx0ZXIsXG4gICAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IEdldFVzZXIgPSAoaWQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IGZpbHRlcjogYW55ID0ge1xuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsgYW5kIHNrID0gOnNrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogaWQgfSxcbiAgICAgICAgICAgICc6c2snOiB7IFM6ICd2MCcgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuIl19