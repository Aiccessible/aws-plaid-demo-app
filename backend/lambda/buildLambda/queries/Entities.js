"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetUser = exports.GetItems = exports.PutCacheEntity = exports.GetCacheEntity = exports.GetEntities = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
function mapStartDayToDate(startDay) {
    const { day, month, year } = startDay;
    // Ensure the day and month are two digits by padding them with zeroes
    const formattedDay = String(day).padStart(2, '0');
    const formattedMonth = String(month).padStart(2, '0'); // Months should be zero-padded
    // Return the date in 'YYYY-MM-DD' format
    return `${year}-${formattedMonth}-${formattedDay}`;
}
// SECURITY and ACCOUNT dont have date range in key
const GetEntities = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk AND begins_with(sk, :sk)',
        ExpressionAttributeValues: {
            ':pk': { S: params.pk ?? `USER#${params.username}#ITEM#${params.id}` },
            ':sk': { S: `${params.entityName}` },
        },
    };
    if (params.dateRange && !params.dateRange.hasNoTimeConstraint) {
        filter['FilterExpression'] = '#date BETWEEN :startDate AND :endDate';
        filter['ExpressionAttributeValues'][':startDate'] = { S: mapStartDayToDate(params.dateRange.startDay) };
        filter['ExpressionAttributeValues'][':endDate'] = { S: mapStartDayToDate(params.dateRange.endDay) };
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetEntities = GetEntities;
const GetCacheEntity = (params) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `CACHEENTITY#${params.id}` },
        },
    };
    if (params.expiresAt) {
        // Adding the FilterExpression to check if ExpiresAt is less than the provided expiresAt
        filter['FilterExpression'] = '#expiresAt < :expiresAt';
        filter['ExpressionAttributeNames'] = {
            '#expiresAt': 'ExpiresAt', // Using attribute name mapping for ExpiresAt
        };
        filter['ExpressionAttributeValues'][':expiresAt'] = { N: params.expiresAt.toString() }; // Assuming expiresAt is a number (timestamp)
    }
    console.info(params);
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetCacheEntity = GetCacheEntity;
const PutCacheEntity = (params, data) => {
    const item = {
        pk: `CACHEENTITY#${params.id}`,
        ExpiresAt: params.expiresAt, // Storing ExpiresAt as a number (timestamp)
        ...data, // Spread any additional data attributes
    };
    return new client_dynamodb_1.PutItemCommand({
        TableName: process.env.TABLE_NAME,
        Item: item,
    });
};
exports.PutCacheEntity = PutCacheEntity;
const GetItems = () => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: `ITEMS` },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetItems = GetItems;
const GetUser = (id) => {
    const filter = {
        KeyConditionExpression: 'pk = :pk',
        ExpressionAttributeValues: {
            ':pk': { S: id },
        },
    };
    return new client_dynamodb_1.QueryCommand({
        TableName: process.env.TABLE_NAME,
        ...filter,
    });
};
exports.GetUser = GetUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcXVlcmllcy9FbnRpdGllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBdUU7QUFnQnZFLFNBQVMsaUJBQWlCLENBQUMsUUFBeUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFBO0lBRXJDLHNFQUFzRTtJQUN0RSxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLCtCQUErQjtJQUVyRix5Q0FBeUM7SUFDekMsT0FBTyxHQUFHLElBQUksSUFBSSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUE7QUFDdEQsQ0FBQztBQUVELG1EQUFtRDtBQUM1QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQXlCLEVBQUUsRUFBRTtJQUNyRCxNQUFNLE1BQU0sR0FBUTtRQUNoQixzQkFBc0IsRUFBRSxtQ0FBbUM7UUFDM0QseUJBQXlCLEVBQUU7WUFDdkIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxFQUFFLElBQUksUUFBUSxNQUFNLENBQUMsUUFBUSxTQUFTLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRTtZQUN0RSxLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFLEVBQUU7U0FDdkM7S0FDSixDQUFBO0lBQ0QsSUFBSSxNQUFNLENBQUMsU0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzVELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLHVDQUF1QyxDQUFBO1FB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QUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRTtTQUNuQjtLQUNKLENBQUE7SUFDRCxPQUFPLElBQUksOEJBQVksQ0FBQztRQUNwQixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO1FBQ2pDLEdBQUcsTUFBTTtLQUNaLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQVhZLFFBQUEsT0FBTyxXQVduQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5Q29tbWFuZCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBEYXRhUmFuZ2VSZXNwb25zZSwgR3B0RGF0ZVJlc3BvbnNlIH0gZnJvbSAnLi4vZ3B0J1xuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eVF1ZXJ5UGFyYW1zIHtcbiAgICB1c2VybmFtZTogc3RyaW5nXG4gICAgaWQ6IHN0cmluZ1xuICAgIGRhdGVSYW5nZTogRGF0YVJhbmdlUmVzcG9uc2UgfCB1bmRlZmluZWRcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmdcbiAgICBwaz86IHN0cmluZyB8IHVuZGVmaW5lZFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlRW50aXR5UXVlcnlQYXJhbSB7XG4gICAgaWQ6IHN0cmluZ1xuICAgIGV4cGlyZXNBdDogbnVtYmVyXG59XG5cbmZ1bmN0aW9uIG1hcFN0YXJ0RGF5VG9EYXRlKHN0YXJ0RGF5OiBHcHREYXRlUmVzcG9uc2UpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgZGF5LCBtb250aCwgeWVhciB9ID0gc3RhcnREYXlcblxuICAgIC8vIEVuc3VyZSB0aGUgZGF5IGFuZCBtb250aCBhcmUgdHdvIGRpZ2l0cyBieSBwYWRkaW5nIHRoZW0gd2l0aCB6ZXJvZXNcbiAgICBjb25zdCBmb3JtYXR0ZWREYXkgPSBTdHJpbmcoZGF5KS5wYWRTdGFydCgyLCAnMCcpXG4gICAgY29uc3QgZm9ybWF0dGVkTW9udGggPSBTdHJpbmcobW9udGgpLnBhZFN0YXJ0KDIsICcwJykgLy8gTW9udGhzIHNob3VsZCBiZSB6ZXJvLXBhZGRlZFxuXG4gICAgLy8gUmV0dXJuIHRoZSBkYXRlIGluICdZWVlZLU1NLUREJyBmb3JtYXRcbiAgICByZXR1cm4gYCR7eWVhcn0tJHtmb3JtYXR0ZWRNb250aH0tJHtmb3JtYXR0ZWREYXl9YFxufVxuXG4vLyBTRUNVUklUWSBhbmQgQUNDT1VOVCBkb250IGhhdmUgZGF0ZSByYW5nZSBpbiBrZXlcbmV4cG9ydCBjb25zdCBHZXRFbnRpdGllcyA9IChwYXJhbXM6IEVudGl0eVF1ZXJ5UGFyYW1zKSA9PiB7XG4gICAgY29uc3QgZmlsdGVyOiBhbnkgPSB7XG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwayBBTkQgYmVnaW5zX3dpdGgoc2ssIDpzayknLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogeyBTOiBwYXJhbXMucGsgPz8gYFVTRVIjJHtwYXJhbXMudXNlcm5hbWV9I0lURU0jJHtwYXJhbXMuaWR9YCB9LFxuICAgICAgICAgICAgJzpzayc6IHsgUzogYCR7cGFyYW1zLmVudGl0eU5hbWV9YCB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICBpZiAocGFyYW1zLmRhdGVSYW5nZSAmJiAhcGFyYW1zLmRhdGVSYW5nZS5oYXNOb1RpbWVDb25zdHJhaW50KSB7XG4gICAgICAgIGZpbHRlclsnRmlsdGVyRXhwcmVzc2lvbiddID0gJyNkYXRlIEJFVFdFRU4gOnN0YXJ0RGF0ZSBBTkQgOmVuZERhdGUnXG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6c3RhcnREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2Uuc3RhcnREYXkpIH1cbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzJ11bJzplbmREYXRlJ10gPSB7IFM6IG1hcFN0YXJ0RGF5VG9EYXRlKHBhcmFtcy5kYXRlUmFuZ2UuZW5kRGF5KSB9XG4gICAgfVxuICAgIGNvbnNvbGUuaW5mbyhwYXJhbXMpXG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgR2V0Q2FjaGVFbnRpdHkgPSAocGFyYW1zOiBDYWNoZUVudGl0eVF1ZXJ5UGFyYW0pID0+IHtcbiAgICBjb25zdCBmaWx0ZXI6IGFueSA9IHtcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BrID0gOnBrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogYENBQ0hFRU5USVRZIyR7cGFyYW1zLmlkfWAgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgaWYgKHBhcmFtcy5leHBpcmVzQXQpIHtcbiAgICAgICAgLy8gQWRkaW5nIHRoZSBGaWx0ZXJFeHByZXNzaW9uIHRvIGNoZWNrIGlmIEV4cGlyZXNBdCBpcyBsZXNzIHRoYW4gdGhlIHByb3ZpZGVkIGV4cGlyZXNBdFxuICAgICAgICBmaWx0ZXJbJ0ZpbHRlckV4cHJlc3Npb24nXSA9ICcjZXhwaXJlc0F0IDwgOmV4cGlyZXNBdCdcbiAgICAgICAgZmlsdGVyWydFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMnXSA9IHtcbiAgICAgICAgICAgICcjZXhwaXJlc0F0JzogJ0V4cGlyZXNBdCcsIC8vIFVzaW5nIGF0dHJpYnV0ZSBuYW1lIG1hcHBpbmcgZm9yIEV4cGlyZXNBdFxuICAgICAgICB9XG4gICAgICAgIGZpbHRlclsnRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyddWyc6ZXhwaXJlc0F0J10gPSB7IE46IHBhcmFtcy5leHBpcmVzQXQudG9TdHJpbmcoKSB9IC8vIEFzc3VtaW5nIGV4cGlyZXNBdCBpcyBhIG51bWJlciAodGltZXN0YW1wKVxuICAgIH1cblxuICAgIGNvbnNvbGUuaW5mbyhwYXJhbXMpXG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuXG5leHBvcnQgY29uc3QgUHV0Q2FjaGVFbnRpdHkgPSAocGFyYW1zOiBDYWNoZUVudGl0eVF1ZXJ5UGFyYW0sIGRhdGE6IGFueSkgPT4ge1xuICAgIGNvbnN0IGl0ZW06IGFueSA9IHtcbiAgICAgICAgcGs6IGBDQUNIRUVOVElUWSMke3BhcmFtcy5pZH1gLFxuICAgICAgICBFeHBpcmVzQXQ6IHBhcmFtcy5leHBpcmVzQXQsIC8vIFN0b3JpbmcgRXhwaXJlc0F0IGFzIGEgbnVtYmVyICh0aW1lc3RhbXApXG4gICAgICAgIC4uLmRhdGEsIC8vIFNwcmVhZCBhbnkgYWRkaXRpb25hbCBkYXRhIGF0dHJpYnV0ZXNcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5UQUJMRV9OQU1FLFxuICAgICAgICBJdGVtOiBpdGVtLFxuICAgIH0pXG59XG5cbmV4cG9ydCBjb25zdCBHZXRJdGVtcyA9ICgpID0+IHtcbiAgICBjb25zdCBmaWx0ZXI6IGFueSA9IHtcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BrID0gOnBrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogYElURU1TYCB9LFxuICAgICAgICB9LFxuICAgIH1cbiAgICByZXR1cm4gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgLi4uZmlsdGVyLFxuICAgIH0pXG59XG5cbmV4cG9ydCBjb25zdCBHZXRVc2VyID0gKGlkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBmaWx0ZXI6IGFueSA9IHtcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BrID0gOnBrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpwayc6IHsgUzogaWQgfSxcbiAgICAgICAgfSxcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgIC4uLmZpbHRlcixcbiAgICB9KVxufVxuIl19