"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getNetWorth = exports.reduceAccounts = exports.getAccountBalanceMultipler = exports.snapShotNetWorth = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Encryption_1 = require("./queries/Encryption");
const Item_1 = require("./mappers/Item");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
function getEarliestFirstOfMonthWithin90Days(createdAt) {
    return new Date(new Date().getTime() - 1000 * 3600 * 24 * 365);
}
const snapShotNetWorth = async () => {
    // TODO: Add logic to handle last calculated complete month and start from then
    const items = (await (0, Encryption_1.decryptItemsInBatches)((await client.send((0, Entities_1.GetItems)()))?.Items ?? [])).map(Item_1.mapDdbResponseToItem);
    /** TODO: Just add created at to the item? */
    const encryptedUserItemRecord = await Promise.all(items.map(async (el) => await client.send((0, Entities_1.GetUser)(el.sk || ''))));
    const decryptedUserItemRecord = (await (0, Encryption_1.decryptItemsInBatches)(encryptedUserItemRecord.flatMap((output) => output.Items ?? [])))
        .map(Item_1.mapDdbResponseToItem)
        .filter((item) => {
        console.info('Processing', item);
        return item.pk && item.created_at;
    });
    /** Go through users and aggregate transactions */
    await processUsersInBatches(decryptedUserItemRecord);
};
exports.snapShotNetWorth = snapShotNetWorth;
function chunkArray(array, chunkSize) {
    const chunks = [];
    for (let i = 0; i < array.length; i += chunkSize) {
        chunks.push(array.slice(i, i + chunkSize));
    }
    return chunks;
}
async function processUsersInBatches(decryptedUserItemRecord) {
    const userBatches = chunkArray(decryptedUserItemRecord, 100);
    const now = new Date(); // Get the current date and time
    for (const batch of userBatches) {
        await Promise.all(batch.map(async (item) => {
            const startDay = getEarliestFirstOfMonthWithin90Days(new Date(item?.created_at ?? 0));
            console.info(startDay);
            const encryptedTransactions = await client.send((0, Entities_1.GetEntities)({
                pk: item.pk ?? '',
                dateRange: {
                    hasNoTimeConstraint: true,
                },
                username: '',
                id: '',
                entityName: 'SECURITY',
            }));
            const decrypedSecurities = await (0, Security_1.mapSecuritiesToJoinedData)(await (0, Encryption_1.decryptItemsInBatches)(encryptedTransactions.Items ?? []));
            const encryptedAccounts = await client.send((0, Entities_1.GetEntities)({
                pk: item.pk ?? '',
                dateRange: {
                    hasNoTimeConstraint: true,
                },
                username: '',
                id: '',
                entityName: 'ACCOUNT',
            }));
            const decrypedAccounts = encryptedAccounts.Items?.map(Accounts_1.mapDynamoDBToAccount) ?? [];
            const netWorth = (0, exports.reduceAccounts)(decrypedAccounts);
            const securitySnapshot = Object.values(decrypedSecurities);
            const securityNetWorth = (0, exports.getNetWorth)(securitySnapshot);
            const tfsaNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['tfsa'], acc)));
            const rrspNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['rrsp', 'drsp'], acc)));
            const fhsaNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['fhsa'], acc)));
            const command = new client_dynamodb_1.PutItemCommand({
                TableName: process.env.TABLE_NAME,
                Item: {
                    pk: { S: item.pk ? item.pk + '#NETWORTHDAILYSNAPSHOT' : '' },
                    sk: { S: new Date().toDateString() },
                    netWorth: { N: netWorth.toFixed(2) },
                    tfsaNetWorth: { N: tfsaNetWorth.toFixed(2) },
                    rrspNetWorth: { N: rrspNetWorth.toFixed(2) },
                    fhsaNetWorth: { N: fhsaNetWorth.toFixed(2) },
                    securityNetWorth: { N: securityNetWorth.toFixed(2) },
                },
            });
            return client.send(command);
        }));
    }
}
const checkAccountNameOrTypes = (types, acc) => {
    return types
        .map((type) => {
        return acc.name?.toLowerCase()?.includes(type) || acc.type?.toLowerCase().includes(type);
    })
        .includes(true);
};
const getAccountBalanceMultipler = (acc) => (acc.type === 'loan' || acc.type === 'credit' ? -1 : 1);
exports.getAccountBalanceMultipler = getAccountBalanceMultipler;
const reduceAccounts = (accs) => accs.reduce((val, acc) => val + (0, exports.getAccountBalanceMultipler)(acc) * parseFloat(acc.balances?.current || '0'), 0);
exports.reduceAccounts = reduceAccounts;
const getNetWorth = (holdings) => {
    return holdings.reduce((val, holding) => {
        return val + (holding.holding.quantity ?? 0) * (holding.security?.close_price ?? 0);
    }, 0);
};
exports.getNetWorth = getNetWorth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hcFNob3ROZXRXb3J0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zbmFwU2hvdE5ldFdvcnRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhEQUF5RTtBQUN6RSxpREFBbUU7QUFDbkUscURBQTREO0FBQzVELHlDQUFxRDtBQUVyRCxpREFBOEQ7QUFDOUQsaURBQXlEO0FBRXpELE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELFNBQVMsbUNBQW1DLENBQUMsU0FBZTtJQUN4RCxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUE7QUFDbEUsQ0FBQztBQUVNLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDdkMsK0VBQStFO0lBQy9FLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxJQUFBLGtDQUFxQixFQUFDLENBQUMsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsbUJBQVEsR0FBRSxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsMkJBQW9CLENBQUMsQ0FBQTtJQUNuSCw2Q0FBNkM7SUFDN0MsTUFBTSx1QkFBdUIsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBQSxrQkFBTyxFQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbkgsTUFBTSx1QkFBdUIsR0FBRyxDQUM1QixNQUFNLElBQUEsa0NBQXFCLEVBQUMsdUJBQXVCLENBQUMs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RSxFQUFFLENBQUMsR0FBRyxHQUFHLElBQUEsa0NBQTBCLEVBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBTyxJQUFJLEdBQUcsQ0FBQyxFQUN0RyxDQUFDLENBQ0osQ0FBQTtBQUpRLFFBQUEsY0FBYyxrQkFJdEI7QUFFRSxNQUFNLFdBQVcsR0FBRyxDQUFDLFFBQWdFLEVBQUUsRUFBRTtJQUM1RixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDcEMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsV0FBVyxJQUFJLENBQUMsQ0FBQyxDQUFBO0lBQ3ZGLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUNULENBQUMsQ0FBQTtBQUpZLFFBQUEsV0FBVyxlQUl2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYidcbmltcG9ydCB7IEdldEVudGl0aWVzLCBHZXRJdGVtcywgR2V0VXNlciB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyB9IGZyb20gJy4vcXVlcmllcy9FbmNyeXB0aW9uJ1xuaW1wb3J0IHsgbWFwRGRiUmVzcG9uc2VUb0l0ZW0gfSBmcm9tICcuL21hcHBlcnMvSXRlbSdcbmltcG9ydCB7IEFjY291bnQsIEhvbGRpbmcsIEl0ZW0sIFNlY3VyaXR5IH0gZnJvbSAnLi9BUEknXG5pbXBvcnQgeyBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhIH0gZnJvbSAnLi9tYXBwZXJzL1NlY3VyaXR5J1xuaW1wb3J0IHsgbWFwRHluYW1vREJUb0FjY291bnQgfSBmcm9tICcuL21hcHBlcnMvQWNjb3VudHMnXG5cbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuZnVuY3Rpb24gZ2V0RWFybGllc3RGaXJzdE9mTW9udGhXaXRoaW45MERheXMoY3JlYXRlZEF0OiBEYXRlKSB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gMTAwMCAqIDM2MDAgKiAyNCAqIDM2NSlcbn1cblxuZXhwb3J0IGNvbnN0IHNuYXBTaG90TmV0V29ydGggPSBhc3luYyAoKSA9PiB7XG4gICAgLy8gVE9ETzogQWRkIGxvZ2ljIHRvIGhhbmRsZSBsYXN0IGNhbGN1bGF0ZWQgY29tcGxldGUgbW9udGggYW5kIHN0YXJ0IGZyb20gdGhlblxuICAgIGNvbnN0IGl0ZW1zID0gKGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcygoYXdhaXQgY2xpZW50LnNlbmQoR2V0SXRlbXMoKSkpPy5JdGVtcyA/PyBbXSkpLm1hcChtYXBEZGJSZXNwb25zZVRvSXRlbSlcbiAgICAvKiogVE9ETzogSnVzdCBhZGQgY3JlYXRlZCBhdCB0byB0aGUgaXRlbT8gKi9cbiAgICBjb25zdCBlbmNyeXB0ZWRVc2VySXRlbVJlY29yZCA9IGF3YWl0IFByb21pc2UuYWxsKGl0ZW1zLm1hcChhc3luYyAoZWwpID0+IGF3YWl0IGNsaWVudC5zZW5kKEdldFVzZXIoZWwuc2sgfHwgJycpKSkpXG4gICAgY29uc3QgZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQgPSAoXG4gICAgICAgIGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyhlbmNyeXB0ZWRVc2VySXRlbVJlY29yZC5mbGF0TWFwKChvdXRwdXQpID0+IG91dHB1dC5JdGVtcyA/PyBbXSkpXG4gICAgKVxuICAgICAgICAubWFwKG1hcERkYlJlc3BvbnNlVG9JdGVtKVxuICAgICAgICAuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oJ1Byb2Nlc3NpbmcnLCBpdGVtKVxuICAgICAgICAgICAgcmV0dXJuIGl0ZW0ucGsgJiYgaXRlbS5jcmVhdGVkX2F0XG4gICAgICAgIH0pXG4gICAgLyoqIEdvIHRocm91Z2ggdXNlcnMgYW5kIGFnZ3JlZ2F0ZSB0cmFuc2FjdGlvbnMgKi9cbiAgICBhd2FpdCBwcm9jZXNzVXNlcnNJbkJhdGNoZXMoZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQpXG59XG5cbmZ1bmN0aW9uIGNodW5rQXJyYXk8VD4oYXJyYXk6IFRbXSwgY2h1bmtTaXplOiBudW1iZXIpOiBUW11bXSB7XG4gICAgY29uc3QgY2h1bmtzOiBUW11bXSA9IFtdXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkgKz0gY2h1bmtTaXplKSB7XG4gICAgICAgIGNodW5rcy5wdXNoKGFycmF5LnNsaWNlKGksIGkgKyBjaHVua1NpemUpKVxuICAgIH1cbiAgICByZXR1cm4gY2h1bmtzXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NVc2Vyc0luQmF0Y2hlcyhkZWNyeXB0ZWRVc2VySXRlbVJlY29yZDogSXRlbVtdKSB7XG4gICAgY29uc3QgdXNlckJhdGNoZXMgPSBjaHVua0FycmF5KGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkLCAxMDApXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKSAvLyBHZXQgdGhlIGN1cnJlbnQgZGF0ZSBhbmQgdGltZVxuXG4gICAgZm9yIChjb25zdCBiYXRjaCBvZiB1c2VyQmF0Y2hlcykge1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgIGJhdGNoLm1hcChhc3luYyAoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0RGF5ID0gZ2V0RWFybGllc3RGaXJzdE9mTW9udGhXaXRoaW45MERheXMobmV3IERhdGUoaXRlbT8uY3JlYXRlZF9hdCA/PyAwKSlcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oc3RhcnREYXkpXG4gICAgICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkVHJhbnNhY3Rpb25zID0gYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBrOiBpdGVtLnBrID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzTm9UaW1lQ29uc3RyYWludDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gYXMgYW55LFxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5TmFtZTogJ1NFQ1VSSVRZJyxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWNyeXBlZFNlY3VyaXRpZXMgPSBhd2FpdCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhKFxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoZW5jcnlwdGVkVHJhbnNhY3Rpb25zLkl0ZW1zID8/IFtdKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWRBY2NvdW50cyA9IGF3YWl0IGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICBHZXRFbnRpdGllcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwazogaXRlbS5wayA/PyAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVSYW5nZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc05vVGltZUNvbnN0cmFpbnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGFzIGFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6ICdBQ0NPVU5UJyxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWNyeXBlZEFjY291bnRzID0gZW5jcnlwdGVkQWNjb3VudHMuSXRlbXM/Lm1hcChtYXBEeW5hbW9EQlRvQWNjb3VudCkgPz8gW11cbiAgICAgICAgICAgICAgICBjb25zdCBuZXRXb3J0aCA9IHJlZHVjZUFjY291bnRzKGRlY3J5cGVkQWNjb3VudHMpXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VjdXJpdHlTbmFwc2hvdCA9IE9iamVjdC52YWx1ZXMoZGVjcnlwZWRTZWN1cml0aWVzKVxuICAgICAgICAgICAgICAgIGNvbnN0IHNlY3VyaXR5TmV0V29ydGggPSBnZXROZXRXb3J0aChzZWN1cml0eVNuYXBzaG90KVxuICAgICAgICAgICAgICAgIGNvbnN0IHRmc2FOZXRXb3J0aCA9IHJlZHVjZUFjY291bnRzKFxuICAgICAgICAgICAgICAgICAgICBkZWNyeXBlZEFjY291bnRzLmZpbHRlcigoYWNjKSA9PiBjaGVja0FjY291bnROYW1lT3JUeXBlcyhbJ3Rmc2EnXSwgYWNjKSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgY29uc3QgcnJzcE5ldFdvcnRoID0gcmVkdWNlQWNjb3VudHMoXG4gICAgICAgICAgICAgICAgICAgIGRlY3J5cGVkQWNjb3VudHMuZmlsdGVyKChhY2MpID0+IGNoZWNrQWNjb3VudE5hbWVPclR5cGVzKFsncnJzcCcsICdkcnNwJ10sIGFjYykpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnN0IGZoc2FOZXRXb3J0aCA9IHJlZHVjZUFjY291bnRzKFxuICAgICAgICAgICAgICAgICAgICBkZWNyeXBlZEFjY291bnRzLmZpbHRlcigoYWNjKSA9PiBjaGVja0FjY291bnROYW1lT3JUeXBlcyhbJ2Zoc2EnXSwgYWNjKSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgICAgICAgICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGs6IHsgUzogaXRlbS5wayA/IGl0ZW0ucGsgKyAnI05FVFdPUlRIREFJTFlTTkFQU0hPVCcgOiAnJyB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2s6IHsgUzogbmV3IERhdGUoKS50b0RhdGVTdHJpbmcoKSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV0V29ydGg6IHsgTjogbmV0V29ydGgudG9GaXhlZCgyKSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgdGZzYU5ldFdvcnRoOiB7IE46IHRmc2FOZXRXb3J0aC50b0ZpeGVkKDIpIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBycnNwTmV0V29ydGg6IHsgTjogcnJzcE5ldFdvcnRoLnRvRml4ZWQoMikgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZoc2FOZXRXb3J0aDogeyBOOiBmaHNhTmV0V29ydGgudG9GaXhlZCgyKSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlOZXRXb3J0aDogeyBOOiBzZWN1cml0eU5ldFdvcnRoLnRvRml4ZWQoMikgfSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHJldHVybiBjbGllbnQuc2VuZChjb21tYW5kKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgIH1cbn1cblxuY29uc3QgY2hlY2tBY2NvdW50TmFtZU9yVHlwZXMgPSAodHlwZXM6IHN0cmluZ1tdLCBhY2M6IEFjY291bnQpID0+IHtcbiAgICByZXR1cm4gdHlwZXNcbiAgICAgICAgLm1hcCgodHlwZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGFjYy5uYW1lPy50b0xvd2VyQ2FzZSgpPy5pbmNsdWRlcyh0eXBlKSB8fCBhY2MudHlwZT8udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eXBlKVxuICAgICAgICB9KVxuICAgICAgICAuaW5jbHVkZXModHJ1ZSlcbn1cblxuZXhwb3J0IGNvbnN0IGdldEFjY291bnRCYWxhbmNlTXVsdGlwbGVyID0gKGFjYzogQWNjb3VudCkgPT4gKGFjYy50eXBlID09PSAnbG9hbicgfHwgYWNjLnR5cGUgPT09ICdjcmVkaXQnID8gLTEgOiAxKVxuXG5leHBvcnQgY29uc3QgcmVkdWNlQWNjb3VudHMgPSAoYWNjczogQWNjb3VudFtdKSA9PlxuICAgIGFjY3MucmVkdWNlKFxuICAgICAgICAodmFsOiBudW1iZXIsIGFjYykgPT4gdmFsICsgZ2V0QWNjb3VudEJhbGFuY2VNdWx0aXBsZXIoYWNjKSAqIHBhcnNlRmxvYXQoYWNjLmJhbGFuY2VzPy5jdXJyZW50IHx8ICcwJyksXG4gICAgICAgIDBcbiAgICApXG5cbmV4cG9ydCBjb25zdCBnZXROZXRXb3J0aCA9IChob2xkaW5nczogeyBzZWN1cml0eTogU2VjdXJpdHkgfCB1bmRlZmluZWQ7IGhvbGRpbmc6IEhvbGRpbmcgfVtdKSA9PiB7XG4gICAgcmV0dXJuIGhvbGRpbmdzLnJlZHVjZSgodmFsLCBob2xkaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiB2YWwgKyAoaG9sZGluZy5ob2xkaW5nLnF1YW50aXR5ID8/IDApICogKGhvbGRpbmcuc2VjdXJpdHk/LmNsb3NlX3ByaWNlID8/IDApXG4gICAgfSwgMClcbn1cbiJdfQ==