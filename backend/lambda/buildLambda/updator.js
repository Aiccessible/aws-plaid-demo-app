"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseUserIdAndItemId = parseUserIdAndItemId;
exports.updator = updator;
const client_sqs_1 = require("@aws-sdk/client-sqs");
const Encryption_1 = require("./queries/Encryption");
const Entities_1 = require("./queries/Entities");
const Item_1 = require("./mappers/Item");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
console.info('QUEUE URL', process.env.WEBHOOK_URL);
// Initialize the SQS client
const sqsClient = new client_sqs_1.SQSClient({ region: 'ca-central-1' }); // Replace 'your-region' with your actual AWS region
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
function parseUserIdAndItemId(input) {
    const regex = /^USER#([^#]+)#ITEM#([^#]+)$/;
    const match = input.match(regex);
    if (!match) {
        console.error("Invalid format. Expected 'USER#<userId>#ITEM#<itemId>'.");
        return null;
    }
    const [, userId, itemId] = match;
    return { userId, itemId };
}
// Function to send a message to SQS
async function updator() {
    const items = (await (0, Encryption_1.decryptItemsInBatches)((await client.send((0, Entities_1.GetItems)()))?.Items ?? [])).map(Item_1.mapDdbResponseToItem);
    /** TODO: Just add created at to the item? */
    const encryptedUserItemRecord = await Promise.all(items.map(async (el) => await client.send((0, Entities_1.GetUser)(el.sk || ''))));
    const decryptedUserItemRecord = (await (0, Encryption_1.decryptItemsInBatches)(encryptedUserItemRecord.flatMap((output) => output.Items ?? [])))
        .map(Item_1.mapDdbResponseToItem)
        .filter((item) => {
        console.info('Processing', item);
        return item.pk && item.created_at;
    });
    const promises = decryptedUserItemRecord.flatMap(async (userItem) => {
        const { userId, itemId } = parseUserIdAndItemId(userItem.pk ?? '') ?? {};
        if (!userId || !itemId) {
            console.error('Could not parse', userItem.pk);
            return [];
        }
        const params = [
            {
                QueueUrl: process.env.WEBHOOK_URL,
                DelaySeconds: 0,
                MessageAttributes: {
                    WebhookType: {
                        DataType: 'String',
                        StringValue: 'BALANCE',
                    },
                    WebhookCode: {
                        DataType: 'String',
                        StringValue: 'DEFAULT_UPDATE',
                    },
                    ItemId: {
                        DataType: 'String',
                        StringValue: itemId,
                    },
                    UserId: {
                        DataType: 'String',
                        StringValue: userId,
                    },
                },
                MessageBody: '{}', // Empty JSON body
                MessageDeduplicationId: `${userId}BALANCE_DEFAULT_UPDATE${itemId}`,
                MessageGroupId: itemId,
            },
            {
                QueueUrl: process.env.WEBHOOK_URL,
                DelaySeconds: 0,
                MessageAttributes: {
                    WebhookType: {
                        DataType: 'String',
                        StringValue: 'HOLDINGS',
                    },
                    WebhookCode: {
                        DataType: 'String',
                        StringValue: 'DEFAULT_UPDATE',
                    },
                    ItemId: {
                        DataType: 'String',
                        StringValue: itemId,
                    },
                    UserId: {
                        DataType: 'String',
                        StringValue: userId,
                    },
                },
                MessageBody: '{}', // Empty JSON body
                MessageDeduplicationId: `${userId}HOLDINGS_DEFAULT_UPDATE${itemId}`,
                MessageGroupId: itemId,
            },
        ];
        console.debug('Sending message to SQS:', params);
        try {
            const responses = params.map(async (param) => {
                const command = new client_sqs_1.SendMessageCommand(param);
                const response = await sqsClient.send(command);
                console.log('Message sent successfully:', response);
            });
            return await Promise.all(responses);
        }
        catch (error) {
            console.error('Failed to send message to SQS:', error);
        }
        return [];
    });
    console.info(promises, 'waiting for');
    await Promise.all(promises);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91cGRhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBV0Esb0RBV0M7QUFHRCwwQkF1RkM7QUFoSEQsb0RBQW1FO0FBQ25FLHFEQUE0RDtBQUM1RCxpREFBc0Q7QUFDdEQseUNBQXFEO0FBQ3JELDhEQUF5RDtBQUV6RCxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ2xELDRCQUE0QjtBQUM1QixNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQSxDQUFDLG9EQUFvRDtBQUNoSCxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQTtBQUU3RCxTQUFnQixvQkFBb0IsQ0FBQyxLQUFhO0lBQzlDLE1BQU0sS0FBSyxHQUFHLDZCQUE2QixDQUFBO0lBRTNDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDaEMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFBO1FBQ3hFLE9BQU8sSUFBSSxDQUFBO0lBQ2YsQ0FBQztJQUVELE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUE7SUFDaEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQTtBQUM3QixDQUFDO0FBRUQsb0NBQW9DO0FBQzdCLEtBQUssVUFBVSxPQUFPO0lBQ3pCLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxJQUFBLGtDQUFxQixFQUFDLENBQUMsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsbUJBQVEsR0FBRSxDQUFDLENBQUMs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QUEwQixNQUFNLEVBQUU7Z0JBQ25FLGNBQWMsRUFBRSxNQUFNO2FBQ3pCO1NBQ0osQ0FBQTtRQUVELE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFFaEQsSUFBSSxDQUFDO1lBQ0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3pDLE1BQU0sT0FBTyxHQUFHLElBQUksK0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBQzdDLE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDOUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSxRQUFRLENBQUMsQ0FBQTtZQUN2RCxDQUFDLENBQUMsQ0FBQTtZQUNGLE9BQU8sTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUMxRCxDQUFDO1FBQ0QsT0FBTyxFQUFFLENBQUE7SUFDYixDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGFBQWEsQ0FBQyxDQUFBO0lBQ3JDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUMvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU1FTQ2xpZW50LCBTZW5kTWVzc2FnZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc3FzJ1xuaW1wb3J0IHsgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzIH0gZnJvbSAnLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5pbXBvcnQgeyBHZXRJdGVtcywgR2V0VXNlciB9IGZyb20gJy4vcXVlcmllcy9FbnRpdGllcydcbmltcG9ydCB7IG1hcERkYlJlc3BvbnNlVG9JdGVtIH0gZnJvbSAnLi9tYXBwZXJzL0l0ZW0nXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYidcblxuY29uc29sZS5pbmZvKCdRVUVVRSBVUkwnLCBwcm9jZXNzLmVudi5XRUJIT09LX1VSTClcbi8vIEluaXRpYWxpemUgdGhlIFNRUyBjbGllbnRcbmNvbnN0IHNxc0NsaWVudCA9IG5ldyBTUVNDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pIC8vIFJlcGxhY2UgJ3lvdXItcmVnaW9uJyB3aXRoIHlvdXIgYWN0dWFsIEFXUyByZWdpb25cbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2NhLWNlbnRyYWwtMScgfSlcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlVXNlcklkQW5kSXRlbUlkKGlucHV0OiBzdHJpbmcpOiB7IHVzZXJJZDogc3RyaW5nOyBpdGVtSWQ6IHN0cmluZyB9IHwgbnVsbCB7XG4gICAgY29uc3QgcmVnZXggPSAvXlVTRVIjKFteI10rKSNJVEVNIyhbXiNdKykkL1xuXG4gICAgY29uc3QgbWF0Y2ggPSBpbnB1dC5tYXRjaChyZWdleClcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJJbnZhbGlkIGZvcm1hdC4gRXhwZWN0ZWQgJ1VTRVIjPHVzZXJJZD4jSVRFTSM8aXRlbUlkPicuXCIpXG4gICAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgY29uc3QgWywgdXNlcklkLCBpdGVtSWRdID0gbWF0Y2hcbiAgICByZXR1cm4geyB1c2VySWQsIGl0ZW1JZCB9XG59XG5cbi8vIEZ1bmN0aW9uIHRvIHNlbmQgYSBtZXNzYWdlIHRvIFNRU1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0b3IoKSB7XG4gICAgY29uc3QgaXRlbXMgPSAoYXdhaXQgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzKChhd2FpdCBjbGllbnQuc2VuZChHZXRJdGVtcygpKSk/Lkl0ZW1zID8/IFtdKSkubWFwKG1hcERkYlJlc3BvbnNlVG9JdGVtKVxuICAgIC8qKiBUT0RPOiBKdXN0IGFkZCBjcmVhdGVkIGF0IHRvIHRoZSBpdGVtPyAqL1xuICAgIGNvbnN0IGVuY3J5cHRlZFVzZXJJdGVtUmVjb3JkID0gYXdhaXQgUHJvbWlzZS5hbGwoaXRlbXMubWFwKGFzeW5jIChlbCkgPT4gYXdhaXQgY2xpZW50LnNlbmQoR2V0VXNlcihlbC5zayB8fCAnJykpKSlcbiAgICBjb25zdCBkZWNyeXB0ZWRVc2VySXRlbVJlY29yZCA9IChcbiAgICAgICAgYXdhaXQgZGVjcnlwdEl0ZW1zSW5CYXRjaGVzKGVuY3J5cHRlZFVzZXJJdGVtUmVjb3JkLmZsYXRNYXAoKG91dHB1dCkgPT4gb3V0cHV0Lkl0ZW1zID8/IFtdKSlcbiAgICApXG4gICAgICAgIC5tYXAobWFwRGRiUmVzcG9uc2VUb0l0ZW0pXG4gICAgICAgIC5maWx0ZXIoKGl0ZW0pID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbygnUHJvY2Vzc2luZycsIGl0ZW0pXG4gICAgICAgICAgICByZXR1cm4gaXRlbS5wayAmJiBpdGVtLmNyZWF0ZWRfYXRcbiAgICAgICAgfSlcbiAgICBjb25zdCBwcm9taXNlcyA9IGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkLmZsYXRNYXAoYXN5bmMgKHVzZXJJdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkLCBpdGVtSWQgfSA9IHBhcnNlVXNlcklkQW5kSXRlbUlkKHVzZXJJdGVtLnBrID8/ICcnKSA/PyB7fVxuICAgICAgICBpZiAoIXVzZXJJZCB8fCAhaXRlbUlkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdDb3VsZCBub3QgcGFyc2UnLCB1c2VySXRlbS5waylcbiAgICAgICAgICAgIHJldHVybiBbXVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBRdWV1ZVVybDogcHJvY2Vzcy5lbnYuV0VCSE9PS19VUkwsXG4gICAgICAgICAgICAgICAgRGVsYXlTZWNvbmRzOiAwLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgIFdlYmhvb2tUeXBlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogJ0JBTEFOQ0UnLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBXZWJob29rQ29kZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6ICdERUZBVUxUX1VQREFURScsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIEl0ZW1JZDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGl0ZW1JZCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgVXNlcklkOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogdXNlcklkLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgTWVzc2FnZUJvZHk6ICd7fScsIC8vIEVtcHR5IEpTT04gYm9keVxuICAgICAgICAgICAgICAgIE1lc3NhZ2VEZWR1cGxpY2F0aW9uSWQ6IGAke3VzZXJJZH1CQUxBTkNFX0RFRkFVTFRfVVBEQVRFJHtpdGVtSWR9YCxcbiAgICAgICAgICAgICAgICBNZXNzYWdlR3JvdXBJZDogaXRlbUlkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBRdWV1ZVVybDogcHJvY2Vzcy5lbnYuV0VCSE9PS19VUkwsXG4gICAgICAgICAgICAgICAgRGVsYXlTZWNvbmRzOiAwLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgIFdlYmhvb2tUeXBlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogJ0hPTERJTkdTJyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgV2ViaG9va0NvZGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiAnREVGQVVMVF9VUERBVEUnLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBJdGVtSWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBpdGVtSWQsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIFVzZXJJZDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VCb2R5OiAne30nLCAvLyBFbXB0eSBKU09OIGJvZHlcbiAgICAgICAgICAgICAgICBNZXNzYWdlRGVkdXBsaWNhdGlvbklkOiBgJHt1c2VySWR9SE9MRElOR1NfREVGQVVMVF9VUERBVEUke2l0ZW1JZH1gLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VHcm91cElkOiBpdGVtSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICBdXG5cbiAgICAgICAgY29uc29sZS5kZWJ1ZygnU2VuZGluZyBtZXNzYWdlIHRvIFNRUzonLCBwYXJhbXMpXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlcyA9IHBhcmFtcy5tYXAoYXN5bmMgKHBhcmFtKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBTZW5kTWVzc2FnZUNvbW1hbmQocGFyYW0pXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzcXNDbGllbnQuc2VuZChjb21tYW5kKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdNZXNzYWdlIHNlbnQgc3VjY2Vzc2Z1bGx5OicsIHJlc3BvbnNlKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChyZXNwb25zZXMpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBtZXNzYWdlIHRvIFNRUzonLCBlcnJvcilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW11cbiAgICB9KVxuICAgIGNvbnNvbGUuaW5mbyhwcm9taXNlcywgJ3dhaXRpbmcgZm9yJylcbiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcylcbn1cbiJdfQ==