"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mapHoldingsAndSecuritiesToJointData = exports.mapJointDataToChatInput = void 0;
exports.mapDynamoDBToSecurityDetails = mapDynamoDBToSecurityDetails;
exports.mapSecuritiesToJoinedData = mapSecuritiesToJoinedData;
const InvestmentHoldings_1 = require("./InvestmentHoldings");
const Encryption_1 = require("../queries/Encryption");
// Mapper function for DynamoDB to SecurityDetails interface
function mapDynamoDBToSecurityDetails(item) {
    return {
        close_price: parseFloat(item.close_price?.N || ''), // DynamoDB number type
        close_price_as_of: item.close_price_as_of?.S || null, // Nullable string
        cusip: item.cusip?.S || '',
        institution_id: item.institution_id?.S || null, // Nullable string
        institution_security_id: item.institution_security_id?.S || null, // Nullable string
        is_cash_equivalent: item.is_cash_equivalent?.BOOL || false, // Boolean type
        isin: item.isin?.S || '',
        iso_currency_code: item.iso_currency_code?.S || '',
        name: item.name?.S || '',
        proxy_security_id: item.proxy_security_id?.S || null, // Nullable string
        security_id: item.security_id?.S || '',
        sedol: item.sedol?.S || null, // Nullable string
        ticker_symbol: item.ticker_symbol?.S || '',
        type: item.type?.S || '',
        unofficial_currency_code: item.unofficial_currency_code?.S || null, // Nullable string
        market_identifier_code: item.market_identifier_code?.S || '',
        option_contract: item.option_contract?.S || null, // Nullable string
        plaid_type: item.plaid_type?.S ?? '',
        __typename: 'Security',
    };
}
async function mapSecuritiesToJoinedData(items) {
    const decryptedItems = await (0, Encryption_1.decryptItemsInBatches)(items);
    const mappedItems = decryptedItems.map((item) => {
        if (item.plaid_type?.S === 'Security') {
            return mapDynamoDBToSecurityDetails(item);
        }
        else if (item.plaid_type?.S === 'Holding') {
            return (0, InvestmentHoldings_1.mapDynamoDBToInvestmentHolding)(item);
        }
        else {
            throw new Error('Unsupported type');
        }
    });
    return (0, exports.mapHoldingsAndSecuritiesToJointData)(mappedItems);
}
const mapJointDataToChatInput = (jointData) => {
    const chatInputs = [];
    // Iterate over the values in the `jointData` object
    Object.values(jointData).forEach(({ security, holding }) => {
        let chatInput = '(';
        if (security) {
            // Process security fields into a chat message
            chatInput += `Security Name: ${security.name || 'N/A'}\n`;
            chatInput += `Ticker Symbol: ${security.ticker_symbol || 'N/A'}\n`;
            chatInput += `Close Price: ${security.close_price ? `$${security.close_price.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Close Price As Of: ${security.close_price_as_of || 'N/A'}\n`;
            chatInput += `Sector: ${security.sector || 'N/A'}\n`;
            chatInput += `Industry: ${security.industry || 'N/A'}\n`;
        }
        if (holding) {
            // Process holding fields into the same message
            chatInput += `Quantity: ${holding.quantity || 'N/A'}\n`;
            chatInput += `Cost Basis: ${holding.cost_basis ? `$${holding.cost_basis.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Value: ${holding.institution_value ? `$${holding.institution_value.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Price: ${holding.institution_price ? `$${holding.institution_price.toFixed(2)}` : 'N/A'}\n`;
            chatInput += `Institution Price As Of: ${holding.institution_price_as_of || 'N/A'}`;
        }
        chatInput += ')\n';
        chatInputs.push(chatInput);
    });
    return chatInputs.join('');
};
exports.mapJointDataToChatInput = mapJointDataToChatInput;
const mapHoldingsAndSecuritiesToJointData = (holdings) => {
    const getId = (el) => el.account_id + '-' + el.security_id;
    const accountAndsecurityIdToEntity = {};
    const investments = [...holdings];
    investments?.forEach((el) => {
        if (el.plaid_type === 'Holding') {
            accountAndsecurityIdToEntity[getId(el)] = {
                security: investments?.find((sec) => sec.plaid_type === 'Security' && sec.security_id === el.security_id),
                holding: el,
            };
        }
    });
    return accountAndsecurityIdToEntity;
};
exports.mapHoldingsAndSecuritiesToJointData = mapHoldingsAndSecuritiesToJointData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VjdXJpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFwcGVycy9TZWN1cml0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFNQSxvRUFzQkM7QUFFRCw4REFjQztBQTFDRCw2REFBcUU7QUFDckUsc0RBQTZEO0FBRTdELDREQUE0RDtBQUM1RCxTQUFnQiw0QkFBNEIsQ0FBQyxJQUF1QztJQUNoRixPQUFPO1FBQ0gsV0FBVyxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSx1QkFBdUI7UUFDM0UsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUUsa0JBQWtCO1FBQ3hFLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFO1FBQzFCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUUsa0JBQWtCO1FBQ2xFLHVCQUF1QixFQUFFLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLGtCQUFrQjtRQUNwRixrQkFBa0IsRUFBRSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxJQUFJLEtBQUssRUFBRSxlQUFlO1FBQzNFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFO1FBQ3hCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLElBQUksRUFBRTtRQUNsRCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksRUFBRTtRQUN4QixpQkFBaUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxrQkFBa0I7UUFDeEUsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUU7UUFDdEMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxrQkFBa0I7UUFDaEQsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxJQUFJLEVBQUU7UUFDMUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUU7UUFDeEIsd0JBQXdCLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUUsa0JBQWtCO1FBQ3RGLHNCQUFzQixFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLElBQUksRUFBRTtRQUM1RCxlQUFlLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLGtCQUFrQjtRQUNwRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRTtRQUNwQyxVQUFVLEVBQUUsVUFBVTtLQUN6QixDQUFBO0FBQ0wsQ0FBQztBQUVNLEtBQUssVUFBVSx5QkFBeUIsQ0FDM0MsS0FBMEM7SUFFMUMsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFBLGtDQUFxQixFQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3pELE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUM1QyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQ3BDLE9BQU8sNEJBQTRCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDN0MsQ0FBQzthQUFNLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDMUMsT0FBTyxJQUFBLG1EQUE4QixFQUFDLElBQUksQ0FBQyxDQUFBO1FBQy9DLENBQUM7YUFBTSxDQUFDO1lBQ0osTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sSUFBQSwyQ0FBbUMsRUFBQyxXQUFXLENBQUMsQ0FBQTtBQUMzRCxDQUFDO0FBRU0sTUFBTSx1QkFBdUIsR0FBRyxDQUFDLFNBQTZCLEVBQVUsRUFBRTtJQUM3RSxNQUFNLFVBQVUsR0FBYSxFQUFFLENBQUE7SUFDL0Isb0RBQW9EO0lBQ3BELE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRTtRQUN2RCxJQUFJLFNBQVMsR0FBRyxHQUFHLENBQUE7UUFFbkIsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNYLDhDQUE4QztZQUM5QyxTQUFTLElBQUksa0JBQWtCLFFBQVEsQ0FBQyxJQUFJLElBQUksS0FBSyxJQUFJLENBQUE7WUFDekQsU0FBUyxJQUFJLGtCQUFrQixRQUFRLENBQUMsYUFBYSxJQUFJLEtBQUssSUFBSSxDQUFBO1lBQ2xFLFNBQVMsSUFBSSxnQkFBZ0IsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQTtZQUNyRyxTQUFTLElBQUksc0JBQXNCLFFBQVEsQ0FBQyxpQkFBaUIsSUFBSSxLQUFLLElBQUksQ0FBQTtZQUMxRSxTQUFTLElBQUksV0FBVyxRQUFRLENBQUMsTUFBTSxJQUFJLEtBQUssSUFBSSxDQUFBO1lBQ3BELFNBQVMsSUFBSSxhQUFhLFFBQVEsQ0FBQyxRQUFRLElBQUksS0FBSyxJQUFJLENBQUE7UUFDNUQsQ0FBQztRQUVELElBQUksT0FBTyxFQUFFLENBQUM7WUFDViwrQ0FBK0M7WUFDL0MsU0FBUyxJQUFJLGFBQWEsT0FBTyxDQUFDLFFBQVEsSUFBSSxLQUFLLElBQUksQ0FBQTtZQUN2RCxTQUFTLElBQUksZUFBZSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFBO1lBQ2hHLFNBQVMsSUFBSSxzQkFDVCxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLElBQUksT0FBTyxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUM3RSxJQUFJLENBQUE7WUFDSixTQUFTLElBQUksc0JBQ1QsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FDN0UsSUFBSSxDQUFBO1lBQ0osU0FBUyxJQUFJLDRCQUE0QixPQUFPLENBQUMsdUJBQXVCLElBQUksS0FBSyxFQUFFLENBQUE7UUFDdkYsQ0FBQztRQUNELFNBQVMsSUFBSSxLQUFLLENBQUE7UUFDbEIsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUM5QixDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtBQUM5QixDQUFDLENBQUE7QUFoQ1ksUUFBQSx1QkFBdUIsMkJBZ0NuQztBQUVNLE1BQU0sbUNBQW1DLEdBQUcsQ0FBQyxRQUFnQyxFQUFFLEVBQUU7SUFDcEYsTUFBTSxLQUFLLEdBQUcsQ0FBQyxFQUFzQixFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsVUFBVSxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFBO0lBQzlFLE1BQU0sNEJBQTRCLEdBQXVCLEVBQUUsQ0FBQTtJQUMzRCxNQUFNLFdBQVcsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUE7SUFDakMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFO1FBQ3hCLElBQUksRUFBRSxDQUFDLFVBQVUsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM5Qiw0QkFBNEIsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRztnQkFDdEMsUUFBUSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQ3ZCLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxLQUFLLFVBQVUsSUFBSSxHQUFHLENBQUMsV0FBVyxLQUFLLEVBQUUsQ0FBQyxXQUFXLENBQ3ZEO2dCQUN6QixPQUFPLEVBQUUsRUFBYTthQUN6QixDQUFBO1FBQ0wsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFBO0lBQ0YsT0FBTyw0QkFBNEIsQ0FBQTtBQUN2QyxDQUFDLENBQUE7QUFmWSxRQUFBLG1DQUFtQyx1Q0FlL0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBdHRyaWJ1dGVWYWx1ZSB9IGZyb20gJ2F3cy1zZGsvY2xpZW50cy9keW5hbW9kYidcbmltcG9ydCB7IEhvbGRpbmcsIFNlY3VyaXR5IH0gZnJvbSAnLi4vQVBJJ1xuaW1wb3J0IHsgbWFwRHluYW1vREJUb0ludmVzdG1lbnRIb2xkaW5nIH0gZnJvbSAnLi9JbnZlc3RtZW50SG9sZGluZ3MnXG5pbXBvcnQgeyBkZWNyeXB0SXRlbXNJbkJhdGNoZXMgfSBmcm9tICcuLi9xdWVyaWVzL0VuY3J5cHRpb24nXG5cbi8vIE1hcHBlciBmdW5jdGlvbiBmb3IgRHluYW1vREIgdG8gU2VjdXJpdHlEZXRhaWxzIGludGVyZmFjZVxuZXhwb3J0IGZ1bmN0aW9uIG1hcER5bmFtb0RCVG9TZWN1cml0eURldGFpbHMoaXRlbTogeyBba2V5OiBzdHJpbmddOiBBdHRyaWJ1dGVWYWx1ZSB9KTogU2VjdXJpdHkge1xuICAgIHJldHVybiB7XG4gICAgICAgIGNsb3NlX3ByaWNlOiBwYXJzZUZsb2F0KGl0ZW0uY2xvc2VfcHJpY2U/Lk4gfHwgJycpLCAvLyBEeW5hbW9EQiBudW1iZXIgdHlwZVxuICAgICAgICBjbG9zZV9wcmljZV9hc19vZjogaXRlbS5jbG9zZV9wcmljZV9hc19vZj8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgY3VzaXA6IGl0ZW0uY3VzaXA/LlMgfHwgJycsXG4gICAgICAgIGluc3RpdHV0aW9uX2lkOiBpdGVtLmluc3RpdHV0aW9uX2lkPy5TIHx8IG51bGwsIC8vIE51bGxhYmxlIHN0cmluZ1xuICAgICAgICBpbnN0aXR1dGlvbl9zZWN1cml0eV9pZDogaXRlbS5pbnN0aXR1dGlvbl9zZWN1cml0eV9pZD8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgaXNfY2FzaF9lcXVpdmFsZW50OiBpdGVtLmlzX2Nhc2hfZXF1aXZhbGVudD8uQk9PTCB8fCBmYWxzZSwgLy8gQm9vbGVhbiB0eXBlXG4gICAgICAgIGlzaW46IGl0ZW0uaXNpbj8uUyB8fCAnJyxcbiAgICAgICAgaXNvX2N1cnJlbmN5X2NvZGU6IGl0ZW0uaXNvX2N1cnJlbmN5X2NvZGU/LlMgfHwgJycsXG4gICAgICAgIG5hbWU6IGl0ZW0ubmFtZT8uUyB8fCAnJyxcbiAgICAgICAgcHJveHlfc2VjdXJpdHlfaWQ6IGl0ZW0ucHJveHlfc2VjdXJpdHlfaWQ/LlMgfHwgbnVsbCwgLy8gTnVsbGFibGUgc3RyaW5nXG4gICAgICAgIHNlY3VyaXR5X2lkOiBpdGVtLnNlY3VyaXR5X2lkPy5TIHx8ICcnLFxuICAgICAgICBzZWRvbDogaXRlbS5zZWRvbD8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgdGlja2VyX3N5bWJvbDogaXRlbS50aWNrZXJfc3ltYm9sPy5TIHx8ICcnLFxuICAgICAgICB0eXBlOiBpdGVtLnR5cGU/LlMgfHwgJycsXG4gICAgICAgIHVub2ZmaWNpYWxfY3VycmVuY3lfY29kZTogaXRlbS51bm9mZmljaWFsX2N1cnJlbmN5X2NvZGU/LlMgfHwgbnVsbCwgLy8gTnVsbGFibGUgc3RyaW5nXG4gICAgICAgIG1hcmtldF9pZGVudGlmaWVyX2NvZGU6IGl0ZW0ubWFya2V0X2lkZW50aWZpZXJfY29kZT8uUyB8fCAnJyxcbiAgICAgICAgb3B0aW9uX2NvbnRyYWN0OiBpdGVtLm9wdGlvbl9jb250cmFjdD8uUyB8fCBudWxsLCAvLyBOdWxsYWJsZSBzdHJpbmdcbiAgICAgICAgcGxhaWRfdHlwZTogaXRlbS5wbGFpZF90eXBlPy5TID8/ICcnLFxuICAgICAgICBfX3R5cGVuYW1lOiAnU2VjdXJpdHknLFxuICAgIH1cbn1cbnR5cGUgSm9pbmVkU2VjdXJpdHlEYXRhID0gUmVjb3JkPHN0cmluZywgeyBzZWN1cml0eTogU2VjdXJpdHkgfCB1bmRlZmluZWQ7IGhvbGRpbmc6IEhvbGRpbmcgfT5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhKFxuICAgIGl0ZW1zOiB7IFtrZXk6IHN0cmluZ106IEF0dHJpYnV0ZVZhbHVlIH1bXVxuKTogUHJvbWlzZTxKb2luZWRTZWN1cml0eURhdGE+IHtcbiAgICBjb25zdCBkZWNyeXB0ZWRJdGVtcyA9IGF3YWl0IGRlY3J5cHRJdGVtc0luQmF0Y2hlcyhpdGVtcylcbiAgICBjb25zdCBtYXBwZWRJdGVtcyA9IGRlY3J5cHRlZEl0ZW1zLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXRlbS5wbGFpZF90eXBlPy5TID09PSAnU2VjdXJpdHknKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFwRHluYW1vREJUb1NlY3VyaXR5RGV0YWlscyhpdGVtKVxuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ucGxhaWRfdHlwZT8uUyA9PT0gJ0hvbGRpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFwRHluYW1vREJUb0ludmVzdG1lbnRIb2xkaW5nKGl0ZW0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHR5cGUnKVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gbWFwSG9sZGluZ3NBbmRTZWN1cml0aWVzVG9Kb2ludERhdGEobWFwcGVkSXRlbXMpXG59XG5cbmV4cG9ydCBjb25zdCBtYXBKb2ludERhdGFUb0NoYXRJbnB1dCA9IChqb2ludERhdGE6IEpvaW5lZFNlY3VyaXR5RGF0YSk6IHN0cmluZyA9PiB7XG4gICAgY29uc3QgY2hhdElucHV0czogc3RyaW5nW10gPSBbXVxuICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgdmFsdWVzIGluIHRoZSBgam9pbnREYXRhYCBvYmplY3RcbiAgICBPYmplY3QudmFsdWVzKGpvaW50RGF0YSkuZm9yRWFjaCgoeyBzZWN1cml0eSwgaG9sZGluZyB9KSA9PiB7XG4gICAgICAgIGxldCBjaGF0SW5wdXQgPSAnKCdcblxuICAgICAgICBpZiAoc2VjdXJpdHkpIHtcbiAgICAgICAgICAgIC8vIFByb2Nlc3Mgc2VjdXJpdHkgZmllbGRzIGludG8gYSBjaGF0IG1lc3NhZ2VcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgU2VjdXJpdHkgTmFtZTogJHtzZWN1cml0eS5uYW1lIHx8ICdOL0EnfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgVGlja2VyIFN5bWJvbDogJHtzZWN1cml0eS50aWNrZXJfc3ltYm9sIHx8ICdOL0EnfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgQ2xvc2UgUHJpY2U6ICR7c2VjdXJpdHkuY2xvc2VfcHJpY2UgPyBgJCR7c2VjdXJpdHkuY2xvc2VfcHJpY2UudG9GaXhlZCgyKX1gIDogJ04vQSd9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBDbG9zZSBQcmljZSBBcyBPZjogJHtzZWN1cml0eS5jbG9zZV9wcmljZV9hc19vZiB8fCAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYFNlY3RvcjogJHtzZWN1cml0eS5zZWN0b3IgfHwgJ04vQSd9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBJbmR1c3RyeTogJHtzZWN1cml0eS5pbmR1c3RyeSB8fCAnTi9BJ31cXG5gXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaG9sZGluZykge1xuICAgICAgICAgICAgLy8gUHJvY2VzcyBob2xkaW5nIGZpZWxkcyBpbnRvIHRoZSBzYW1lIG1lc3NhZ2VcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgUXVhbnRpdHk6ICR7aG9sZGluZy5xdWFudGl0eSB8fCAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYENvc3QgQmFzaXM6ICR7aG9sZGluZy5jb3N0X2Jhc2lzID8gYCQke2hvbGRpbmcuY29zdF9iYXNpcy50b0ZpeGVkKDIpfWAgOiAnTi9BJ31cXG5gXG4gICAgICAgICAgICBjaGF0SW5wdXQgKz0gYEluc3RpdHV0aW9uIFZhbHVlOiAke1xuICAgICAgICAgICAgICAgIGhvbGRpbmcuaW5zdGl0dXRpb25fdmFsdWUgPyBgJCR7aG9sZGluZy5pbnN0aXR1dGlvbl92YWx1ZS50b0ZpeGVkKDIpfWAgOiAnTi9BJ1xuICAgICAgICAgICAgfVxcbmBcbiAgICAgICAgICAgIGNoYXRJbnB1dCArPSBgSW5zdGl0dXRpb24gUHJpY2U6ICR7XG4gICAgICAgICAgICAgICAgaG9sZGluZy5pbnN0aXR1dGlvbl9wcmljZSA/IGAkJHtob2xkaW5nLmluc3RpdHV0aW9uX3ByaWNlLnRvRml4ZWQoMil9YCA6ICdOL0EnXG4gICAgICAgICAgICB9XFxuYFxuICAgICAgICAgICAgY2hhdElucHV0ICs9IGBJbnN0aXR1dGlvbiBQcmljZSBBcyBPZjogJHtob2xkaW5nLmluc3RpdHV0aW9uX3ByaWNlX2FzX29mIHx8ICdOL0EnfWBcbiAgICAgICAgfVxuICAgICAgICBjaGF0SW5wdXQgKz0gJylcXG4nXG4gICAgICAgIGNoYXRJbnB1dHMucHVzaChjaGF0SW5wdXQpXG4gICAgfSlcbiAgICByZXR1cm4gY2hhdElucHV0cy5qb2luKCcnKVxufVxuXG5leHBvcnQgY29uc3QgbWFwSG9sZGluZ3NBbmRTZWN1cml0aWVzVG9Kb2ludERhdGEgPSAoaG9sZGluZ3M6IChIb2xkaW5nIHwgU2VjdXJpdHkpW10pID0+IHtcbiAgICBjb25zdCBnZXRJZCA9IChlbDogSG9sZGluZyB8IFNlY3VyaXR5KSA9PiBlbC5hY2NvdW50X2lkICsgJy0nICsgZWwuc2VjdXJpdHlfaWRcbiAgICBjb25zdCBhY2NvdW50QW5kc2VjdXJpdHlJZFRvRW50aXR5OiBKb2luZWRTZWN1cml0eURhdGEgPSB7fVxuICAgIGNvbnN0IGludmVzdG1lbnRzID0gWy4uLmhvbGRpbmdzXVxuICAgIGludmVzdG1lbnRzPy5mb3JFYWNoKChlbCkgPT4ge1xuICAgICAgICBpZiAoZWwucGxhaWRfdHlwZSA9PT0gJ0hvbGRpbmcnKSB7XG4gICAgICAgICAgICBhY2NvdW50QW5kc2VjdXJpdHlJZFRvRW50aXR5W2dldElkKGVsKV0gPSB7XG4gICAgICAgICAgICAgICAgc2VjdXJpdHk6IGludmVzdG1lbnRzPy5maW5kKFxuICAgICAgICAgICAgICAgICAgICAoc2VjKSA9PiBzZWMucGxhaWRfdHlwZSA9PT0gJ1NlY3VyaXR5JyAmJiBzZWMuc2VjdXJpdHlfaWQgPT09IGVsLnNlY3VyaXR5X2lkXG4gICAgICAgICAgICAgICAgKSBhcyBTZWN1cml0eSB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBob2xkaW5nOiBlbCBhcyBIb2xkaW5nLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gYWNjb3VudEFuZHNlY3VyaXR5SWRUb0VudGl0eVxufVxuIl19