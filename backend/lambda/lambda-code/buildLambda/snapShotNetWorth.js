"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getNetWorth = exports.reduceAccounts = exports.getAccountBalanceMultipler = exports.snapShotNetWorth = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const Entities_1 = require("./queries/Entities");
const Encryption_1 = require("./queries/Encryption");
const Item_1 = require("./mappers/Item");
const Security_1 = require("./mappers/Security");
const Accounts_1 = require("./mappers/Accounts");
const client = new client_dynamodb_1.DynamoDBClient({ region: 'ca-central-1' });
function getEarliestFirstOfMonthWithin90Days(createdAt) {
    return new Date(new Date().getTime() - 1000 * 3600 * 24 * 365);
}
const snapShotNetWorth = async () => {
    // TODO: Add logic to handle last calculated complete month and start from then
    const items = (await (0, Encryption_1.decryptItemsInBatches)((await client.send((0, Entities_1.GetItems)()))?.Items ?? [])).map(Item_1.mapDdbResponseToItem);
    /** TODO: Just add created at to the item? */
    const encryptedUserItemRecord = await Promise.all(items.map(async (el) => await client.send((0, Entities_1.GetUser)(el.sk || ''))));
    const decryptedUserItemRecord = (await (0, Encryption_1.decryptItemsInBatches)(encryptedUserItemRecord.flatMap((output) => output.Items ?? [])))
        .map(Item_1.mapDdbResponseToItem)
        .filter((item) => {
        console.info('Processing', item);
        return item.pk && item.created_at;
    });
    /** Go through users and aggregate transactions */
    await processUsersInBatches(decryptedUserItemRecord);
};
exports.snapShotNetWorth = snapShotNetWorth;
function chunkArray(array, chunkSize) {
    const chunks = [];
    for (let i = 0; i < array.length; i += chunkSize) {
        chunks.push(array.slice(i, i + chunkSize));
    }
    return chunks;
}
async function processUsersInBatches(decryptedUserItemRecord) {
    const recordsWithGroupKey = decryptedUserItemRecord.map((el) => ({
        ...el,
        groupKey: el.pk?.replace(/#ITEM#\w+/, ''),
    }));
    const groupedByGroupKey = recordsWithGroupKey.reduce((acc, item) => {
        const key = item.groupKey || 'undefined';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(item);
        return acc;
    }, {});
    // Step 3: Get an array of groups (each group is an array of items with the same groupKey)
    const groupedArrays = Object.values(groupedByGroupKey);
    // Step 4: Chunk the groups into batches of 100
    const groupBatches = chunkArray(groupedArrays, 100);
    // Step 5: Process each batch of 100 groups
    for (const batch of groupBatches) {
        for (const items of batch) {
            try {
                let encryptedTransactions = [];
                for (let i = 0; i < items.length; i++) {
                    console.info('Sending', items[i]);
                    const res = await client.send((0, Entities_1.GetEntities)({
                        pk: items[i].pk?.replace(/#ITEM#\w+/, '') ?? '',
                        dateRange: {
                            hasNoTimeConstraint: true,
                        },
                        username: '',
                        id: '',
                        entityName: 'SECURITY',
                        getAllSecuritiesForUser: true,
                    }));
                    encryptedTransactions.push(...(res?.Items ?? []));
                }
                const decrypedSecurities = await (0, Security_1.mapSecuritiesToJoinedData)(await (0, Encryption_1.decryptItemsInBatches)(encryptedTransactions ?? []));
                const encryptedAccounts = await Promise.all(items.flatMap(async (item) => await client.send((0, Entities_1.GetEntities)({
                    pk: item.pk ?? '',
                    dateRange: {
                        hasNoTimeConstraint: true,
                    },
                    username: '',
                    id: '',
                    entityName: 'ACCOUNT',
                }))));
                const decrypedAccounts = encryptedAccounts.flatMap((el) => el.Items?.map(Accounts_1.mapDynamoDBToAccount) ?? []);
                const netWorth = (0, exports.reduceAccounts)(decrypedAccounts);
                const securitySnapshot = Object.values(decrypedSecurities);
                const securityNetWorth = (0, exports.getNetWorth)(securitySnapshot);
                const tfsaNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['tfsa'], acc)));
                const rrspNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['rrsp', 'drsp'], acc)));
                const fhsaNetWorth = (0, exports.reduceAccounts)(decrypedAccounts.filter((acc) => checkAccountNameOrTypes(['fhsa'], acc)));
                const accountsToBalances = {};
                decrypedAccounts.forEach((acc) => {
                    accountsToBalances[acc.account_id] = { N: (0, exports.reduceAccounts)([acc]).toFixed(2) };
                });
                const command = new client_dynamodb_1.PutItemCommand({
                    TableName: process.env.TABLE_NAME,
                    Item: {
                        pk: {
                            S: items[0]?.groupKey
                                ? items[0]?.groupKey + '#NETWORTHDAILYSNAPSHOT'
                                : '',
                        },
                        sk: { S: new Date().toISOString() },
                        netWorth: { N: netWorth.toFixed(2) },
                        tfsaNetWorth: { N: tfsaNetWorth.toFixed(2) },
                        rrspNetWorth: { N: rrspNetWorth.toFixed(2) },
                        fhsaNetWorth: { N: fhsaNetWorth.toFixed(2) },
                        securityNetWorth: { N: securityNetWorth.toFixed(2) },
                        securities: { S: JSON.stringify(securitySnapshot) },
                        balances: { S: JSON.stringify(accountsToBalances) },
                    },
                });
                await client.send(command);
            }
            catch (e) {
                console.error(e);
                return undefined;
            }
        }
    }
}
const checkAccountNameOrTypes = (types, acc) => {
    return types
        .map((type) => {
        return acc.name?.toLowerCase()?.includes(type) || acc.type?.toLowerCase().includes(type);
    })
        .includes(true);
};
const getAccountBalanceMultipler = (acc) => (acc.type === 'loan' || acc.type === 'credit' ? -1 : 1);
exports.getAccountBalanceMultipler = getAccountBalanceMultipler;
const reduceAccounts = (accs) => accs.reduce((val, acc) => val + (0, exports.getAccountBalanceMultipler)(acc) * parseFloat(acc.balances?.current || '0'), 0);
exports.reduceAccounts = reduceAccounts;
const getNetWorth = (holdings) => {
    return holdings.reduce((val, holding) => {
        return val + (holding.holding.quantity ?? 0) * (holding.security?.close_price ?? 0);
    }, 0);
};
exports.getNetWorth = getNetWorth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hcFNob3ROZXRXb3J0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zbmFwU2hvdE5ldFdvcnRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhEQUF5RTtBQUN6RSxpREFBbUU7QUFDbkUscURBQTREO0FBQzVELHlDQUFxRDtBQUVyRCxpREFBOEQ7QUFDOUQsaURBQXlEO0FBRXpELE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFBO0FBRTdELFNBQVMsbUNBQW1DLENBQUMsU0FBZTtJQUN4RCxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUE7QUFDbEUsQ0FBQztBQUVNLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDdkMsK0VBQStFO0lBQy9FLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxJQUFBLGtDQUFxQixFQUFDLENBQUMsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsbUJBQVEsR0FBRSxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsMkJBQW9CLENBQUMsQ0FBQTtJQUNuSCw2Q0FBNkM7SUFDN0MsTUFBTSx1QkFBdUIsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBQSxrQkFBTyxFQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbkgsTUFBTSx1QkFBdUIsR0FBRyxDQUM1QixNQUFNLElBQUEsa0NBQXFCLEVBQUMsdUJBQXVCLENBQUMs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LENBQUE7QUFKWSxRQUFBLFdBQVcsZUFJdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInXG5pbXBvcnQgeyBHZXRFbnRpdGllcywgR2V0SXRlbXMsIEdldFVzZXIgfSBmcm9tICcuL3F1ZXJpZXMvRW50aXRpZXMnXG5pbXBvcnQgeyBkZWNyeXB0SXRlbXNJbkJhdGNoZXMgfSBmcm9tICcuL3F1ZXJpZXMvRW5jcnlwdGlvbidcbmltcG9ydCB7IG1hcERkYlJlc3BvbnNlVG9JdGVtIH0gZnJvbSAnLi9tYXBwZXJzL0l0ZW0nXG5pbXBvcnQgeyBBY2NvdW50LCBIb2xkaW5nLCBJdGVtLCBTZWN1cml0eSB9IGZyb20gJy4vQVBJJ1xuaW1wb3J0IHsgbWFwU2VjdXJpdGllc1RvSm9pbmVkRGF0YSB9IGZyb20gJy4vbWFwcGVycy9TZWN1cml0eSdcbmltcG9ydCB7IG1hcER5bmFtb0RCVG9BY2NvdW50IH0gZnJvbSAnLi9tYXBwZXJzL0FjY291bnRzJ1xuXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdjYS1jZW50cmFsLTEnIH0pXG5cbmZ1bmN0aW9uIGdldEVhcmxpZXN0Rmlyc3RPZk1vbnRoV2l0aGluOTBEYXlzKGNyZWF0ZWRBdDogRGF0ZSkge1xuICAgIHJldHVybiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIDEwMDAgKiAzNjAwICogMjQgKiAzNjUpXG59XG5cbmV4cG9ydCBjb25zdCBzbmFwU2hvdE5ldFdvcnRoID0gYXN5bmMgKCkgPT4ge1xuICAgIC8vIFRPRE86IEFkZCBsb2dpYyB0byBoYW5kbGUgbGFzdCBjYWxjdWxhdGVkIGNvbXBsZXRlIG1vbnRoIGFuZCBzdGFydCBmcm9tIHRoZW5cbiAgICBjb25zdCBpdGVtcyA9IChhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoKGF3YWl0IGNsaWVudC5zZW5kKEdldEl0ZW1zKCkpKT8uSXRlbXMgPz8gW10pKS5tYXAobWFwRGRiUmVzcG9uc2VUb0l0ZW0pXG4gICAgLyoqIFRPRE86IEp1c3QgYWRkIGNyZWF0ZWQgYXQgdG8gdGhlIGl0ZW0/ICovXG4gICAgY29uc3QgZW5jcnlwdGVkVXNlckl0ZW1SZWNvcmQgPSBhd2FpdCBQcm9taXNlLmFsbChpdGVtcy5tYXAoYXN5bmMgKGVsKSA9PiBhd2FpdCBjbGllbnQuc2VuZChHZXRVc2VyKGVsLnNrIHx8ICcnKSkpKVxuICAgIGNvbnN0IGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkID0gKFxuICAgICAgICBhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoZW5jcnlwdGVkVXNlckl0ZW1SZWNvcmQuZmxhdE1hcCgob3V0cHV0KSA9PiBvdXRwdXQuSXRlbXMgPz8gW10pKVxuICAgIClcbiAgICAgICAgLm1hcChtYXBEZGJSZXNwb25zZVRvSXRlbSlcbiAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKCdQcm9jZXNzaW5nJywgaXRlbSlcbiAgICAgICAgICAgIHJldHVybiBpdGVtLnBrICYmIGl0ZW0uY3JlYXRlZF9hdFxuICAgICAgICB9KVxuICAgIC8qKiBHbyB0aHJvdWdoIHVzZXJzIGFuZCBhZ2dyZWdhdGUgdHJhbnNhY3Rpb25zICovXG4gICAgYXdhaXQgcHJvY2Vzc1VzZXJzSW5CYXRjaGVzKGRlY3J5cHRlZFVzZXJJdGVtUmVjb3JkKVxufVxuXG5mdW5jdGlvbiBjaHVua0FycmF5PFQ+KGFycmF5OiBUW10sIGNodW5rU2l6ZTogbnVtYmVyKTogVFtdW10ge1xuICAgIGNvbnN0IGNodW5rczogVFtdW10gPSBbXVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpICs9IGNodW5rU2l6ZSkge1xuICAgICAgICBjaHVua3MucHVzaChhcnJheS5zbGljZShpLCBpICsgY2h1bmtTaXplKSlcbiAgICB9XG4gICAgcmV0dXJuIGNodW5rc1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzVXNlcnNJbkJhdGNoZXMoZGVjcnlwdGVkVXNlckl0ZW1SZWNvcmQ6IEl0ZW1bXSkge1xuICAgIGNvbnN0IHJlY29yZHNXaXRoR3JvdXBLZXkgPSBkZWNyeXB0ZWRVc2VySXRlbVJlY29yZC5tYXAoKGVsKSA9PiAoe1xuICAgICAgICAuLi5lbCxcbiAgICAgICAgZ3JvdXBLZXk6IGVsLnBrPy5yZXBsYWNlKC8jSVRFTSNcXHcrLywgJycpLFxuICAgIH0pKVxuICAgIGNvbnN0IGdyb3VwZWRCeUdyb3VwS2V5ID0gcmVjb3Jkc1dpdGhHcm91cEtleS5yZWR1Y2U8UmVjb3JkPHN0cmluZywgSXRlbVtdPj4oKGFjYywgaXRlbSkgPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSBpdGVtLmdyb3VwS2V5IHx8ICd1bmRlZmluZWQnXG4gICAgICAgIGlmICghYWNjW2tleV0pIHtcbiAgICAgICAgICAgIGFjY1trZXldID0gW11cbiAgICAgICAgfVxuICAgICAgICBhY2Nba2V5XS5wdXNoKGl0ZW0pXG4gICAgICAgIHJldHVybiBhY2NcbiAgICB9LCB7fSlcblxuICAgIC8vIFN0ZXAgMzogR2V0IGFuIGFycmF5IG9mIGdyb3VwcyAoZWFjaCBncm91cCBpcyBhbiBhcnJheSBvZiBpdGVtcyB3aXRoIHRoZSBzYW1lIGdyb3VwS2V5KVxuICAgIGNvbnN0IGdyb3VwZWRBcnJheXMgPSBPYmplY3QudmFsdWVzKGdyb3VwZWRCeUdyb3VwS2V5KVxuXG4gICAgLy8gU3RlcCA0OiBDaHVuayB0aGUgZ3JvdXBzIGludG8gYmF0Y2hlcyBvZiAxMDBcbiAgICBjb25zdCBncm91cEJhdGNoZXMgPSBjaHVua0FycmF5KGdyb3VwZWRBcnJheXMsIDEwMClcblxuICAgIC8vIFN0ZXAgNTogUHJvY2VzcyBlYWNoIGJhdGNoIG9mIDEwMCBncm91cHNcbiAgICBmb3IgKGNvbnN0IGJhdGNoIG9mIGdyb3VwQmF0Y2hlcykge1xuICAgICAgICBmb3IgKGNvbnN0IGl0ZW1zIG9mIGJhdGNoKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGxldCBlbmNyeXB0ZWRUcmFuc2FjdGlvbnMgPSBbXVxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCdTZW5kaW5nJywgaXRlbXNbaV0pXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgR2V0RW50aXRpZXMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBrOiBpdGVtc1tpXS5waz8ucmVwbGFjZSgvI0lURU0jXFx3Ky8sICcnKSA/PyAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlUmFuZ2U6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzTm9UaW1lQ29uc3RyYWludDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGFzIGFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU5hbWU6ICdTRUNVUklUWScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QWxsU2VjdXJpdGllc0ZvclVzZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIGVuY3J5cHRlZFRyYW5zYWN0aW9ucy5wdXNoKC4uLihyZXM/Lkl0ZW1zID8/IFtdKSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZWNyeXBlZFNlY3VyaXRpZXMgPSBhd2FpdCBtYXBTZWN1cml0aWVzVG9Kb2luZWREYXRhKFxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkZWNyeXB0SXRlbXNJbkJhdGNoZXMoZW5jcnlwdGVkVHJhbnNhY3Rpb25zID8/IFtdKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWRBY2NvdW50cyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgICAgICAgICAgICBpdGVtcy5mbGF0TWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmMgKGl0ZW0pID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdldEVudGl0aWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBrOiBpdGVtLnBrID8/ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVJhbmdlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzTm9UaW1lQ29uc3RyYWludDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gYXMgYW55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5TmFtZTogJ0FDQ09VTlQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRlY3J5cGVkQWNjb3VudHMgPSBlbmNyeXB0ZWRBY2NvdW50cy5mbGF0TWFwKChlbCkgPT4gZWwuSXRlbXM/Lm1hcChtYXBEeW5hbW9EQlRvQWNjb3VudCkgPz8gW10pXG4gICAgICAgICAgICAgICAgY29uc3QgbmV0V29ydGggPSByZWR1Y2VBY2NvdW50cyhkZWNyeXBlZEFjY291bnRzKVxuICAgICAgICAgICAgICAgIGNvbnN0IHNlY3VyaXR5U25hcHNob3QgPSBPYmplY3QudmFsdWVzKGRlY3J5cGVkU2VjdXJpdGllcylcbiAgICAgICAgICAgICAgICBjb25zdCBzZWN1cml0eU5ldFdvcnRoID0gZ2V0TmV0V29ydGgoc2VjdXJpdHlTbmFwc2hvdClcbiAgICAgICAgICAgICAgICBjb25zdCB0ZnNhTmV0V29ydGggPSByZWR1Y2VBY2NvdW50cyhcbiAgICAgICAgICAgICAgICAgICAgZGVjcnlwZWRBY2NvdW50cy5maWx0ZXIoKGFjYykgPT4gY2hlY2tBY2NvdW50TmFtZU9yVHlwZXMoWyd0ZnNhJ10sIGFjYykpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnN0IHJyc3BOZXRXb3J0aCA9IHJlZHVjZUFjY291bnRzKFxuICAgICAgICAgICAgICAgICAgICBkZWNyeXBlZEFjY291bnRzLmZpbHRlcigoYWNjKSA9PiBjaGVja0FjY291bnROYW1lT3JUeXBlcyhbJ3Jyc3AnLCAnZHJzcCddLCBhY2MpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBjb25zdCBmaHNhTmV0V29ydGggPSByZWR1Y2VBY2NvdW50cyhcbiAgICAgICAgICAgICAgICAgICAgZGVjcnlwZWRBY2NvdW50cy5maWx0ZXIoKGFjYykgPT4gY2hlY2tBY2NvdW50TmFtZU9yVHlwZXMoWydmaHNhJ10sIGFjYykpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnRzVG9CYWxhbmNlczogUmVjb3JkPHN0cmluZywgeyBOOiBzdHJpbmcgfT4gPSB7fVxuICAgICAgICAgICAgICAgIGRlY3J5cGVkQWNjb3VudHMuZm9yRWFjaCgoYWNjKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFjY291bnRzVG9CYWxhbmNlc1thY2MuYWNjb3VudF9pZF0gPSB7IE46IHJlZHVjZUFjY291bnRzKFthY2NdKS50b0ZpeGVkKDIpIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICAgICAgICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUUsXG4gICAgICAgICAgICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBrOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgUzogKGl0ZW1zWzBdIGFzIGFueSk/Lmdyb3VwS2V5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKGl0ZW1zWzBdIGFzIGFueSk/Lmdyb3VwS2V5ICsgJyNORVRXT1JUSERBSUxZU05BUFNIT1QnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2s6IHsgUzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXRXb3J0aDogeyBOOiBuZXRXb3J0aC50b0ZpeGVkKDIpIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZnNhTmV0V29ydGg6IHsgTjogdGZzYU5ldFdvcnRoLnRvRml4ZWQoMikgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJyc3BOZXRXb3J0aDogeyBOOiBycnNwTmV0V29ydGgudG9GaXhlZCgyKSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZmhzYU5ldFdvcnRoOiB7IE46IGZoc2FOZXRXb3J0aC50b0ZpeGVkKDIpIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eU5ldFdvcnRoOiB7IE46IHNlY3VyaXR5TmV0V29ydGgudG9GaXhlZCgyKSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJpdGllczogeyBTOiBKU09OLnN0cmluZ2lmeShzZWN1cml0eVNuYXBzaG90KSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZXM6IHsgUzogSlNPTi5zdHJpbmdpZnkoYWNjb3VudHNUb0JhbGFuY2VzKSB9LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZClcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5jb25zdCBjaGVja0FjY291bnROYW1lT3JUeXBlcyA9ICh0eXBlczogc3RyaW5nW10sIGFjYzogQWNjb3VudCkgPT4ge1xuICAgIHJldHVybiB0eXBlc1xuICAgICAgICAubWFwKCh0eXBlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYWNjLm5hbWU/LnRvTG93ZXJDYXNlKCk/LmluY2x1ZGVzKHR5cGUpIHx8IGFjYy50eXBlPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHR5cGUpXG4gICAgICAgIH0pXG4gICAgICAgIC5pbmNsdWRlcyh0cnVlKVxufVxuXG5leHBvcnQgY29uc3QgZ2V0QWNjb3VudEJhbGFuY2VNdWx0aXBsZXIgPSAoYWNjOiBBY2NvdW50KSA9PiAoYWNjLnR5cGUgPT09ICdsb2FuJyB8fCBhY2MudHlwZSA9PT0gJ2NyZWRpdCcgPyAtMSA6IDEpXG5cbmV4cG9ydCBjb25zdCByZWR1Y2VBY2NvdW50cyA9IChhY2NzOiBBY2NvdW50W10pID0+XG4gICAgYWNjcy5yZWR1Y2UoXG4gICAgICAgICh2YWw6IG51bWJlciwgYWNjKSA9PiB2YWwgKyBnZXRBY2NvdW50QmFsYW5jZU11bHRpcGxlcihhY2MpICogcGFyc2VGbG9hdChhY2MuYmFsYW5jZXM/LmN1cnJlbnQgfHwgJzAnKSxcbiAgICAgICAgMFxuICAgIClcblxuZXhwb3J0IGNvbnN0IGdldE5ldFdvcnRoID0gKGhvbGRpbmdzOiB7IHNlY3VyaXR5OiBTZWN1cml0eSB8IHVuZGVmaW5lZDsgaG9sZGluZzogSG9sZGluZyB9W10pID0+IHtcbiAgICByZXR1cm4gaG9sZGluZ3MucmVkdWNlKCh2YWwsIGhvbGRpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIHZhbCArIChob2xkaW5nLmhvbGRpbmcucXVhbnRpdHkgPz8gMCkgKiAoaG9sZGluZy5zZWN1cml0eT8uY2xvc2VfcHJpY2UgPz8gMClcbiAgICB9LCAwKVxufVxuIl19